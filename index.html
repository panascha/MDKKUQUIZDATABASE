<!DOCTYPE html>
<html lang="th">

<head>
    <!-- ==================================================================== -->
    <!-- 1. Basic Meta Tags & Title -->
    <!-- ==================================================================== -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MDKKU Manager Center</title>

    <!-- ==================================================================== -->
    <!-- 2. External Resources: Fonts -->
    <!-- ==================================================================== -->
    <!-- Google Fonts: Sarabun -->
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">

    <!-- ==================================================================== -->
    <!-- 3. External Resources: CSS Libraries (Bootstrap, Font Awesome, DataTables) -->
    <!-- ==================================================================== -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css">

    <!-- ==================================================================== -->
    <!-- 4. Custom Styles -->
    <!-- ==================================================================== -->
    <style>
        /* -------------------------------------------------------------------- */
        /* 4.1 Root Variables & Base Styles */
        /* -------------------------------------------------------------------- */
        :root {
            --primary-color: #4e73df;
            --secondary-color: #858796;
            --success-color: #1cc88a;
            --info-color: #36b9cc;
            --warning-color: #f6c23e;
            --danger-color: #e74a3b;
            --light-bg: #f8f9fc;
            --dark-text: #5a5c69;
            --sidebar-width: 250px;
            --sidebar-hidden-margin: calc(-1 * var(--sidebar-width));
            --color-primary: #4e73df;
            /* สำหรับ Vote Modal */
            --color-dark: #5a5c69;
            /* สำหรับ Vote Modal */
                --sidebar-bg: linear-gradient(180deg, #1a2a6c 0%, #2a4858 100%);
    --sidebar-width: 270px;
    --transition-speed: 0.3s;
    --item-radius: 12px;
        }

        body {
            font-family: 'Sarabun', sans-serif;
            background-color: var(--light-bg);
            color: var(--dark-text);
            overflow-x: hidden;
            width: 100%;
        }

         .hidden {
        display: none !important;
    }

        .admin-only {
            display: none;
        }

        /* -------------------------------------------------------------------- */
        /* 4.2 Sidebar Styles */
        /* -------------------------------------------------------------------- */
        #sidebar-wrapper {
    min-height: 100vh;
    width: var(--sidebar-width);
    position: fixed;
    z-index: 1050;
    margin-left: calc(-1 * var(--sidebar-width));
    transition: all var(--transition-speed) cubic-bezier(0.4, 0, 0.2, 1);
    background: var(--sidebar-bg);
    box-shadow: 4px 0 15px rgba(0, 0, 0, 0.1);
    display: flex;
    flex-direction: column;
}

        /* Mobile: Sidebar เปิดเมื่อมี class 'toggled' (เดิมถูกซ่อน) */
        #wrapper.toggled #sidebar-wrapper {
            margin-left: 0;
        }

        /* Overlay/Backdrop เมื่อ Sidebar เปิดบนมือถือ */
        @media (max-width: 767.98px) {
            #wrapper.toggled:before {
                content: '';
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.5);
                z-index: 1040;
                pointer-events: auto;
            }
        }

#sidebar-wrapper .sidebar-heading {
    padding: 0.8rem 0.5rem;
    font-size: 1.4rem;
    font-weight: 800;
    color: #fff;
    letter-spacing: 1px;
    text-transform: uppercase;
    display: flex;
    align-items: center;
    justify-content: center;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}
        /* Style สำหรับปุ่มปิด Sidebar บนมือถือ */
        #sidebar-close-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 1.5rem;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        #sidebar-close-btn:hover {
            opacity: 1;
        }

        @media (min-width: 768px) {

            /* ซ่อนปุ่มปิดบนหน้าจอ Desktop */
            #sidebar-close-btn {
                display: none !important;
            }
        }

        #sidebar-wrapper .list-group {
            width: var(--sidebar-width);
        }

        #sidebar-wrapper .list-group-item {
            background-color: transparent;
            color: rgba(255, 255, 255, 0.8);
            border: none;
            padding: 1rem 1.5rem;
            font-weight: 500;
            transition: all 0.2s;
            border-radius: var(--item-radius);
            display: flex;
            align-items: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;

        }

        #sidebar-wrapper .list-group-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
            padding-left: 2rem;
        }

        #sidebar-wrapper .list-group-item.active {
            color: white;
            font-weight: bold;
            background-color: rgba(255, 255, 255, 0.2);
            border-left: 4px solid white;
        }

        #sidebar-wrapper .list-group-item i {
            margin-right: 10px;
            width: 20px;
            text-align: center;
        }

        /* -------------------------------------------------------------------- */
        /* 4.3 Page Content & Topbar Styles */
        /* -------------------------------------------------------------------- */
        #page-content-wrapper {
            min-width: 100vw;
            transition: margin .25s ease-out;
            padding-left: 0;
            margin-left: 0;
        }

        /* เมื่อถูก toggle บน Mobile (Sidebar เปิด) เนื้อหาไม่ต้องขยับ */
        #wrapper.toggled #page-content-wrapper {
            min-width: 100vw;
            margin-left: 0;
        }

        @media (min-width: 768px) {

            /* Desktop/Tablet: สถานะเริ่มต้นคือแสดง Sidebar */
            #sidebar-wrapper {
                margin-left: 0;
            }

            #page-content-wrapper {
                min-width: 0;
                width: 100%;
                margin-left: var(--sidebar-width);
            }

            /* Desktop/Tablet: สถานะ Toggled คือซ่อน Sidebar */
            #wrapper.toggled #sidebar-wrapper {
                margin-left: var(--sidebar-hidden-margin) !important;
            }

            #wrapper.toggled #page-content-wrapper {
                margin-left: 0 !important;
            }
        }

        /* --- Topbar --- */
        .topbar {
            height: 4.375rem;
            box-shadow: 0 .15rem 1.75rem 0 rgba(58, 59, 69, .15);
            background-color: white;
            display: flex;
            align-items: center;
            padding: 0 1rem;
            justify-content: space-between;
        }

        /* ปรับแต่งหัวข้อใน Topbar สำหรับมือถือ */
        #page-title {
            font-size: 1.1rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 180px;
        }

        /* เพิ่มในส่วน 4.3 Page Content & Topbar Styles */
        #topbar-avatar {
        object-fit: cover;
        cursor: pointer;
        border: 2px solid #eee;
        transition: transform 0.2s;
    }
    #topbar-avatar:hover {
        transform: scale(1.1);
        border-color: var(--primary-color);
    }
        .topbar-profile-actions {
    margin-right: 15px;
    font-size: 0.9rem;
    cursor: pointer;
    color: var(--dark-text);
}
.topbar-profile-actions:hover {
    color: var(--primary-color);
}

/* เพิ่มในส่วน 4.8 Data Tables & Responsive Table Styles */
/* DEV Role Check Styling */
.developer-only {
    display: none; 
}

/* --- Diff Viewer Styles --- */
.modal-dialog.modal-xl {
    max-width: 95% !important; /* ขยายให้กว้าง */
}

/* Header ของแต่ละฝั่ง */
.diff-col-header {
    padding: 10px;
    text-align: center;
    font-weight: 800;
    color: #fff;
    text-transform: uppercase;
    letter-spacing: 1px;
    border-radius: 5px 5px 0 0;
    margin-bottom: 15px;
}
.header-old { background-color: #e74a3b; } /* สีแดง */
.header-new { background-color: #1cc88a; } /* สีเขียว */

/* กรอบเนื้อหา */
.diff-content-box {
    border: 1px solid #e3e6f0;
    padding: 15px;
    border-radius: 0 0 5px 5px;
    height: 100%;
    background-color: #fff;
}

/* Highlight ส่วนที่เปลี่ยนแปลง (สีเหลือง) */
.diff-changed {
    background-color: #fff3cd !important;
    border: 1px solid #ffc107 !important;
    position: relative;
}
.diff-changed::after {
    content: "CHANGED";
    position: absolute;
    top: -8px;
    right: 5px;
    font-size: 0.6rem;
    background: #ffc107;
    color: #000;
    padding: 1px 4px;
    border-radius: 3px;
    font-weight: bold;
    z-index: 1;
}

/* Style ของ Choice ใน Diff */
.diff-choice-item {
    padding: 8px 12px;
    border: 1px solid #eaecf4;
    margin-bottom: 5px;
    border-radius: 5px;
    background: #fff;
}

/* เฉลยที่ถูกต้อง (สีเขียว) */
.diff-correct {
    background-color: #d1e7dd !important;
    border-color: #0f5132 !important;
    color: #0f5132;
    font-weight: bold;
}

/* New Form/Modal enhancements */
.form-label.small {
    font-size: 0.85rem;
    margin-bottom: 0.2rem;
}
.form-control:focus:invalid {
    border-color: #e74a3b;
    box-shadow: 0 0 0 0.25rem rgba(231, 74, 59, 0.25);
}

        @media (min-width: 576px) {
            #page-title {
                font-size: 1.5rem;
                max-width: none;
            }

            .topbar {
                padding: 0 1.5rem;
            }
        }


        /* -------------------------------------------------------------------- */
        /* 4.4 Modal Styles (General) */
        /* -------------------------------------------------------------------- */
        .modal-card {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            padding: 10px;
        }

        .modal-card .modal-body {
            background-color: #fefefe;
            padding: 1.2rem;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            width: 100%;
            max-width: 600px;
            animation: fadeIn 0.3s;
            max-height: 95vh;
            overflow-y: auto;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Adjust Modals for small screens */
        @media (max-width: 576px) {
            .modal-dialog {
                margin: 0.5rem;
            }

            .modal-content {
                border-radius: 10px;
            }

            .modal-header,
            .modal-footer {
                padding: 0.75rem;
            }

            .modal-body {
                padding: 1rem;
            }
        }


        /* -------------------------------------------------------------------- */
        /* 4.5 Report Modal Specific Styles */
        /* -------------------------------------------------------------------- */
        #report-card {
            display: none;
            position: fixed;
            z-index: 3000;
            /* ให้สูงกว่า Modal ปกติ */
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.6);
            justify-content: center;
            align-items: center;
        }

        #report-card .modal-body {
            background-color: #fff;
            padding: 1.5rem;
            border-radius: 15px;
            width: 95%;
            max-width: 700px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-section {
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        }

        #report-question-details {
            background-color: #fff3f3;
            border: 2px solid #dc3545;
        }

        #report-question-text {
            font-size: 1rem;
            font-weight: 600;
            color: #333;
            line-height: 1.5;
        }

        .report-img-preview {
            max-width: 100%;
            max-height: 200px;
            display: block;
            margin: 10px auto;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .report-choice-img {
            max-height: 80px;
            display: block;
            margin-top: 5px;
        }

        #report-choices-list {
            font-size: 0.95rem;
        }

        #report_text {
            width: 100%;
            min-height: 80px;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ced4da;
        }

        #report-correct-choice-select {
            font-size: 1rem;
            font-weight: 600;
        }

        /* -------------------------------------------------------------------- */
        /* 4.6 Vote Modal Specific Styles */
        /* -------------------------------------------------------------------- */
        /* 1. ปรับขนาด Text และ Layout หลัก */
        #vote-category-modal .modal-body {
            padding: 1.5rem !important;
        }

        #vote-category-modal .modal-title {
            font-size: 1.5rem !important;
            font-weight: 800;
            letter-spacing: -0.5px;
        }

        #vote-category-modal p.small-text {
            font-size: 1rem;
            color: #6c757d;
            margin-bottom: 1rem;
        }

        /* 2. กล่อง Preview โจทย์ */
        #vote-question-preview {
            font-size: 1rem !important;
            line-height: 1.5;
            color: #2c3e50;
            background: #f8f9fa;
            border: none !important;
            border-left: 6px solid var(--primary-color) !important;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            padding: 15px !important;
            transition: transform 0.3s ease;
        }

        @media (min-width: 768px) {
            #vote-category-modal .modal-body {
                padding: 2rem !important;
            }

            #vote-category-modal .modal-title {
                font-size: 2rem !important;
            }

            #vote-category-modal p.small-text {
                font-size: 1.2rem;
            }

            #vote-question-preview {
                font-size: 1.25rem !important;
                padding: 20px !important;
            }
        }

        #vote-question-preview:hover {
            transform: scale(1.01);
        }

        /* 3. Container ของ Badge */
        .category-badge-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            /* Increased gap for better spacing */
            min-height: 50px;
            /* Increased height for better visibility */
            align-items: center;
        }

        /* 4. ตัว Badge (Category) - หัวใจหลัก */
        .category-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 10px 20px;
            /* Increased padding for a more comfortable touch area */
            border-radius: 25px;
            /* Slightly adjusted border radius for a softer look */
            font-size: 1rem;
            /* Increased font size for better readability */
            font-weight: 600;
            letter-spacing: 0.5px;
            /* Increased letter spacing for clarity */
            transition: all 0.3s ease;
            /* Smoother transition effect */
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
            /* Softer shadow for a subtle effect */
            background-color: #f8f9fa;
            /* Light background for better contrast */
            color: #333;
            /* Darker text color for improved readability */
        }

        @media (min-width: 768px) {
            .category-badge {
                font-size: 1.15rem;
                padding: 10px 20px;
            }

            .category-badge-container {
                gap: 12px;
            }
        }

        /* 4.1 สไตล์ Approved (สีเขียว) */
        .category-badge.approved {
            background: linear-gradient(135deg, #d4fc79 0%, #96e6a1 100%);
            color: #155724;
            border: none;
            box-shadow: 0 4px 6px rgba(150, 230, 161, 0.4);
        }

        .category-badge.approved i {
            background: rgba(255, 255, 255, 0.5);
            border-radius: 50%;
            padding: 4px;
            font-size: 0.8rem;
            margin-left: 8px;
        }

        /* 4.2 สไตล์ Suggested (สีส้ม/เหลือง) - แบบ Interactive */
        .category-badge.suggested {
            background-color: #fff;
            color: #d35400;
            border: 2px solid #ffcc80;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        /* Effect ตอนเอาเมาส์ชี้ (Hover) */
        .category-badge.suggested:hover {
            background-color: #ffe0b2;
            border-color: #ffb74d;
            color: #e65100;
            transform: translateY(-4px) scale(1.05);
            box-shadow: 0 8px 15px rgba(255, 167, 38, 0.3);
        }

        /* Effect ตอนกด (Active) */
        .category-badge.suggested:active {
            transform: translateY(-1px) scale(0.98);
            box-shadow: 0 2px 5px rgba(255, 167, 38, 0.3);
        }

        /* Badge บอกจำนวนคนโหวต */
        .vote-count-badge {
            background-color: #e65100;
            color: white;
            border-radius: 20px;
            padding: 2px 8px;
            font-size: 0.8rem;
            margin-left: 8px;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.2);
        }

        /* 5. ส่วนเพิ่มหัวข้อใหม่ (Dropdowns) */
        .vote-row {
            display: grid;
            grid-template-columns: 35px 1fr;
            /* ปรับ Grid สำหรับมือถือ */
            grid-gap: 10px;
            align-items: center;
            background: #fff;
            border: 1px dashed #ced4da;
            padding: 12px;
            border-radius: 12px;
            margin-bottom: 12px;
            transition: border-color 0.3s;
        }

        /* บน Desktop ให้แสดงแถวเดียว */
        @media (min-width: 576px) {
            .vote-row {
                grid-template-columns: 35px 1fr 1fr 1fr;
                padding: 15px;
            }
        }

        .vote-row:hover {
            border-color: var(--primary-color);
            background: #f8faff;
        }

        .vote-select {
            height: 45px;
            font-size: 1rem;
            border-radius: 8px;
            border: 1px solid #dfe1e5;
            background-color: #fff;
            padding: 0 10px;
            cursor: pointer;
            width: 100%;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        @media (max-width: 575.98px) {
            .vote-select {
                grid-column: span 2;
            }

            .btn-remove-row {
                grid-column: 1;
                grid-row: 1;
            }
        }

        .vote-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 4px rgba(78, 115, 223, 0.1);
            outline: none;
        }

        .btn-remove-row {
            background-color: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-remove-row:hover {
            background-color: #c82333;
            transform: translateY(-2px);
        }

        /* 6. ปุ่มเพิ่มแถว (Add Row Button) */
        #btn-add-vote-row {
            padding: 8px 15px;
            font-size: 1rem;
            border-radius: 50px;
            background-color: #e9f5ff;
            color: var(--primary-color);
            border: 2px solid var(--primary-color);
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            margin: 0 auto;
        }

        @media (min-width: 768px) {
            #btn-add-vote-row {
                padding: 10px 20px;
                font-size: 1.2rem;
            }
        }

        #btn-add-vote-row:hover {
            background-color: rgba(78, 115, 223, 0.05);
            border-style: solid;
            transform: translateY(-2px);
        }

        /* 7. ปุ่ม Submit / Close */
        .controls-container {
            display: flex;
            justify-content: center;
            gap: 10px;
        }

        @media (min-width: 576px) {
            .controls-container {
                justify-content: flex-end;
            }
        }

        .quiz-button {
            padding: 10px 20px;
            font-size: 1.1rem;
            border-radius: 50px;
            letter-spacing: 0.5px;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            flex: 1;
            max-width: 200px;
        }

        @media (min-width: 768px) {
            .quiz-button {
                padding: 12px 30px;
                font-size: 1.3rem;
            }
        }

        .btn-light {
            background-color: #f8f9fa;
            color: #6c757d;
        }

        .btn-dark {
            background: linear-gradient(45deg, #4e73df, #224abe);
            color: white;
            box-shadow: 0 4px 10px rgba(78, 115, 223, 0.4);
        }

        .btn-dark:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(78, 115, 223, 0.6);
        }

        /* 8. ข้อความ Empty State */
        .empty-state-text {
            font-size: 1rem;
            color: #adb5bd;
            font-weight: 400;
            padding: 10px 0;
        }

        /* -------------------------------------------------------------------- */
        /* 4.7 Component Styles (Cards, Gallery, Diff, Badges, Choices) */
        /* -------------------------------------------------------------------- */

        /* Card */
        .card-dashboard {
            border: none;
            border-radius: 0.75rem;
            box-shadow: 0 .15rem 1.75rem 0 rgba(58, 59, 69, .15);
            margin-bottom: 1.5rem;
            transition: transform 0.2s;
        }

        .card-dashboard:hover {
            transform: translateY(-3px);
        }

        .card-header-custom {
            background-color: white;
            border-bottom: 1px solid #e3e6f0;
            padding: 1rem 1.25rem;
            display: flex;
            flex-direction: row;
            justify-content: space-between;
            align-items: center;
            border-top-left-radius: 0.75rem !important;
            border-top-right-radius: 0.75rem !important;
            font-weight: 700;
            color: var(--primary-color);
        }

        @media (max-width: 575.98px) {
            .card-header-custom {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }
        }

        /* Diff Container */
        .diff-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
            background: #fff;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #eee;
        }

        @media (min-width: 768px) {
            .diff-container {
                flex-direction: row;
            }
        }

        .diff-box {
            flex: 1;
            padding: 10px;
            border-radius: 5px;
        }

        .diff-original {
            background-color: #f8f9fa;
            border: 1px solid #ddd;
        }

        .diff-suggest {
            background-color: #e8f5e9;
            border: 1px solid #c8e6c9;
        }

        .diff-label {
            font-size: 0.85rem;
            font-weight: bold;
            margin-bottom: 5px;
            color: #666;
        }

        /* Badges */
        .badge-pill {
            border-radius: 50rem;
            padding: 0.35em 0.6em;
        }

        /* Choices */
        .choice-item {
            transition: all 0.2s;
            border: 1px solid transparent;
            border-radius: 6px;
            padding: 4px;
        }

        .choice-item:hover {
            background-color: #f8faff;
            border-color: #e3e6f0;
        }

        /* สไตล์สำหรับคำตอบที่ถูกเสนอ (สีเขียว) */
        .choice-item.suggested-choice {
            border: 2px solid #1cc88a;
            /* สีเขียว */
            background-color: #eafff5;
        }

        /* สไตล์สำหรับคำตอบเดิมใน Database (ถ้าไม่ตรงกับที่เสนอ) */
        .choice-item.original-choice {
            border: 2px solid #858796;
            /* สีเทา */
            background-color: #f8f9fa;
        }

        /* สไตล์เมื่อคำตอบเดิม กับ คำตอบที่เสนอ ตรงกัน */
        .choice-item.suggested-choice.original-choice {
            border: 2px solid #1cc88a;
            background-color: #eafff5;
        }

        .choice-input-group {
            display: flex;
            gap: 8px;
            align-items: center;
            width: 100%;
        }

        .btn-remove-choice {
            color: #dc3545;
            cursor: pointer;
            padding: 5px 10px;
        }

        .btn-remove-choice:hover {
            background-color: #ffeef0;
            border-radius: 4px;
        }

        /* Gallery Styles */
        .image-gallery-container {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 10px;
            text-align: center;
            position: relative;
            min-height: 200px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .gallery-img {
            max-height: 250px;
            max-width: 100%;
            object-fit: contain;
            margin-bottom: 10px;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .gallery-controls {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-top: 10px;
        }

        /* -------------------------------------------------------------------- */
        /* 4.8 Data Tables & Responsive Table Styles */
        /* -------------------------------------------------------------------- */
        table.dataTable thead th {
            border-bottom: 2px solid #e3e6f0;
            color: var(--primary-color);
            white-space: nowrap;
        }

        table.dataTable tbody td {
            vertical-align: middle;
        }

        .img-preview-mini {
            max-height: 40px;
            cursor: pointer;
            border-radius: 4px;
            border: 1px solid #ddd;
        }

        .img-preview-mini:hover {
            transform: scale(2.5);
            transition: transform 0.2s;
            z-index: 100;
            position: relative;
        }

        .table-scroll {
            max-height: 400px;
            overflow: auto;
            font-size: 0.85rem;
        }

        .editable-cell {
            background-color: #fff;
            transition: background-color 0.2s;
            min-width: 100px;
        }

        .editable-cell:focus {
            background-color: #e8f0fe;
            outline: 2px solid var(--primary-color);
            padding: 5px;
        }

        .selected-cell {
            background-color: #ffe8d1 !important;
            /* พื้นหลังสีส้มอ่อนสำหรับเซลล์ที่ถูกเลือก */
            border: 1px dashed #fd7e14 !important;
            /* เส้นประ */
        }

        /* Responsive Utility for DataTables */
        .table-responsive {
            border: none;
            width: 100%;
            overflow-x: auto;
            wrap: nowrap;
            -webkit-overflow-scrolling: touch;
            /* smooth scrolling on iOS */
        }

        /* Default table sizing: allow horizontal scroll when necessary */
        .table-responsive table {
            width: 100%;
            min-width: 600px;
            table-layout: auto;
        }

        /* -------------------------------------------------------------------- */
        /* 4.9 Converter/Tab Styles */
        /* -------------------------------------------------------------------- */
        .converter-area {
            background: #fff;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        @media (min-width: 768px) {
            .converter-area {
                padding: 20px;
            }
        }

        .converter-control-panel {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-bottom: 20px;
        }

        @media (min-width: 992px) {
            .converter-control-panel {
                display: grid;
                grid-template-columns: 1fr 1fr;
            }
        }

        .input-field label {
            font-weight: 600;
            font-size: 0.9rem;
        }

        .input-field input,
        .input-field textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }

        .tabs {
            display: flex;
            margin-bottom: 10px;
            border-bottom: 2px solid #ddd;
            overflow-x: auto;
            white-space: nowrap;
        }

        .tab {
            padding: 10px 15px;
            cursor: pointer;
            font-weight: bold;
            color: #555;
            font-size: 0.9rem;
        }

        .tab.active {
            color: var(--primary-color);
            border-bottom: 3px solid var(--primary-color);
        }

        /* -------------------------------------------------------------------- */
        /* 4.10 Structure Tree View Styles */
        /* -------------------------------------------------------------------- */
        .tree-container {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e3e6f0;
        }

        .tree-view,
        .tree-view ul {
            list-style: none;
            margin: 0;
            padding: 0;
            position: relative;
        }

        .tree-view ul {
            margin-left: 25px;
            /* Indentation */
            max-height: none;
            /* Removed max-height to allow scrolling */
            overflow: auto;
            /* Changed to auto to enable scrolling */
            transition: opacity 0.4s ease;
            opacity: 1;
        }

        .tree-view li {
            margin: 0;
            padding: 5px 0 5px 20px;
            position: relative;
            line-height: 24px;
            animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-8px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Vertical line */
        .tree-view li::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            border-left: 2px solid #d1d3e2;
            height: 100%;
            width: 1px;
            transition: border-color 0.3s ease;
        }

        /* Horizontal line connecting to icon */
        .tree-view li::after {
            content: "";
            position: absolute;
            top: 15px;
            left: 0;
            border-top: 2px solid #d1d3e2;
            width: 18px;
            transition: border-color 0.3s ease;
        }

        /* Remove excess vertical line from last item */
        .tree-view li:last-child::before {
            height: 15px;
        }

        /* การจัดการเส้นโยงและปุ่ม CRUD */
        .tree-node {
            display: flex;
            align-items: center;
            padding: 6px 12px;
            border-radius: 8px;
            margin-bottom: 2px;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .tree-node:hover {
            background-color: #f1f3f9;
            transform: translateX(4px);
        }

        /* ปุ่ม CRUD ที่จะแสดงเมื่อ Hover */
        .node-actions {
            margin-left: auto;
            display: flex;
            gap: 5px;
            opacity: 0;
            transform: translateX(10px);
            transition: opacity 0.25s ease, transform 0.25s ease;
            pointer-events: none;
        }

        .tree-node:hover .node-actions {
            opacity: 1;
            transform: translateX(0);
            pointer-events: auto;
        }

        .btn-node {
            width: 26px;
            height: 26px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            font-size: 0.75rem;
            border: none;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .btn-node:hover {
            transform: scale(1.1);
        }

        .btn-node:active {
            transform: scale(0.9);
        }

        .btn-add {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .btn-add:hover {
            background: #c8e6c9;
            box-shadow: 0 2px 8px rgba(46, 125, 50, 0.2);
        }

        .btn-edit {
            background: #e3f2fd;
            color: #1565c0;
        }

        .btn-edit:hover {
            background: #bbdefb;
            box-shadow: 0 2px 8px rgba(21, 101, 192, 0.2);
        }

        .btn-delete {
            background: #ffeeee;
            color: #c62828;
        }

        .btn-delete:hover {
            background: #ffcccc;
            box-shadow: 0 2px 8px rgba(198, 40, 40, 0.2);
        }

        /* ระบบเปิด-ปิด (Collapse) */
        .toggle-icon {
            cursor: pointer;
            width: 20px;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .tree-node.collapsed .toggle-icon {
            transform: rotate(-90deg);
        }

        .tree-node.collapsed+ul {
            max-height: 0;
            opacity: 0;
            overflow: hidden;
        }

        .node-subject {
            background: #eef2ff;
            border-left: 4px solid #4e73df;
            transition: all 0.25s ease;
        }

        .node-subject:hover {
            border-left-color: #224abe;
            background: #e0e7ff;
        }

        .node-group {
            background: #f0fdf4;
            border-left: 4px solid #1cc88a;
            margin-left: 10px;
            transition: all 0.25s ease;
        }

        .node-group:hover {
            border-left-color: #0d9488;
            background: #dcfce7;
        }

        .node-category {
            border-bottom: 1px solid #f1f3f9;
            margin-left: 20px;
            transition: border-color 0.25s ease;
        }

        .node-category:hover {
            border-bottom-color: #e3e6f0;
        }


        .badge-count {
            font-size: 0.7rem;
            background: #eaecf4;
            color: #4e73df;
            margin-left: 8px;
            padding: 2px 6px;
            border-radius: 10px;
        }

        /* -------------------------------------------------------------------- */
        /* 4.11 Responsive Tweaks (DataTables & General) */
        /* -------------------------------------------------------------------- */
        /* General small-device tweaks */
        @media (max-width: 575.98px) {

            .table-responsive table thead th,
            .table-responsive table tbody td {
                font-size: 0.85rem;
                white-space: nowrap;
            }

            .img-preview-mini {
                max-height: 30px;
            }
        }

        /* Specific improvements for very narrow devices (<= 430px) */
        @media (max-width: 430px) {

            /* Allow cells to wrap instead of forcing horizontal scroll,
           but keep horizontal scroll available if content cannot wrap */
            .table-responsive table {
                min-width: 0;
                table-layout: fixed;
                /* distribute available width */
                word-break: break-word;
            }

            .table-responsive table thead th,
            .table-responsive table tbody td {
                white-space: normal;
                /* allow wrapping of long text */
                font-size: 0.78rem;
                padding: 6px 8px;
                line-height: 1.15;
            }

            /* Reduce header emphasis to save space */
            .table-responsive table thead th {
                font-size: 0.75rem;
                font-weight: 600;
            }

            /* Make small preview images compact */
            .img-preview-mini {
                max-height: 24px;
                width: auto;
            }

            /* Reduce button padding inside tables */
            .table-responsive .btn {
                padding: 4px 6px;
                font-size: 0.78rem;
            }

            /* Allow long words/URLs to break */
            .table-responsive td,
            .table-responsive th {
                overflow-wrap: anywhere;
            }

            /* Optional: make action column narrow and center its content */
            .table-responsive td:last-child,
            .table-responsive th:last-child {
                width: 1%;
                white-space: nowrap;
                text-align: center;
            }
        }

        /* Custom Form Styles */
.form-floating-custom > label {
    font-size: 0.85rem;
    color: #6c757d;
}
.form-floating-custom > .form-control:focus ~ label {
    color: var(--primary-color);
}
.avatar-upload-box {
    width: 120px;
    height: 120px;
    border: 2px dashed #ced4da;
    border-radius: 10px;
    display: flex;
    justify-content: center;
    align-items: center;
    cursor: pointer;
    transition: border-color 0.3s, background-color 0.3s;
    overflow: hidden;
}
.avatar-upload-box:hover {
    border-color: var(--primary-color);
    background-color: #f8f9fa;
}
.avatar-upload-box img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}
.avatar-upload-box i {
    font-size: 2.5rem;
    color: #6c757d;
}
.hidden-file-input {
    display: none;
}
/* Auth Buttons in Topbar */
.auth-buttons-container {
    display: flex;
    align-items: center;
    gap: 10px;
}
.modal-header-auth {
    background: linear-gradient(135deg, #4e73df 0%, #224abe 100%);
    color: white;
    border-top-left-radius: 10px;
    border-top-right-radius: 10px;
    padding: 1.5rem;
    text-align: center;
}
.modal-auth-content {
    border: none;
    border-radius: 10px;
    overflow: hidden;
}

    </style>
</head>

<div class="d-flex" id="wrapper">

    <!-- ==================================================================== -->
    <!-- 1. SIDEBAR NAVIGATION -->
    <!-- ==================================================================== -->
    <div class="border-right" id="sidebar-wrapper">
        <div class="sidebar-heading">
            <i class="fas fa-brain"></i> MDKKUQUIZ
            <!-- ปุ่มปิด Sidebar สำหรับ Mobile -->
            <a href="#" id="sidebar-close-btn" class="d-md-none" aria-label="Close Sidebar">
                <i class="fas fa-times"></i>
            </a>
        </div>
        <div class="list-group list-group-flush mt-3">
            <a href="#" class="list-group-item list-group-item-action active" onclick="showSection('dashboard')">
                <i class="fas fa-tachometer-alt"></i> ภาพรวม (Dashboard)
            </a>
            <a href="#" class="list-group-item list-group-item-action" onclick="showSection('public-search')">
                <i class="fas fa-search"></i> ค้นหาข้อสอบ
            </a>

            <!-- Admin Menu Group -->
            <div class="admin-only">
                <div class="sidebar-heading"
                    style="font-size: 0.8rem; text-align: left; padding-left: 1.5rem; opacity: 0.7;">
                    ADMINISTRATION
                </div>
                <a href="#" class="list-group-item list-group-item-action" onclick="showSection('report-inbox')">
                    <i class="fas fa-exclamation-triangle"></i> Report Inbox
                    <span class="badge bg-danger rounded-pill ms-2" id="sidebar-report-count">0</span>
                </a>
                <a href="#" class="list-group-item list-group-item-action" onclick="showSection('database')">
                    <i class="fas fa-database"></i> จัดการ Database
                </a>
                <a href="#" class="list-group-item list-group-item-action" onclick="showSection('structure')">
                    <i class="fas fa-sitemap"></i> โครงสร้างวิชา
                </a>
                <a href="#" class="list-group-item list-group-item-action" onclick="showSection('converter')">
                    <i class="fas fa-file-code"></i> Converter Tool
                </a>
                <a href="#" class="list-group-item list-group-item-action developer-only" onclick="showSection('logs')">
                    <i class="fas fa-list-ul"></i> Activity Logs
                </a>

                <a href="#" class="list-group-item list-group-item-action developer-only" onclick="showSection('admin-manager')">
                    <i class="fas fa-users-cog"></i> Manage Admins
                </a>
            </div>
        </div>

        <div
            style="position: absolute; bottom: 20px; width: 100%; text-align: center; color: rgba(255,255,255,0.6); font-size: 0.9rem;">
            <div id="user-status-display">Guest User</div>
            <!-- <button id="btn-sidebar-login" class="btn btn-sm btn-outline-light mt-2" onclick="toggleLogin()">
                <i class="fas fa-sign-in-alt"></i> Admin Login
            </button> -->
        </div>
    </div>
    <!-- /#sidebar-wrapper -->

    <!-- ==================================================================== -->
    <!-- 2. PAGE CONTENT WRAPPER -->
    <!-- ==================================================================== -->
    <div id="page-content-wrapper">

        <!-- 2.1 Topbar -->
        <nav class="topbar mb-4 static-top">
            <button class="btn btn-link rounded-circle me-3" id="menu-toggle">
                <i class="fa fa-bars text-secondary"></i>
            </button>
            <h4 class="m-0 font-weight-bold text-primary" id="page-title">Dashboard</h4>
        
            <!-- AUTH SECTION (RIGHT SIDE) -->
            <div class="d-flex align-items-center ms-auto"> <!-- ms-auto pushes to right -->
                <div id="auth-guest-view" class="auth-buttons-container">
                    <button class="btn btn-outline-primary btn-sm rounded-pill px-3" onclick="openLoginModal()">
                        <i class="fas fa-sign-in-alt me-1"></i> Login
                    </button>
                    <button class="btn btn-primary btn-sm rounded-pill px-3" onclick="openRegisterModal()">
                        <i class="fas fa-user-plus me-1"></i> Register
                    </button>
                </div>
        
                <div id="auth-user-view" class="align-items-center hidden">
                    <span class="mr-2 d-none d-lg-inline text-gray-600 small me-2" id="topbar-user">Guest</span>
                    <img id="topbar-avatar" class="img-profile rounded-circle me-2" style="width: 32px; height: 32px;" src="">
                    <button class="btn btn-sm btn-light text-danger rounded-circle" onclick="logoutAdmin()" title="Logout">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>
        </nav>

        <!-- 2.2 Main Content Area -->
        <div class="container-fluid">

            <!-- SECTION: Dashboard (Public) -->
            <div id="sec-dashboard" class="content-section">
                <!-- 2.2.1 Stats Cards -->
                <div class="row">
                    <div class="col-xl-3 col-md-6 mb-4">
                        <div class="card card-dashboard border-left-primary h-100 py-2"
                            style="border-left: 4px solid var(--primary-color);">
                            <div class="card-body">
                                <div class="row no-gutters align-items-center">
                                    <div class="col mr-2">
                                        <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                            โจทย์ทั้งหมด</div>
                                        <div class="h5 mb-0 font-weight-bold text-gray-800" id="stat-total-q">...
                                        </div>
                                    </div>
                                    <div class="col-auto"><i class="fas fa-question-circle fa-2x text-gray-300"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-3 col-md-6 mb-4">
                        <div class="card card-dashboard h-100 py-2" style="border-left: 4px solid var(--danger-color);">
                            <div class="card-body">
                                <div class="row no-gutters align-items-center">
                                    <div class="col mr-2">
                                        <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">
                                            รอตรวจสอบ (Pending)</div>
                                        <div class="h5 mb-0 font-weight-bold text-gray-800" id="stat-pending-q">...
                                        </div>
                                    </div>
                                    <div class="col-auto"><i class="fas fa-clipboard-list fa-2x text-gray-300"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-3 col-md-6 mb-4">
                        <div class="card card-dashboard h-100 py-2"
                            style="border-left: 4px solid var(--success-color);">
                            <div class="card-body">
                                <div class="row no-gutters align-items-center">
                                    <div class="col mr-2">
                                        <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                            แก้ไขแล้ว (Resolved)</div>
                                        <div class="h5 mb-0 font-weight-bold text-gray-800" id="stat-resolved-q">...
                                        </div>
                                    </div>
                                    <div class="col-auto"><i class="fas fa-check-double fa-2x text-gray-300"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 2.2.2 Recent Activity Table -->
                <div class="card card-dashboard">
                    <div class="card-header-custom">
                        <span><i class="fas fa-history me-2"></i> การแก้ไขล่าสุด (Recent Updates)</span>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-bordered" width="100%" cellspacing="0" id="dashboardRecentTable">
                                <thead>
                                    <tr>
                                        <th style="width: 10%;">วันที่</th>
                                        <th style="width: 20%;">ข้อที่แก้ไข (คลิกดู)</th>
                                        <th style="width: 30%;">Report Detail</th>
                                        <th style="width: 30%;">การตอบกลับ (Admin Note)</th>
                                        <th style="width: 10%;">สถานะ</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- JS จะมาเติมข้อมูลตรงนี้ -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SECTION: Public Search -->
            <div id="sec-public-search" class="content-section hidden">
                <div class="card card-dashboard">
                    <div class="card-header-custom">
                        <span><i class="fas fa-search me-2"></i> ค้นหาข้อสอบ (Read Only)</span>
                    </div>
                    <div class="card-body">
                        <!-- Filters -->
                        <div class="row mb-3">
                            <div class="col-md-3">
                                <select class="form-select" id="search-subject-filter">
                                    <option value="">All Subjects</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select" id="search-category-filter">
                                    <option value="">All Categories</option>
                                </select>
                            </div>
                        </div>

                        <div class="table-responsive">
                            <table id="publicTable" class="table table-bordered table-striped" style="width:100%">
                                <thead>
                                    <tr>
                                        <th>Subject</th>
                                        <th>Category</th>
                                        <th>Question</th>
                                        <th>Img</th>
                                        <th>Answer</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Populated by JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SECTION: Report Inbox (Admin) -->
            <div id="sec-report-inbox" class="content-section hidden">
                <div class="row mb-3">
                    <div class="col-md-4">
                        <label class="small fw-bold mb-1">กรองตามรายวิชา:</label>
                        <select class="form-select" id="report-subject-filter" onchange="renderReportList()">
                            <option value="">All Subjects</option>
                            <!-- Options populated by JS -->
                        </select>
                    </div>
                </div>
                <div class="card card-dashboard border-left-danger">
                    <div class="card-header-custom">
                        <span class="text-danger"><i class="fas fa-inbox me-2"></i>
                            รายการแจ้งปัญหาที่รอการตรวจสอบ</span>
                    </div>
                    <div class="card-body" id="report-list-container">
                        <!-- Loading State -->
                        <div class="text-center text-muted py-5">
                            <i class="fas fa-spinner fa-spin fa-2x"></i> กำลังโหลดข้อมูล...
                        </div>
                    </div>
                </div>
            </div>

            <!-- SECTION: Database Manager (Admin) -->
            <div id="sec-database" class="content-section hidden">
                <div class="card card-dashboard">
                    <div class="card-header-custom">
                        <span><i class="fas fa-database me-2"></i> จัดการคลังข้อสอบ (Edit Mode)</span>
                        <button class="btn btn-success btn-sm shadow-sm" onclick="showSection('converter')">
                            <i class="fas fa-plus"></i> Import New
                        </button>
                    </div>
                    <div class="card-body">
                        <!-- Filters -->
                        <div class="row mb-3">
                            <div class="col-md-3">
                                <select class="form-select" id="db-subject-filter">
                                    <option value="">All Subjects</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select" id="db-category-filter">
                                    <option value="">All Categories</option>
                                </select>
                            </div>
                        </div>

                        <div class="table-responsive">
                            <table id="adminTable" class="table table-bordered table-striped" style="width:100%">
                                <thead class="table-light">
                                    <tr>
                                        <th>Subject</th> <!-- แยก Subject -->
                                        <th>Category</th>
                                        <th>Question</th>
                                        <th>Img</th>
                                        <th>Answer</th>
                                        <th style="width: 100px;">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Data populated by JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SECTION: Structure Manager (Admin) -->
            <div id="sec-structure" class="content-section hidden">
                <div class="card card-dashboard">
                    <div class="card-header-custom">
                        <span><i class="fas fa-sitemap me-2"></i> โครงสร้างวิชา (Structure & Category)</span>
                        <div>
                            <button class="btn btn-outline-primary btn-sm me-1" onclick="crudAction('addSubj')">
                                <i class="fas fa-university"></i> Add Subject
                            </button>
                            <button class="btn btn-primary btn-sm" onclick="crudAction('addCat')">
                                <i class="fas fa-plus"></i> Add Category
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Filter -->
                        <div class="row mb-4">
                            <div class="col-md-5">
                                <label class="form-label small fw-bold">กรองตามรายวิชา (Filter by Subject)</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-filter"></i></span>
                                    <select id="struct-subject-filter" class="form-select"
                                        onchange="renderStructureTree(this.value)">
                                        <option value="">-- แสดงทุกวิชา --</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Area สำหรับแสดง Tree -->
                        <div class="tree-container"
                            style="max-height: calc(100vh - 300px); overflow-y: auto; -webkit-overflow-scrolling: touch; padding-right: 8px;">
                            <div id="structure-tree-view" class="tree-view">
                                <!-- โครงสร้าง Folder จะถูกสร้างที่นี่ -->
                                <div class="text-center py-4 text-muted">
                                    <i class="fas fa-spinner fa-spin"></i> กำลังสร้างโครงสร้าง...
                                </div>
                            </div>
                        </div>

                        <!-- (Option) ปุ่มดูแบบตารางเดิมถ้าต้องการ -->
                        <div class="mt-3 text-end">
                            <small class="text-muted">หากต้องการแก้ไขรหัสโดยตรง โปรดใช้หน้า <b>จัดการ
                                    Database</b></small>
                        </div>
                    </div>
                </div>
            </div>

<!-- SECTION: Converter Tool -->
<div id="sec-converter" class="content-section hidden">
    <div class="converter-area">
        <h4><i class="fas fa-file-code text-primary"></i> Quiz & Structure Converter V4</h4>
        <p class="text-muted small">เครื่องมือช่วยแปลง Code หรือรายชื่อหัวข้อ ให้เป็น Format
            ที่พร้อมนำไปวางใน Google Sheets (Admin Only)</p>

        <!-- NEW: Instructions Section (ไม่ได้เปลี่ยนแปลง) -->
        <div class="card card-dashboard mb-4">
            <div class="card-header-custom">
                <span><i class="fas fa-info-circle me-2"></i> คู่มือการใช้งานและตัวอย่าง Format</span>
                <a class="btn btn-sm btn-outline-primary" data-bs-toggle="collapse" href="#converterInstructions"
                    role="button" aria-expanded="true" aria-controls="converterInstructions">
                    Show/Hide
                </a>
            </div>
            <div class="collapse show" id="converterInstructions">
                <div class="card-body">
                    <!-- Tabs for Instructions -->
                    <ul class="nav nav-tabs" id="instructionTab" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="tab1-tab" data-bs-toggle="tab" data-bs-target="#tab1"
                                type="button" role="tab">1. เพิ่มหัวข้อ Lecture (ใช้ทำข้อสอบแยกเลค)</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="tab2-tab" data-bs-toggle="tab" data-bs-target="#tab2"
                                type="button" role="tab">2. เพิ่มคำถามทีละหลายๆชุด (ใช้แปลงข้อสอบเก่าเข้าเว็บ)</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="tab3-tab" data-bs-toggle="tab" data-bs-target="#tab3"
                                type="button" role="tab">3. เพิ่มคำถามทีละชุด (ใช้แปลงข้อสอบเก่าเข้าเว็บ)</button>
                        </li>
                    </ul>
                    <div class="tab-content pt-3" id="instructionTabContent">
                        <!-- Tab 1: Category List -->
                        <div class="tab-pane fade show active" id="tab1" role="tabpanel">
                            <h6 class="text-primary fw-bold">ใช้เมื่อ: ต้องการเพิ่มหัวข้อข้อสอบแยกเลค</h6>
                            <p class="mb-0"><b>ตัวอย่าง:</b></p>
                            <pre class="bg-light p-2 rounded small"><code>
    ตาม format นี้ "ชื่อย่อวิชา_กลุ่ม_ชื่อหัวข้อ"
    GI_Anatomy_Oral Cavity
    GI_Physiology_Gastric Secretion
    GI_Pathology_Bacterial GI Infections
                                    </code></pre>
                        </div>
                        <!-- Tab 2: Quiz JSON Object -->
                        <div class="tab-pane fade" id="tab2" role="tabpanel">
                            <h6 class="text-primary fw-bold">ใช้เมื่อ: เพิ่มคำถามทีละหลายๆชุด</h6>
                            <!-- ... (ตัวอย่างเดิม) ... -->
                            <pre class="bg-light p-2 rounded small"><code>
    1. เก็บทุกอย่างในตัวแปรชื่อ quizdata
    ด้านในจะมี
    "ชื่อหัวข้อ1" : [ {คำถาม 1}, {คำถาม 2},... ],
    "ชื่อหัวข้อ2" : [ {คำถาม 1}, {คำถาม 2},... ], ...
    2. โครงสร้างของคำถาม
    {
    "problem": "ใส่คำถามตรงนี้",
    "img": "URL_A///URL_B", // ถ้ามีรูปหลายรูปให้ใช้ /// คั่นแต่ละลิงก์
    "choices": "ตัวเลือก1///ตัวเลือก2///ตัวเลือก3", // ใช้ /// คั่นแต่ละ choice
    "answer": "ตัวเลือกที่ถูกต้อง", // ต้องตรงกับ choice ที่ให้มา!!!
    "explain": "คำอธิบายเพิ่มเติม (ถ้ามี)"
    }

    เช่น
    var quizdata = {
    "GI51MCQ1_Anatomy": [
    {
    "problem": "1. What is the function of the liver?",
    "img": "https://drive.google.com/open?id=1hBnJKKlO6S2tuGp6Wvy627V25CipDkN_&usp=drive_copy",
    "choices": "Detoxification///Digestion///Respiration",
    "answer": "Detoxification",
    "explain": "The liver detoxifies various metabolites..."
    },
    {prob...}
    ],
    "GI51FMT1_Physiology": [
    {
    "problem": "1. What hormone regulates blood sugar levels?",
    "img": "",
    "choices": "Insulin///Glucagon///Adrenaline",
    "answer": "Insulin",
    "explain": "Insulin lowers blood sugar levels..."
    }
    ]
    };

                                        </code></pre>
                        </div>
                        <!-- Tab 3: Question Array (NEW) -->
                        <div class="tab-pane fade" id="tab3" role="tabpanel">
                            <h6 class="text-danger fw-bold">ใช้เมื่อ: เพิ่มคำถามทีละ 1 ชุด</h6>
                            <p><b>ใส่ชื่อหัวข้อ <span class="text-danger fw-bold">เช่น GI_52MCQ1_Anatomy,
                                        GEN4_52FMT2</span> ด้านล่าง</b></p>

                            <!-- 💥 ย้าย Input มาไว้ที่นี่ 💥 -->
                            <div class="col-12 mt-2 p-3 bg-danger-subtle rounded border border-danger mb-3">
                                <label class="small fw-bold text-danger"><i class="fas fa-exclamation-triangle"></i>
                                    ใส่ชื่อหัวข้อ </label>
                                <input type="text" id="arrayCategoryID"
                                    class="form-control form-control-sm border-danger"
                                    placeholder="ตาม format นี้ ชื่อวิชา_ปีและกลุ่ม_ชื่อหัวข้อ">
                            </div>
                            <!-- 💥 สิ้นสุด Input ที่ย้ายมา 💥 -->

                            <p><b>ตัวอย่าง Input:</b></p>
                            <pre class="bg-light p-2 rounded small"><code>
    1. เอามาแค่ [ {คำถาม1}, {คำถาม2},... ] แบบนี้เลย
    2. โครงสร้างของคำถาม
    {
    problem: "ใส่คำถามตรงนี้",
    img: "URL_A///URL_B", // ถ้ามีรูปหลายรูปให้ใช้ /// คั่นแต่ละลิงก์
    choices: "ตัวเลือก1///ตัวเลือก2///ตัวเลือก3", // ใช้ /// คั่นแต่ละ choice
    answer: "ตัวเลือกที่ถูกต้อง", // ต้องตรงกับ choice ที่ให้มา!!!
    explain: "คำอธิบายเพิ่มเติม (ถ้ามี)"
    }

    เช่น
    [
    {
    problem: "1. What is the primary function of red blood cells?",
    img: "https://drive.google.com/open?id=1hBnJKKlO6S2tuGp6Wvy627V25CipDkN_&usp=drive_copy",
    choices: "Oxygen transport///Immune response///Blood clotting",
    answer: "Oxygen transport",
    explain: "Red blood cells are responsible for transporting oxygen..."
    },
    {
    problem: "2. Which organ is primarily responsible for detoxification?",
    img: "",
    choices: "Liver///Kidneys///Lungs",
    answer: "Liver",
    explain: "The liver detoxifies various metabolites..."
    }
    ]
                                        </code></pre>
                            <!-- <p class="mb-0"><b>การทำงานของ Group Keywords:</b> หาก Category ID ที่คุณระบุ
                                            (เช่น
                                            `NS_MCQ1_CranialNerves`) มีคำที่ตรงกับ <code>Group Keywords</code> (เช่น
                                            `MCQ`)
                                            ระบบจะจัดให้อยู่ในกลุ่ม <b>MCQ</b> โดยอัตโนมัติ</p> -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- END Instructions Section -->


        <div class="converter-control-panel">
            <div>
                <label class="mb-2 fw-bold">วาง Code หรือ รายชื่อ CategoryID ที่นี่</label>
                <textarea id="jsonInput" class="form-control" rows="8" placeholder="วางโค้ดที่นี่..."></textarea>
            </div>
            <div>
                <div class="row g-2">
                    <div class="col-md-4">
                        <label class="small">ชั้นปี (Year)</label>
                        <input type="number" id="yearVal" class="form-control form-control-sm" placeholder="1,2,3">
                    </div>
                    <div class="col-md-4">
                        <label class="small">รหัสวิชา (Subject ID)</label>
                        <input type="text" id="subjID" class="form-control form-control-sm" placeholder="GI, NS">
                    </div>
                    <div class="col-md-4">
                        <label class="small">ชื่อวิชา</label>
                        <input type="text" id="subjName" class="form-control form-control-sm" placeholder="Full Name">
                    </div>
                    <div class="col-12">
                        <label class="small">กลุ่มคำย่อ (Group Keywords)</label>
                        <input type="text" id="groupKeys" class="form-control form-control-sm" value="MCQ1,MCQ2,MCQ3,MCQ4,FMT1,FMT2,by AI"
                            placeholder="เช่น MCQ1,MCQ2,MCQ3,MCQ4,FMT1,FMT2,by AI">
                    </div>

                    <!-- 🚫 ช่อง Input Array Category ID ถูกนำออกแล้ว เพื่อให้แสดงแค่ใน Instruction Tab 🚫 -->

                    <div class="col-12 mt-3">
                        <button class="btn btn-primary w-100" onclick="processAll()"><i class="fas fa-bolt"></i>
                            เริ่มประมวลผลข้อมูล</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ปรับปรุงชื่อ Tab ให้สื่อสารวัตถุประสงค์ -->
        <div class="tabs">
            <div class="tab" id="tab-struct" onclick="switchTab('struct')">1. Structure
                (โครงสร้างวิชา/กลุ่ม)</div>
            <div class="tab" id="tab-category" onclick="switchTab('category')">2. Category (หัวข้อ)
            </div>
            <div class="tab active" id="tab-ques" onclick="switchTab('ques')">3. Questions (ข้อมูลข้อสอบ)
            </div>
        </div>

        <div class="d-flex justify-content-between align-items-center mb-2">
            <div>
                <span id="previewText" class="small text-muted">รอข้อมูล...</span>
                <span class="badge bg-warning text-dark ms-2"><i class="fas fa-pen"></i>
                    แก้ไขในตารางได้เลย</span>
            </div>
            <div class="d-flex gap-2">
                <!-- <button class="btn btn-warning btn-sm"
                    onclick="deduplicateConverterData('struct', [1, 3]); deduplicateConverterData('category', [0]); deduplicateConverterData('ques', [0]);"><i
                        class="fas fa-filter"></i> ลบข้อมูลซ้ำ (Auto Deduplicate)</button> -->
                <button class="btn btn-outline-primary btn-sm me-2" onclick="copyCurrentSheet()"><i class="fas fa-copy"></i>
                    Copy to Clipboard</button>
                <button class="btn btn-success btn-sm" onclick="importConvertedData()"><i class="fas fa-cloud-upload-alt"></i>
                    💾 บันทึกเข้าระบบ (Import to DB)</button>
            </div>
        </div>

        <div class="table-scroll border rounded bg-light p-2">
            <table class="table table-sm table-bordered bg-white mb-0" id="dataTable">
                <thead>
                    <tr id="tableHead"></tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>
</div>

            <!-- SECTION: Logs (Admin) -->
            <div id="sec-logs" class="content-section hidden">
                <div class="card card-dashboard">
                    <div class="card-header-custom">
                        <span><i class="fas fa-history me-2"></i> บันทึกกิจกรรม (Admin Logs)</span>
                        <button class="btn btn-outline-secondary btn-sm" onclick="fetchData(true)">
                            <i class="fas fa-sync"></i> Refresh
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table id="logsTable" class="table table-sm table-hover" style="width:100%">
                                <thead>
                                    <tr>
                                        <th>เวลา</th>
                                        <th>ผู้ใช้งาน</th>
                                        <th>การกระทำ</th>
                                        <th>เป้าหมาย (ID)</th>
                                        <th>รายละเอียด</th>
                                        <th>ตรวจสอบ</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SECTION: Admin Management (Developer Only) -->
            <div id="sec-admin-manager" class="content-section hidden">
                <div class="card card-dashboard">
                    <div class="card-header-custom bg-dark text-white">
                        <span><i class="fas fa-user-shield me-2"></i> User Management (Developer Power)</span>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table id="adminUserTable" class="table table-hover table-bordered" style="width:100%">
                                <thead>
                                    <tr>
                                        <th>Avatar</th>
                                        <th>Username</th>
                                        <th>Full Name</th>
                                        <th>Role</th>
                                        <th>KKUMail</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody id="admin-user-list"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div> <!-- /container-fluid -->
    </div> <!-- /#page-content-wrapper -->
</div> <!-- /#wrapper -->

<!-- ==================================================================== -->
<!-- 3. MODALS -->
<!-- ==================================================================== -->

<!-- Modal: View Diff (Side-by-Side Comparison) -->
<div class="modal fade" id="diffModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-light">
                <h5 class="modal-title text-primary"><i class="fas fa-exchange-alt me-2"></i> เปรียบเทียบข้อมูล (Compare
                    Changes)</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body bg-light">
                <div class="row h-100">
                    <!-- ฝั่งซ้าย: ข้อมูลเก่า -->
                    <div class="col-md-6 border-end">
                        <div class="diff-col-header header-old">
                            <i class="fas fa-history"></i> ข้อมูลเดิม (Old Version)
                        </div>
                        <div id="diff-container-old" class="diff-content-box">
                            <!-- JS จะ Gen ข้อมูลมาใส่ตรงนี้ -->
                        </div>
                    </div>

                    <!-- ฝั่งขวา: ข้อมูลใหม่ -->
                    <div class="col-md-6">
                        <div class="diff-col-header header-new">
                            <i class="fas fa-check-circle"></i> ข้อมูลใหม่ (New Version)
                        </div>
                        <div id="diff-container-new" class="diff-content-box">
                            <!-- JS จะ Gen ข้อมูลมาใส่ตรงนี้ -->
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ปิด</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Edit Profile (สำหรับผู้ใช้ที่ login) -->
<div class="modal fade" id="editProfileModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="fas fa-user-edit"></i> แก้ไขข้อมูลส่วนตัว</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
                        <div class="modal-body">
                            <div class="text-center mb-3">
                                <div class="avatar-upload-box mx-auto" onclick="$('#edit-avatar-input').click()"
                                    style="width: 100px; height: 100px;">
                                    <img id="edit-avatar-preview" src=""
                                        style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">
                                    <div class="overlay-icon"><i class="fas fa-camera"></i></div>
                                </div>
                                <input type="file" id="edit-avatar-input" class="d-none" accept="image/*" onchange="previewEditAvatar(this)">
                            </div>
                            <div class="row g-2">
                                <div class="col-md-4">
                                    <label class="small fw-bold">คำนำหน้า</label>
                                    <input type="text" id="ep-prefix" class="form-control form-control-sm">
                                </div>
                                <div class="col-md-8">
                                    <label class="small fw-bold">ชื่อจริง-นามสกุล</label>
                                    <input type="text" id="ep-fullname" class="form-control form-control-sm">
                                </div>
                                <div class="col-md-6">
                                    <label class="small fw-bold">Display Name</label>
                                    <input type="text" id="ep-displayname" class="form-control form-control-sm">
                                </div>
                                <div class="col-md-6">
                                    <label class="small fw-bold">ชั้นปี</label>
                                    <input type="number" id="ep-year" class="form-control form-control-sm">
                                </div>
                                <div class="col-12">
                                    <label class="small fw-bold">Contact</label>
                                    <input type="text" id="ep-contact" class="form-control form-control-sm">
                                </div>
                            </div>
                                            <hr>
                                            <!-- เพิ่มปุ่มเปลี่ยนรหัสตรงนี้ -->
                                            <div class="text-center">
                                                <button type="button" class="btn btn-outline-warning btn-sm w-100" onclick="openResetFromProfile()">
                                                    <i class="fas fa-key me-1"></i> เปลี่ยนรหัสผ่าน (Change Password)
                                                </button>
                                            </div>
                        </div>
            <div class="modal-footer bg-light">
                <button type="button" class="btn btn-primary w-100"
                    onclick="updateUserProfile()">บันทึกการเปลี่ยนแปลง</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Login -->
<div class="modal fade" id="loginModal" tabindex="-1">
    <div class="modal-dialog modal-sm">
        <div class="modal-content modal-auth-content">
            <div class="modal-header-auth">
                <h5 class="m-0 fw-bold"><i class="fas fa-user-lock"></i> Admin Login</h5>
            </div>
            <div class="modal-body p-4">
                <div class="mb-3">
                    <label class="form-label small fw-bold">Username</label>
                    <input type="text" id="login-username" class="form-control" placeholder="Enter username">
                </div>
                <div class="mb-3">
                    <label class="form-label small fw-bold">Password</label>
                    <input type="password" id="login-password" class="form-control" placeholder="Enter password">
                </div>
                <button class="btn btn-primary w-100 mb-2" onclick="performLogin()">Login</button>
                <div class="text-center">
                    <a href="#" class="small text-muted text-decoration-none" onclick="openResetModal()">ลืมรหัสผ่าน /
                        เปลี่ยนรหัสผ่าน?</a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Register -->
<div class="modal fade" id="registerModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content modal-auth-content">
            <div class="modal-header-auth bg-success">
                <h5 class="m-0 fw-bold"><i class="fas fa-user-plus"></i> สมัครสมาชิก Admin ใหม่</h5>
                <button type="button" class="btn-close btn-close-white position-absolute top-0 end-0 m-3"
                    data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <form id="registerForm">
                    <div class="row">
                        <!-- Avatar Column -->
                        <div class="col-md-3 text-center border-end">
                            <label class="form-label fw-bold text-primary">รูปโปรไฟล์</label>
                            <div class="avatar-upload-box" onclick="$('#reg-avatar-input').click()">
                                <img id="reg-avatar-preview" class="hidden">
                                <i id="reg-avatar-icon" class="fas fa-camera"></i>
                            </div>
                            <input type="file" id="reg-avatar-input" class="hidden-file-input" accept="image/*"
                                onchange="previewAvatar(this)">
                            <small class="text-muted d-block" style="font-size: 0.75rem;">คลิกเพื่ออัปโหลด<br>(แนะนำ
                                1:1)</small>
                        </div>

                        <!-- Info Column -->
                        <div class="col-md-9 ps-md-4">
                            <h6 class="text-primary fw-bold mb-3 border-bottom pb-2">ข้อมูลส่วนตัว & ยืนยันตัวตน</h6>
                            <div class="row g-2 mb-2">
                                <div class="col-md-2">
                                    <label class="small fw-bold">คำนำหน้า</label>
                                    <select class="form-select form-select-sm" id="reg-prefix">
                                        <option value="นาย">นาย</option>
                                        <option value="นางสาว">นางสาว</option>
                                        <option value="นาง">นาง</option>
                                        <option value="นพ.">นพ.</option>
                                        <option value="พญ.">พญ.</option>
                                    </select>
                                </div>
                                <div class="col-md-5">
                                    <label class="small fw-bold">ชื่อ-นามสกุล (ไทย)</label>
                                    <input type="text" class="form-control form-control-sm" id="reg-fullname" required>
                                </div>
                                <div class="col-md-5">
                                    <label class="small fw-bold">ชื่อแสดง (Display Name)</label>
                                    <input type="text" class="form-control form-control-sm" id="reg-displayname"
                                        required placeholder="ชื่อที่จะโชว์ในเว็บ">
                                </div>
                            </div>

                            <div class="row g-2 mb-2">
                                <div class="col-md-4">
                                    <label class="small fw-bold">รหัสนักศึกษา (มีขีด)</label>
                                    <input type="text" class="form-control form-control-sm" id="reg-studentid"
                                        placeholder="123456789-0" required>
                                </div>
                                <div class="col-md-2">
                                    <label class="small fw-bold">ชั้นปี</label>
                                    <select class="form-select form-select-sm" id="reg-year">
                                        <option value="1">1</option>
                                        <option value="2">2</option>
                                        <option value="3">3</option>
                                        <option value="4">4</option>
                                        <option value="5">5</option>
                                        <option value="6">6</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="small fw-bold">KKU Mail (@kkumail.com)</label>
                                    <input type="email" class="form-control form-control-sm" id="reg-kkumail" required>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="small fw-bold">ช่องทางติดต่อ (Line ID / FB / Tel)</label>
                                <input type="text" class="form-control form-control-sm" id="reg-contact">
                            </div>

                            <h6 class="text-primary fw-bold mb-3 border-bottom pb-2 mt-4">ตั้งค่าบัญชี</h6>
                            <div class="row g-2">
                                <div class="col-md-6">
                                    <label class="small fw-bold">Username</label>
                                    <input type="text" class="form-control form-control-sm" id="reg-username" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="small fw-bold">Password</label>
                                    <input type="password" class="form-control form-control-sm" id="reg-password"
                                        required>
                                </div>
                            </div>

                            <!-- Hidden Role (Default Admin) -->
                            <input type="hidden" id="reg-role" value="Admin">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer bg-light">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button>
                <button type="button" class="btn btn-success px-4" onclick="submitRegister()">
                    <i class="fas fa-check-circle me-1"></i> ยืนยันการสมัคร
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Reset Password -->
<div class="modal fade" id="resetModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content modal-auth-content">
            <div class="modal-header-auth bg-warning text-dark">
                <h5 class="m-0 fw-bold"><i class="fas fa-key"></i> เปลี่ยนรหัสผ่าน / ลืมรหัสผ่าน</h5>
                <button type="button" class="btn-close position-absolute top-0 end-0 m-3"
                    data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <div class="alert alert-info small">
                    <i class="fas fa-info-circle"></i> กรุณากรอกข้อมูลให้ตรงกับที่ลงทะเบียนไว้เพื่อยืนยันตัวตน
                </div>
                <div class="mb-2">
                    <label class="small fw-bold">Username</label>
                    <input type="text" class="form-control form-control-sm" id="reset-username">
                </div>
                <div class="mb-2">
                    <label class="small fw-bold">KKU Mail</label>
                    <input type="email" class="form-control form-control-sm" id="reset-kkumail">
                </div>
                <div class="mb-2">
                    <label class="small fw-bold">รหัสนักศึกษา</label>
                    <input type="text" class="form-control form-control-sm" id="reset-studentid">
                </div>
                <div class="mb-2">
                    <label class="small fw-bold">ชื่อ-นามสกุล (ไทย)</label>
                    <input type="text" class="form-control form-control-sm" id="reset-fullname">
                </div>
                <hr>
                <div class="mb-3">
                    <label class="small fw-bold text-success">รหัสผ่านใหม่ที่ต้องการ</label>
                    <input type="password" class="form-control" id="reset-newpass">
                </div>
                <button class="btn btn-warning w-100 fw-bold" onclick="submitResetPassword()">เปลี่ยนรหัสผ่าน</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Question Detail -->
<div class="modal fade" id="questionDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">รายละเอียดข้อสอบ</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Dynamic Content -->
                <h5 id="modal-q-header">
                    <span id="modal-q-subject" class="badge bg-secondary me-1">SUBJ</span>
                    <span id="modal-q-category" class="badge bg-primary">Category</span>
                </h5>
                <p id="modal-q-text" class="lead mt-3" style="font-weight: 500;">...</p>
                <div id="modal-q-img-container" class="text-center mb-3"></div>
                <div id="modal-q-choices" class="list-group mb-3">
                    <!-- Choices injected here -->
                </div>
                <div class="alert alert-secondary"><strong>Explanation:</strong> <span id="modal-q-explain"></span>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-warning" id="btn-modal-report">
                    <i class="fas fa-flag"></i> Report
                </button>
                <!-- ปุ่ม Vote Category ถูกเปลี่ยนเป็น btn-open-vote เพื่อเปิด modal ใหม่ -->
                <button type="button" class="btn btn-outline-info" id="btn-open-vote">
                    <i class="fas fa-tags"></i> Vote Category
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Vote Category -->
<div id="vote-category-modal" class="modal-card">
    <div class="modal-body">
        <h5 class="modal-title" style="color: var(--primary-color); margin-bottom: 0.5rem;">
            <i class="fas fa-tags"></i> จัดหมวดหมู่ข้อสอบ
        </h5>
        <p class="small-text" style="margin-bottom: 1rem; color: #666;">
            ช่วยกันระบุว่าข้อนี้อยู่ในหัวข้อใดได้บ้าง</p>

        <!-- Preview โจทย์ -->
        <div id="vote-question-preview"
            style="background:#f8f9fa; padding:12px; border-left: 4px solid var(--primary-color); border-radius:4px; margin-bottom:20px; font-weight:600; font-size: 1rem; color: #333; line-height: 1.4;">
        </div>

        <!-- Section 1: หัวข้อปัจจุบัน (Approved) -->
        <div class="vote-section">
            <h6 style="font-size: 1.1rem; color: #28a745; margin-bottom: 8px;">
                <i class="fas fa-check-circle"></i> หัวข้อปัจจุบัน (Approved)
            </h6>
            <div id="current-category-container" class="category-badge-container">
                <!-- Badges will be injected here -->
                <span class="empty-state-text">- ยังไม่มีหัวข้อ -</span>
            </div>
        </div>

        <!-- Section 2: สิ่งที่คนอื่นเสนอ (Pending) -->
        <div class="vote-section" style="margin-top: 15px;">
            <h6 style="font-size: 1.1rem; color: #fd7e14; margin-bottom: 8px;">
                <i class="fas fa-clock"></i> รออนุมัติ (คลิกเพื่อโหวตเห็นด้วย +1)
            </h6>
            <div id="suggested-category-container" class="category-badge-container">
                <span class="empty-state-text"><i class="fas fa-spinner fa-spin"></i> กำลังโหลดข้อมูล...</span>
            </div>
        </div>

        <hr style="border: 0; border-top: 1px solid #eee; margin: 20px 0;">

        <!-- Section 3: เพิ่มหัวข้อใหม่ -->
        <h6 style="font-size: 1.1rem; color: var(--color-dark); margin-bottom: 10px;">
            <i class="fas fa-plus-circle"></i> เสนอหัวข้อเพิ่มเติม
        </h6>

        <div id="vote-rows-container">
            <!-- Dynamic Rows Here -->
        </div>

        <button id="btn-add-vote-row" class="quiz-button"
            style="width: 100%; justify-content: center; margin-top: 10px;">
            <i class="fas fa-plus"></i> เพิ่มช่องเลือกหัวข้อ
        </button>

        <div class="controls-container" style="margin-top: 1.5rem;">
            <button id="btn-close-vote-modal" class="quiz-button btn-light">ปิด</button>
            <button id="btn-submit-vote" class="quiz-button btn-dark" style="min-width: 120px;">ยืนยัน</button>
        </div>
    </div>
</div>

<!-- Modal: Report -->
<div id="report-card" class="modal-card">
    <div class="modal-body">
        <h4 class="modal-title mb-3" style="color: #dc3545;"><i class="fas fa-flag"></i> แจ้งปัญหาและเสนอแนวทางแก้ไข
        </h4>

        <!-- Section 1: Question Details -->
        <div id="report-question-details" class="modal-section">
            <h6 class="fw-bold" style="color: #dc3545;">โจทย์ที่พบปัญหา:</h6>
            <p id="report-question-text" class="mb-2"></p>
            <div id="report-question-images" class="text-center"></div>

            <div class="mt-2 pt-2 border-top border-danger border-opacity-25">
                <h6 class="fw-bold small">ตัวเลือกปัจจุบัน (Choices):</h6>
                <div id="report-choices-list" class="ps-2"></div>
            </div>
        </div>

        <!-- Section 2: Suggested Correction -->
        <div class="modal-section" style="background-color: #f0fff0; border: 2px solid #28a745;">
            <h6 class="fw-bold" style="color: #28a745;"><i class="fas fa-check-circle"></i> เสนอคำตอบที่ถูกต้อง /
                แก้ไข
            </h6>

            <label class="small fw-bold mb-1">1. เลือกจากตัวเลือกเดิม:</label>
            <select id="report-correct-choice-select" class="form-select mb-3 border-success"></select>

            <label class="small fw-bold mb-1">2. หรือ พิมพ์คำตอบใหม่ (กรณีไม่มีในตัวเลือกเดิม):</label>
            <input type="text" id="report-new-choice-input" class="form-control"
                placeholder="พิมพ์คำตอบที่ถูกต้องใหม่ที่นี่...">
        </div>

        <!-- Section 3: Reason -->
        <div class="modal-section bg-light border">
            <h6 class="fw-bold text-primary"><i class="fas fa-comment-alt"></i> รายละเอียด/เหตุผลของปัญหา</h6>
            <textarea id="report_text" class="form-control"
                placeholder="อธิบายว่าผิดตรงไหน เช่น เฉลยผิดข้อ, โจทย์สะกดผิด, หรือข้อมูลล้าสมัย..."></textarea>
        </div>

        <div class="d-flex justify-content-end gap-2 mt-3">
            <button id="cancel-report" class="btn btn-light rounded-pill px-4">ยกเลิก</button>
            <button id="submit-report" class="btn btn-danger rounded-pill px-4">ส่งรายงาน (Submit)</button>
        </div>
    </div>
</div>

<!-- Modal: Edit Question (Admin) -->
<div class="modal fade" id="editQuestionModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="fas fa-edit"></i> แก้ไขข้อสอบ</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editForm">
                    <input type="hidden" id="edit-q-id">

                    <!-- Hidden Fields สำหรับเก็บค่าส่งไป Backend (รักษา Logic เดิม) -->
                    <input type="hidden" id="edit-choices">
                    <input type="hidden" id="edit-answer">

                    <div class="row g-3">
                        <!-- Category -->
                        <div class="col-md-12">
                            <label class="form-label fw-bold">Categories (หัวข้อ)</label>
                            <div id="dynamic-categories-container" class="d-flex flex-column gap-2 mb-2">
                                <!-- JS จะสร้าง Input กล่องๆ มาใส่ตรงนี้ -->
                            </div>
                            <button type="button" class="btn btn-sm btn-outline-info w-100 dashed-border mb-3"
                                onclick="addNewCategoryRow()">
                                <i class="fas fa-plus"></i> เพิ่มหัวข้อ (Add Category)
                            </button>
                            <input type="hidden" id="edit-category-hidden"> <!-- สำหรับเก็บค่าส่งไป Backend -->
                        </div>

                        <!-- Question -->
                        <div class="col-12">
                            <label class="form-label fw-bold">Question Problem</label>
                            <textarea class="form-control" id="edit-problem" rows="3"
                                placeholder="พิมพ์โจทย์ที่นี่..."></textarea>
                        </div>

                        <!-- Image Gallery Section -->
                        <div class="col-12">
                            <label class="form-label fw-bold">Images</label>
                            <input type="hidden" id="edit-img">

                            <!-- Container สำหรับใส่กล่อง Input รูปภาพ -->
                            <div id="dynamic-images-container" class="d-flex flex-column gap-2 mb-2">
                                <!-- JS จะสร้าง Input มาใส่ตรงนี้ -->
                            </div>
                            <button type="button" class="btn btn-sm btn-outline-primary w-100 dashed-border mb-3"
                                onclick="addNewImageRow()">
                                <i class="fas fa-plus"></i> เพิ่มรูปภาพ (Add Image)
                            </button>

                            <!-- Gallery Preview -->
                            <div id="edit-image-gallery-container" class="image-gallery-container"
                                style="display:none;">
                                <img src="" id="edit-gallery-img" class="gallery-img">
                                <div class="gallery-controls">
                                    <button type="button" class="btn btn-sm btn-outline-primary rounded-circle"
                                        id="prev-img-btn">
                                        <i class="fas fa-chevron-left"></i>
                                    </button>
                                    <span id="image-counter" class="badge bg-secondary rounded-pill">1 / 1</span>
                                    <button type="button" class="btn btn-sm btn-outline-primary rounded-circle"
                                        id="next-img-btn">
                                        <i class="fas fa-chevron-right"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Choices & Answer Section (Dynamic) -->
                        <div class="col-12">
                            <label class="form-label fw-bold d-flex justify-content-between align-items-center">
                                Choices & Correct Answer
                                <small class="text-muted fw-normal">(ติ๊กวงกลมเพื่อเลือกเฉลย)</small>
                            </label>

                            <div id="dynamic-choices-container" class="d-flex flex-column gap-2 mb-2">
                                <!-- JS จะสร้าง Input กล่องๆ มาใส่ตรงนี้ -->
                            </div>

                            <button type="button" class="btn btn-sm btn-outline-success w-100 dashed-border"
                                onclick="addNewChoiceRow()">
                                <i class="fas fa-plus"></i> เพิ่มตัวเลือก (Add Choice)
                            </button>
                        </div>

                        <!-- Explanation -->
                        <div class="col-12">
                            <label class="form-label fw-bold">Explanation</label>
                            <!-- ปรับความสูงเป็น rows="6" -->
                            <textarea class="form-control" id="edit-explanation" rows="6"
                                placeholder="คำอธิบายเฉลย..."></textarea>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer bg-light">
                <button type="button" class="btn btn-outline-danger me-auto" onclick="deleteQuestion()">
                    <i class="fas fa-trash-alt"></i> Delete
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary px-4" onclick="saveQuestionChanges()">
                    <i class="fas fa-save"></i> Save Changes
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Add New Category -->
<div class="modal fade" id="addCategoryModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title"><i class="fas fa-plus-circle"></i> เพิ่มหัวข้อใหม่ (Add Category)</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addCategoryForm">
                    <div class="mb-3">
                        <label class="form-label fw-bold">1. เลือกวิชา (Subject Reference)</label>
                        <select class="form-select" id="new-category-subject" onchange="generateCategoryIDPreview()">
                            <option value="">-- กรุณาเลือกวิชา --</option>
                            <!-- Option จะถูกสร้างโดย JS -->
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">2. ชื่อกลุ่ม (Accordion Group)</label>
                        <input type="text" class="form-control" id="new-category-group"
                            placeholder="เช่น MCQ1, LEC, LAB" oninput="generateCategoryIDPreview()">
                        <small class="text-muted">ใช้สำหรับจัดกลุ่มในหน้าเลือกหัวข้อ</small>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">3. ชื่อหัวข้อ (Display Name)</label>
                        <input type="text" class="form-control" id="new-category-name"
                            placeholder="เช่น Anatomy, Physiology" oninput="generateCategoryIDPreview()">
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold text-primary">4. Category ID (Auto Generated)</label>
                        <div class="input-group">
                            <input type="text" class="form-control font-monospace" id="new-category-id"
                                placeholder="Ex. GI_Anatomy">
                            <button class="btn btn-outline-secondary" type="button"
                                onclick="generateCategoryIDPreview()"><i class="fas fa-sync"></i></button>
                        </div>
                        <small class="text-danger" id="category-id-error"></small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button>
                <button type="button" class="btn btn-success" onclick="saveNewCategory()">บันทึกหัวข้อ</button>
            </div>
        </div>
    </div>
</div>

<!-- ==================================================================== -->
<!-- 4. OVERLAYS (Loading) -->
<!-- ==================================================================== -->
<!-- Loading Overlay -->
<div id="loading-overlay"
    style="display:none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.8); z-index:9999; justify-content:center; align-items:center;">
    <div class="text-center">
        <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;"></div>
        <h5 class="mt-2 text-primary">กำลังเชื่อมต่อฐานข้อมูล...</h5>
    </div>
</div>

<!-- ==================================================================== -->
<!-- 5. JAVASCRIPT LIBRARIES -->
<!-- ==================================================================== -->
<script src="https://code.jquery.com/jquery-3.7.0.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
    async function sendWithRetry(payload, retries = 3) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(APPSCRIPT_URL, {
                        method: 'POST',
                        headers: { "Content-Type": "text/plain;charset=utf-8" },
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) throw new Error('Server Busy');
                    return await response.json();
                } catch (err) {
                    console.warn(`Attempt ${i + 1} failed. Retrying...`);
                    if (i === retries - 1) throw err;
                    // หน่วงเวลาเพิ่มขึ้นเรื่อยๆ ในแต่ละรอบที่ล้มเหลว (1s, 2s, 3s)
                    await new Promise(res => setTimeout(res, 1000 * (i + 1)));
                }
            }
        }
    // ====================================================================
    // 1. GLOBAL CONFIGURATION & VARIABLES
    // ====================================================================
    const APPSCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzx1Vwd2v5QLq3mKiloME2nE2eK44sC7xkgf1gJU03_Mv3OGKXVLDYANUMCjDXy1-kW/exec';

    let globalData = {
        questions: [],
        structure: [],
        category: [],
        report: [],
        votes: [],
        logs: []
    };
    let currentUser = { displayName: 'Guest', avatar: '', username: '', role: '' };
    let isAdmin = false;
    let adminPass = ''; // สำหรับเก็บรหัสผ่านที่ Hashed เพื่อส่งต่อใน Admin Actions
    let current_question = {}; // Global variable to hold data of the currently viewed question
    let editImageArray = [];
    let editImageIndex = 0;

    let isMouseDown = false;
    let startCell = null;

    let isLoggedIn = false;
    let sectionId = null;
    let sectionName = null;
    let regAvatarBase64 = null;
        let regAvatarMimeType = null; 
    // ====================================================================
    // 2. INITIALIZATION (jQuery Ready & Core UI Bindings)
    // ====================================================================
    $(document).ready(function () {
        // --- 2.1 Image Gallery Controls Binding (Edit Modal) ---
        $('#prev-img-btn').click(() => {
            if (editImageArray.length > 0) {
                editImageIndex = (editImageIndex - 1 + editImageArray.length) % editImageArray.length;
                updateEditImageGallery();
            }
        });
        $('#next-img-btn').click(() => {
            if (editImageArray.length > 0) {
                editImageIndex = (editImageIndex + 1) % editImageArray.length;
                updateEditImageGallery();
            }
        });

        // --- 2.2 Responsive Sidebar Toggle Bindings ---
        $("#menu-toggle").on('click', function (e) {
            e.preventDefault();
            $("#wrapper").toggleClass("toggled");
        });

        $("#sidebar-close-btn").on('click', function (e) {
            e.preventDefault();
            $("#wrapper").removeClass("toggled");
        });

        // Click outside to close (Only on Mobile screens)
        $(document).on('click', '#page-content-wrapper', function (e) {
            if ($(window).width() < 768 && $("#wrapper").hasClass("toggled")) {
                if (!$(e.target).closest('#menu-toggle').length) {
                    $("#wrapper").removeClass("toggled");
                }
            }
        });

        // Initial Responsive State
        if ($(window).width() < 768) {
            $("#wrapper").removeClass("toggled");
        }

        // --- 2.3 Vote Modal Bindings ---
        $('#btn-open-vote').on('click', () => {
            $('#questionDetailModal').modal('hide');

            if (!current_question || !current_question.questionId) {
                Swal.fire('Error', 'ไม่พบข้อมูลข้อสอบ กรุณาลองใหม่', 'error');
                return;
            }

            let qText = current_question.problem || '';
            $('#vote-question-preview').text(qText.substring(0, 150) + (qText.length > 150 ? "..." : ""));

            renderCurrentCategory(current_question);
            fetchPendingVotes(current_question.questionId);

            $('#vote-rows-container').empty();
            addVoteRow();

            $('#vote-category-modal').css('display', 'flex');
        });

        $('#btn-close-vote-modal').on('click', () => $('#vote-category-modal').css('display', 'none'));
        $('#btn-add-vote-row').on('click', addVoteRow);
        $('#btn-submit-vote').on('click', () => {
            const votes = [];
            $('.vote-row').each(function () {
                const categoryId = $(this).find('.category-select').val();
                if (categoryId) {
                    const currentCategory = Array.isArray(current_question.category) ? current_question.category : [current_question.category];
                    if (!currentCategory.includes(categoryId)) {
                        votes.push(categoryId);
                    }
                }
            });

            const uniqueVotes = [...new Set(votes)];

            if (uniqueVotes.length === 0) {
                Swal.fire('Warning', "กรุณาเลือกหัวข้ออย่างน้อย 1 หัวข้อ (และต้องไม่ซ้ำกับหัวข้อเดิม)", 'warning');
                return;
            }

            submitVoteData(uniqueVotes);
        });

        // --- 2.4 Report Modal Bindings ---
        $('#cancel-report').on('click', () => $('#report-card').fadeOut());
        // #submit-report logic is large, so keep it inside document.ready but after global functions.
        $('#submit-report').on('click', async function () {

            // 1. ดึง Category ID และแปลงเป็น String
            let currentCategoryIds = current_question.category || [];
            let categoryString = Array.isArray(currentCategoryIds) ? currentCategoryIds.join(", ") : currentCategoryIds;

            // 2. หา "Subject" (วิชา) จาก Category ID
            let subjectFrom = "Unknown Subject";

            if (globalData.category && Array.isArray(currentCategoryIds) && currentCategoryIds.length > 0) {
                let firstCatId = String(currentCategoryIds[0]).trim();
                const matchedCategoryInfo = globalData.category.find(t => String(t.CategoryID) === firstCatId);

                if (matchedCategoryInfo && matchedCategoryInfo.SubjectRef) {
                    subjectFrom = matchedCategoryInfo.SubjectRef;
                }
            }

            // 3. ส่วนตรวจสอบ Input (Validation)
            const $select = $('#report-correct-choice-select');
            const $inputNew = $('#report-new-choice-input');
            const $reason = $('#report_text');

            const selectedVal = $select.val();
            const newVal = $inputNew.val().trim();
            const reasonVal = $reason.val().trim();

            if (selectedVal === 'newanswer' && !newVal) {
                Swal.fire('แจ้งเตือน', 'กรุณาพิมพ์คำตอบที่ถูกต้องใหม่ในช่องด้านล่าง', 'warning');
                setTimeout(() => $inputNew.focus(), 500);
                return;
            }

            if (reasonVal === '') {
                Swal.fire('แจ้งเตือน', 'กรุณาระบุเหตุผลของปัญหา', 'warning');
                setTimeout(() => $reason.focus(), 500);
                return;
            }

            // --- ส่วนจัดการข้อมูลก่อนส่ง (Data Processing) ---
            // 4. จัดการคำตอบที่เสนอ (Suggested Choice)
            let suggestedChoice = (selectedVal === 'newanswer') ? newVal : selectedVal;
            if (suggestedChoice && (suggestedChoice.includes('drive.google') || suggestedChoice.startsWith('http'))) {
                suggestedChoice = transformUrl(suggestedChoice);
            }

            // 5. จัดการรูปโจทย์ (Question Images)
            let questionImagesString = "";
            if (current_question.img) {
                const rawImgs = current_question.img.split("///");
                const processedImgs = rawImgs.map(url => transformUrl(url.trim()));
                questionImagesString = processedImgs.join("///");
            }

            // 6. จัดการตัวเลือกทั้งหมด (Format ให้ดูง่ายขึ้น)
            const allChoices = (current_question.choices || "").split("///").map((s, i) => {
                const letter = String.fromCharCode(65 + i);
                let choiceText = s.trim();
                const isCurrentAnswer = choiceText === (current_question.answer || "").trim();
                return `${letter}. ${isCurrentAnswer ? '(เฉลยปัจจุบัน) ' : ''}${choiceText}`;
            }).join("\n");

            // --- ส่วนการส่งข้อมูล (Fetch) ---
            const $btn = $(this);
            $btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Sending...');

            const reportData = {
                action: 'submitReport',
                from: subjectFrom,
                category: categoryString,
                question: current_question.problem,
                questionImages: questionImagesString,
                allChoices: allChoices,
                suggestedChoice: suggestedChoice,
                report: reasonVal
            };

            try {
                const response = await fetch(APPSCRIPT_URL, {
                    method: "POST",
                    redirect: "follow",
                    headers: { "Content-Type": "text/plain;charset=utf-8" },
                    body: JSON.stringify(reportData)
                });

                const resJson = await response.json();

                if (resJson.result === 'success') {
                    Swal.fire('สำเร็จ', 'ขอบคุณที่แจ้งปัญหา! ข้อมูลจะถูกส่งให้ทีมงานตรวจสอบ', 'success');
                    $('#report-card').fadeOut();
                    fetchData();
                } else {
                    throw new Error(resJson.error || 'Server reported error');
                }
            } catch (error) {
                console.error(error);
                Swal.fire('Error', 'ไม่สามารถส่งรายงานได้: ' + error.message, 'error');
            } finally {
                $btn.prop('disabled', false).text('ส่งรายงาน (Submit)');
            }
        });

        // --- 2.5 Initial Data & Table Setup ---
        initPublicTable();
        initAdminTable();
        //initStructureTables();
        setupConverterMultiEdit();

        fetchData();

        startVersionPolling();
    });

    // ====================================================================
    // 2.1 CONVERTER MULTI-EDIT LOGIC (NEW SECTION)
    // ====================================================================

    /**
     * ตั้งค่าเหตุการณ์สำหรับการเลือกหลายเซลล์และการแก้ไขพร้อมกันในตาราง Converter
     */
    function setupConverterMultiEdit() {
        const $tableBody = $('#tableBody');

        // 1. MOUSE DOWN: เริ่มการเลือก
        $tableBody.on('mousedown', '.editable-cell', function (e) {
            // ถ้าไม่ได้กด Ctrl/Shift ให้ล้างการเลือกเดิม
            if (!e.ctrlKey && !e.shiftKey) {
                $tableBody.find('.editable-cell').removeClass('selected-cell');
            }

            isMouseDown = true;
            startCell = this;
            $(this).addClass('selected-cell').focus();

            // ป้องกันการเลือกข้อความของ Browser
            e.preventDefault();
        });

        // 2. MOUSE OVER: ดำเนินการเลือกเมื่อลาก
        $tableBody.on('mouseover', '.editable-cell', function () {
            if (isMouseDown && startCell) {
                // เลือกเซลล์จาก startCell ถึงเซลล์ปัจจุบัน
                selectRange(startCell, this);
            }
        });

        // 3. MOUSE UP: สิ้นสุดการเลือก (บนเอกสารทั้งหมด)
        $(document).on('mouseup', function () {
            isMouseDown = false;
            startCell = null;
        });

        // 4. KEY DOWN: ใช้ Ctrl + Enter เพื่อ Apply ค่า
        $tableBody.on('keydown', '.editable-cell', function (e) {
            // Apply on Ctrl+Enter (หรือ Cmd+Enter บน Mac)
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                const newValue = $(this).text(); // ได้ค่าปัจจุบันที่พิมพ์อยู่ในเซลล์ที่ Focus
                applySelectionValue(newValue);
                e.preventDefault(); // ป้องกันการขึ้นบรรทัดใหม่
            }
        });

        // 5. คลิกที่อื่น หรือ Tab ไปที่อื่น (Clear Selection)
        $tableBody.on('blur', '.editable-cell', function () {
            // ถ้า focus ออกจาก cell ที่ถูกเลือกทั้งหมด
            setTimeout(() => {
                if (!$tableBody.find('.editable-cell:focus').length) {
                    $tableBody.find('.editable-cell').removeClass('selected-cell');
                }
            }, 10);
        });
    }
    /**
     * เลือกเซลล์ทั้งหมดภายในขอบเขตของ startCell และ endCell
     * @param {HTMLElement} startCell 
     * @param {HTMLElement} endCell 
     */
    function selectRange(start, end) {
        const $tableBody = $('#tableBody');

        // ล้างการเลือกเดิม (ถ้าไม่มี Ctrl/Shift)
        // Note: Logic for Ctrl/Shift is in mousedown, keep only range selection here
        $tableBody.find('.editable-cell').removeClass('selected-cell');

        const $start = $(start);
        const $end = $(end);

        // คำนวณ Index ของ Row (tr) และ Col (td ที่มี class editable-cell)
        const startRow = $start.closest('tr').index();
        const endRow = $end.closest('tr').index();
        const startCol = $start.index();
        const endCol = $end.index();

        const minRow = Math.min(startRow, endRow);
        const maxRow = Math.max(startRow, endRow);
        const minCol = Math.min(startCol, endCol);
        const maxCol = Math.max(startCol, endCol);

        // วนลูปและเลือกเซลล์ในขอบเขต
        $tableBody.find('tr').slice(minRow, maxRow + 1).each(function () {
            // editable-cell index เริ่มจาก 1 เพราะ td ตัวแรกเป็น index
            $(this).find('.editable-cell').slice(minCol - 1, maxCol).addClass('selected-cell');
        });

        // Ensure the cell that was last clicked/focused is selected
        $start.addClass('selected-cell');
        $end.addClass('selected-cell');
    }
    /**
     * นำค่า newValue ไปใส่ในทุกเซลล์ที่ถูกเลือก (selected-cell)
     * @param {string} newValue 
     */
    function applySelectionValue(newValue) {
        const $tableBody = $('#tableBody');
        const $selectedCells = $tableBody.find('.selected-cell');
        const selectedCount = $selectedCells.length;

        if (selectedCount > 1) {
            Swal.fire({
                title: 'ยืนยันการแก้ไขหลายช่อง?',
                text: `คุณกำลังจะกำหนดค่า "${newValue.substring(0, 50)}${newValue.length > 50 ? '...' : ''}" ให้กับ ${selectedCount} ช่องที่เลือก`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'ใช่, แก้ไขทั้งหมด',
                cancelButtonText: 'ยกเลิก'
            }).then((result) => {
                if (result.isConfirmed) {
                    // ใช้ .text() เพื่อ set ค่า
                    $selectedCells.each(function () {
                        $(this).text(newValue);
                    });

                    // ล้างการเลือกหลังจาก Apply ค่า
                    $tableBody.find('.selected-cell').removeClass('selected-cell');
                }
            });
        } else if (selectedCount === 1) {
            // ถ้าเลือกแค่ช่องเดียว แต่กด Ctrl+Enter ให้ล้างการเลือก
            $tableBody.find('.selected-cell').removeClass('selected-cell');
        }
    }
    
    // ====================================================================
    // 3. DATA FETCHING & SYNCHRONIZATION
    // ====================================================================

    const dbName = "MDKKU_Admin_DB";
        const storeName = "admin_cache";
            let versionCheckInterval = null;


        function openDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(dbName, 1);
                request.onupgradeneeded = (e) => {
                    const db = e.target.result;
                    if (!db.objectStoreNames.contains(storeName)) {
                        db.createObjectStore(storeName);
                    }
                };
                request.onsuccess = (e) => resolve(e.target.result);
                request.onerror = (e) => reject(e.target.error);
            });
        }

        async function setCacheDB(key, data) {
            const db = await openDB();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(storeName, "readwrite");
                const store = transaction.objectStore(storeName);
                store.put(data, key);
                transaction.oncomplete = () => resolve();
                transaction.onerror = (e) => reject(e.target.error);
            });
        }

        async function getCacheDB(key) {
            const db = await openDB();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(storeName, "readonly");
                const store = transaction.objectStore(storeName);
                const request = store.get(key);
                request.onsuccess = (e) => resolve(e.target.result);
                request.onerror = (e) => reject(e.target.error);
            });
        }

        // ฟังก์ชันล้าง Cache เมื่อ Admin ทำการแก้ไขข้อมูล
        async function clearAdminCache() {
            const db = await openDB();
            const transaction = db.transaction(storeName, "readwrite");
            transaction.objectStore(storeName).clear();
        }

    async function fetchData(forceRefresh = false) {
        const cacheKey = 'global_admin_data';
        const verKey = 'global_admin_ver';

        // แสดง Loading เฉพาะตอนโหลดครั้งแรก หรือตอนกด Refresh เอง
        if (forceRefresh || !globalData.questions || globalData.questions.length === 0) {
            $('#loading-overlay').css('display', 'flex');
        }

        try {
            // 1. ถาม Server ว่าเวอร์ชันล่าสุดคืออะไร
            const resVer = await fetch(`${APPSCRIPT_URL}?action=checkVersion`).then(r => r.json());
            const serverVersion = resVer.v;

            // 2. ดูว่าเรามี Cache อะไรอยู่บ้าง
            const [localData, localVer] = await Promise.all([
                getCacheDB(cacheKey),
                getCacheDB(verKey)
            ]);

            console.log(`Version Check: Server(${serverVersion}) vs Local(${localVer})`);

            // 3. เปรียบเทียบเวอร์ชัน
            if (!forceRefresh && localData && localVer === serverVersion) {
                console.log("✅ Data is up-to-date. Using Cache.");

                // โหลดข้อมูลจาก Cache เข้าตัวแปร
                globalData = localData;

                // อัปเดต UI
                finalizeDataLoading();

            } else {
                console.log("🔄 Data changed or Force Refresh. Fetching from Server...");

                // แจ้งเตือนเล็กน้อยถ้าเป็นการอัปเดตเบื้องหลัง (ไม่ใช่การโหลดครั้งแรก)
                if (!forceRefresh && globalData.questions && globalData.questions.length > 0) {
                    const Toast = Swal.mixin({
                        toast: true, position: 'top-end', showConfirmButton: false, timer: 3000
                    });
                    Toast.fire({ icon: 'info', title: 'พบข้อมูลใหม่ กำลังอัปเดต...' });
                }

                // ดึงข้อมูลทั้งหมดใหม่
                const response = await fetch(`${APPSCRIPT_URL}?action=getAllData`);
                const data = await response.json();

                // --- Data Processing (เหมือนเดิม) ---
                globalData.questions = (data.questions || []).map(q => {
                    if (typeof q.category === 'string' && q.category.startsWith('[')) {
                        try { q.category = JSON.parse(q.category.replace(/'/g, '"')); }
                        catch (e) { q.category = [q.category]; }
                    } else if (typeof q.category === 'string') {
                        q.category = [q.category];
                    }
                    return q;
                });

                globalData.report = (data.report || []).map(r => {
                    if (String(r.Done).toUpperCase() === 'TRUE' && r.Status === 'Pending') {
                        r.Status = 'Resolved';
                    }
                    return r;
                });

                globalData.structure = data.structure || [];
                globalData.category = data.category || [];
                globalData.votes = data.votes || [];
                globalData.logs = data.logs || [];
                globalData.admins = data.admins || [];


                // 4. บันทึกลง Cache และอัปเดตเวอร์ชัน
                await setCacheDB(cacheKey, globalData);
                await setCacheDB(verKey, serverVersion);

                finalizeDataLoading();

                if (!forceRefresh && $('#loading-overlay').is(':visible')) {
                    // ปิด overlay ถ้ามันเปิดอยู่
                } else {
                    // ถ้าเป็นการ update เบื้องหลัง ให้แจ้งเตือนเมื่อเสร็จ
                    const Toast = Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 2000 });
                    Toast.fire({ icon: 'success', title: 'อัปเดตข้อมูลล่าสุดแล้ว' });
                }
            }

        } catch (error) {
            console.error("Fetch Data Error:", error);
            Swal.fire('Error', 'ไม่สามารถโหลดข้อมูลได้: ' + error.message, 'error');
        } finally {
            $('#loading-overlay').hide();
        }
    }
    function finalizeDataLoading() {
            updateDashboard();
            populateFilters();
            renderReportList();
            refreshTables();

            if (!$('#sec-structure').hasClass('hidden')) {
                renderStructureTree($('#struct-subject-filter').val());
            }
        }
        function startVersionPolling() {
                if (versionCheckInterval) clearInterval(versionCheckInterval);

                // เช็คเวอร์ชันทุกๆ 60 วินาที
                versionCheckInterval = setInterval(() => {
                    // เรียก fetchData แบบไม่ Force Refresh (มันจะเช็คเวอร์ชันก่อน ถ้าตรงกันก็ไม่โหลดอะไรเพิ่ม)
                    console.log("Auto-checking for data updates...");
                    fetchData(false);
                }, 60000);
            }
    function refreshTables() {
        if ($.fn.DataTable.isDataTable('#publicTable')) {
            $('#publicTable').DataTable().clear().rows.add(globalData.questions).draw();
        }
        if ($.fn.DataTable.isDataTable('#adminTable')) {
            $('#adminTable').DataTable().clear().rows.add(globalData.questions).draw();
        }
        // structSubjectTable, structCategoryTable, logsTable handled below or in init

        if ($.fn.DataTable.isDataTable('#structSubjectTable')) {
            // ไม่ใช้ DataTables.clear().rows.add แต่ใช้ renderStructureTree
            renderStructureTree($('#struct-subject-filter').val());
        }
        if ($.fn.DataTable.isDataTable('#structCategoryTable')) {
            $('#structCategoryTable').DataTable().clear().rows.add(globalData.category).draw();
        }

        if ($.fn.DataTable.isDataTable('#logsTable')) {
            $('#logsTable').DataTable().clear().rows.add(globalData.logs || []).draw();
        }
        else {
            initLogsTable();
        }
    }

    function updateDashboard() {
            // 1. Stats Cards (คงเดิม)
            $('#stat-total-q').text(globalData.questions ? globalData.questions.length + " ข้อ" : "0 ข้อ");

            const pendingCount = (globalData.report || []).filter(r => !r.Done || String(r.Done).toUpperCase() === 'FALSE').length;
            $('#stat-pending-q').text(pendingCount + " รายการ");

            const $sidebarBadge = $('#sidebar-report-count');
            $sidebarBadge.text(pendingCount);
            pendingCount > 0 ? $sidebarBadge.show() : $sidebarBadge.hide();

            const resolvedCount = (globalData.report || []).filter(r => String(r.Done).toUpperCase() === 'TRUE').length;
            $('#stat-resolved-q').text(resolvedCount + " รายการ");

            // 2. Table Data: ดึงจาก Report เป็นหลัก (ตาม Requirement)
            const reports = (globalData.report || []).sort((a, b) => new Date(b.Time) - new Date(a.Time)); // ใหม่ไปเก่า

            // แสดงสูงสุด 20 รายการล่าสุด เพื่อไม่ให้โหลดหนักเกินไป
            const recentReports = reports.slice(0, 20);

            let html = '';

            if (recentReports.length === 0) {
                html = '<tr><td colspan="5" class="text-center text-muted py-4">ยังไม่มีประวัติการแจ้งปัญหา</td></tr>';
            } else {
                recentReports.forEach(r => {
                    // 1. วันที่
                    let dateStr = formatDate(r.Time);

                    // 2. ชื่อข้อสอบ & ลิงก์ Diff
                    // Logic: เอาเนื้อหาโจทย์จาก Report ไปหา QuestionID ใน DB -> แล้วเอา QuestionID ไปหา Log ล่าสุดเพื่อเอาค่า Old/New
                    let questionTextShort = r.Question ? r.Question.substring(0, 60) + (r.Question.length > 60 ? '...' : '') : '(ไม่ระบุโจทย์)';
                    let displayLink = `<span class="text-muted">${questionTextShort}</span>`;

                    // หา Question ID
                    const qObj = globalData.questions.find(q => q.problem.trim() === (r.Question || '').trim());

                    if (qObj) {
                        // ถ้าเจอโจทย์ใน DB ให้ไปหา Log การแก้ไขล่าสุดของโจทย์ข้อนี้
                        const relatedLog = (globalData.logs || []).find(l =>
                            l.TargetID === qObj.questionId &&
                            (String(l.ActionType).includes('EDIT') || String(l.ActionType).includes('UPDATE')) &&
                            (l.OldValue && l.NewValue) // ต้องมีข้อมูลเปรียบเทียบ
                        );

                        if (relatedLog) {
                            const oldValSafe = encodeURIComponent(relatedLog.OldValue);
                            const newValSafe = encodeURIComponent(relatedLog.NewValue);
                            displayLink = `<a href="#" class="question-link" onclick="viewDiff('${oldValSafe}', '${newValSafe}'); return false;" title="คลิกเพื่อดูประวัติการแก้ไข">
                                    <i class="fas fa-search me-1"></i> ${questionTextShort}
                                   </a>`;
                        }
                    }

                    // 3. Report Detail
                    let reportDetail = r.ReportDetail || r.SuggestedAnswer || '-';

                    // 4. Admin Note (การตอบกลับ)
                    let adminNote = r.AdminNote ? `<span class="text-primary">${r.AdminNote}</span>` : '-';

                    // 5. สถานะ
                    let statusBadge = '';
                    if (String(r.Done).toUpperCase() === 'TRUE') {
                        if (r.Status === 'Rejected') statusBadge = '<span class="badge bg-danger rounded-pill">Rejected</span>';
                        else statusBadge = '<span class="badge bg-success rounded-pill">Resolved</span>';
                    } else {
                        statusBadge = '<span class="badge bg-warning text-dark rounded-pill">Pending</span>';
                    }

                    html += `<tr>
                <td style="white-space:nowrap; font-size:0.85rem;">${dateStr}</td>
                <td>${displayLink}</td>
                <td><small>${reportDetail}</small></td>
                <td><small>${adminNote}</small></td>
                <td class="text-center">${statusBadge}</td>
            </tr>`;
                });
            }

            $('#dashboardRecentTable tbody').html(html);
        }
        function populateFilters() {
        // ... (โค้ด populateFilters เดิม) ...
        const subjects = [...new Set(globalData.structure.map(s => s.SubjectID))].sort();

        let subjOpts = '<option value="">All Subjects</option>';
        subjects.forEach(s => subjOpts += `<option value="${s}">${s}</option>`);

        $('#search-subject-filter, #db-subject-filter, #struct-subject-filter, #report-subject-filter').html(subjOpts);
        $('#new-category-subject').html('<option value="">-- Select Subject --</option>' + subjOpts.replace('All Subjects', ''));

        let categoryOpts = '<option value="">All Categories</option>';
        subjects.forEach(subj => {
            const catsInSubj = globalData.category.filter(c => c.SubjectRef === subj);

            if (catsInSubj.length > 0) {
                categoryOpts += `<optgroup label="${subj}">`;
                catsInSubj.forEach(t => {
                    categoryOpts += `<option value="${t.CategoryID}">${t.CategoryName} (${t.CategoryID})</option>`;
                });
                categoryOpts += `</optgroup>`;
            }
        });

        const orphanCats = globalData.category.filter(c => !c.SubjectRef || !subjects.includes(c.SubjectRef));
        if (orphanCats.length > 0) {
            categoryOpts += `<optgroup label="Others">`;
            orphanCats.forEach(t => {
                categoryOpts += `<option value="${t.CategoryID}">${t.CategoryName} (${t.CategoryID})</option>`;
            });
            categoryOpts += `</optgroup>`;
        }

        $('#search-category-filter, #db-category-filter').html(categoryOpts);

        let multiSelectOpts = '';
        globalData.category.forEach(t => {
            multiSelectOpts += `<option value="${t.CategoryID}">${t.CategoryName} (${t.CategoryID})</option>`;
        });
        $('#edit-category').html(multiSelectOpts);
        // ... (จบโค้ด populateFilters เดิม) ...
    }

    function updateCategoryDropdown(subjectId, targetSelector) {
        // ... (โค้ด updateCategoryDropdown เดิม) ...
        let options = '<option value="">All Categories</option>';

        const filteredCats = subjectId
            ? globalData.category.filter(c => c.SubjectRef === subjectId)
            : globalData.category;

        filteredCats.sort((a, b) => a.CategoryID.localeCompare(b.CategoryID));

        filteredCats.forEach(t => {
            options += `<option value="${t.CategoryID}">${t.CategoryName} (${t.CategoryID})</option>`;
        });

        $(targetSelector).html(options);
        // ... (จบโค้ด updateCategoryDropdown เดิม) ...
    }

    function getSubjectFromCategory(categoryId) {
        // ... (โค้ด getSubjectFromCategory เดิม) ...
        if (!categoryId || !globalData.category || globalData.category.length === 0) return '-';

        let tid = Array.isArray(categoryId) ? String(categoryId[0]) : String(categoryId);
        tid = tid.trim();

        let category = globalData.category.find(t =>
            String(t.CategoryID).trim().toLowerCase() === tid.toLowerCase()
        );

        return category ? category.SubjectRef : '-';
        // ... (จบโค้ด getSubjectFromCategory เดิม) ...
    }

    // ====================================================================
    // 4. TABLES INITIALIZATION
    // ====================================================================

    function initPublicTable() {
        // ... (โค้ด initPublicTable เดิม) ...
        if ($.fn.DataTable.isDataTable('#publicTable')) return;
        const table = $('#publicTable').DataTable({
            data: globalData.questions,
            columns: [
                {
                    data: 'subject',
                    defaultContent: '-',
                    render: function (data, type, row) {
                        return getSubjectFromCategory(row.category);
                    }
                },
                {
                    data: 'category',
                    defaultContent: '-',
                    render: function (data) {
                        return Array.isArray(data) ? data.join(', ') : data;
                    }
                },
                { data: 'problem', defaultContent: '' },
                {
                    data: 'img',
                    defaultContent: '',
                    render: function (data) {
                        if (!data) return '-';
                        let firstImg = data.split('///')[0];
                        return `<img src="${transformUrl(firstImg)}" class="img-preview-mini">`;
                    }
                },
                { data: 'answer', defaultContent: '' },
                {
                    data: null,
                    render: function (data, type, row) {
                        return `<button class="btn btn-sm btn-outline-secondary" onclick="showQuestionDetail('${row.questionId}')"><i class="fas fa-eye"></i></button>`;
                    }
                }
            ]
        });

        $('#search-subject-filter').on('change', function () {
            const selectedSubj = this.value;
            table.column(0).search(selectedSubj).draw();
            updateCategoryDropdown(selectedSubj, '#search-category-filter');
            table.column(1).search('').draw();
        });
        $('#search-category-filter').on('change', function () {
            table.column(1).search(this.value).draw();
        });
        // ... (จบโค้ด initPublicTable เดิม) ...
    }

    function initAdminTable() {
        // ... (โค้ด initAdminTable เดิม) ...
        if ($.fn.DataTable.isDataTable('#adminTable')) return;
        const table = $('#adminTable').DataTable({
            data: globalData.questions,
            columns: [
                {
                    data: 'subject',
                    defaultContent: '-',
                    render: function (data, type, row) {
                        return getSubjectFromCategory(row.category);
                    }
                },
                {
                    data: 'category',
                    render: function (data) {
                        if (!data) return '-';
                        return Array.isArray(data) ? data.join(', ') : data;
                    }
                },
                { data: 'problem', defaultContent: '' },
                {
                    data: 'img',
                    render: function (data) {
                        if (!data) return '-';
                        return `<img src="${transformUrl(data.split('///')[0])}" class="img-preview-mini">`;
                    }
                },
                { data: 'answer', defaultContent: '' },
                {
                    data: null,
                    render: function (data, type, row) {
                        return `<button class="btn btn-sm btn-primary" onclick="openEditModal('${row.questionId}')"><i class="fas fa-edit"></i></button>`;
                    }
                }
            ]
        });

        $('#db-subject-filter').on('change', function () {
            const selectedSubj = this.value;
            table.column(0).search(selectedSubj).draw();
            updateCategoryDropdown(selectedSubj, '#db-category-filter');
            table.column(1).search('').draw();
        });
        $('#db-category-filter').on('change', function () {
            table.column(1).search(this.value).draw();
        });
        // ... (จบโค้ด initAdminTable เดิม) ...
    }

    function initStructureTables() {
        // ... (โค้ด initStructureTables เดิม) ...
        if (!$.fn.DataTable.isDataTable('#structSubjectTable')) {
            const subjTable = $('#structSubjectTable').DataTable({
                data: globalData.structure,
                columns: [
                    { data: 'Year', defaultContent: '' },
                    { data: 'SubjectID', defaultContent: '' },
                    { data: 'SubjectName', defaultContent: '' },
                    { data: 'AccordionGroup', defaultContent: '' },
                    { data: null, defaultContent: '-' }
                ]
            });

            $('#struct-subject-filter').on('change', function () {
                subjTable.column(1).search(this.value).draw();
            });
        }

        if (!$.fn.DataTable.isDataTable('#structCategoryTable')) {
            $('#structCategoryTable').DataTable({
                data: globalData.category,
                columns: [
                    { data: 'CategoryID', defaultContent: '' },
                    { data: 'SubjectRef', defaultContent: '' },
                    { data: 'AccordionGroup', defaultContent: '' },
                    { data: 'CategoryName', defaultContent: '' },
                    { data: null, defaultContent: '-' }
                ]
            });
        }
        // ... (จบโค้ด initStructureTables เดิม) ...
    }

    function initLogsTable() {
        if ($.fn.DataTable.isDataTable('#logsTable')) {
            $('#logsTable').DataTable().clear().rows.add(globalData.logs).draw();
            return;
        }
        $('#logsTable').DataTable({
            data: globalData.logs,
            order: [[0, 'desc']], // เรียงตามเวลาล่าสุด
            columns: [
                {
                    data: 'Timestamp',
                    width: '15%',
                    render: function (data) { return formatDate(data); }
                },
                { data: 'User', width: '10%' },
                {
                    data: 'ActionType',
                    width: '10%',
                    render: function (data) {
                        let badge = 'bg-secondary';
                        const upper = String(data).toUpperCase();
                        if (upper.includes('EDIT') || upper.includes('UPDATE')) badge = 'bg-warning text-dark';
                        if (upper.includes('DELETE') || upper.includes('REJECT')) badge = 'bg-danger';
                        if (upper.includes('ADD') || upper.includes('IMPORT') || upper.includes('REGISTER')) badge = 'bg-success';
                        return `<span class="badge ${badge}">${data}</span>`;
                    }
                },
                { data: 'TargetID', width: '15%' },
                {
                    data: 'Details',
                    width: '35%'
                },
                {
                    // ปุ่มดูความเปลี่ยนแปลง
                    data: null,
                    width: '15%',
                    render: function (data, type, row) {
                        // เช็คว่ามีข้อมูลเปรียบเทียบหรือไม่
                        if ((row.OldValue && row.OldValue !== "") || (row.NewValue && row.NewValue !== "")) {
                            // เก็บข้อมูลไว้ใน data attribute เพื่อดึงไปใช้ตอนคลิก
                            // ต้อง Encode JSON เพื่อป้องกัน error เครื่องหมายคำพูด
                            const oldValSafe = encodeURIComponent(row.OldValue);
                            const newValSafe = encodeURIComponent(row.NewValue);
                            return `<button class="btn btn-sm btn-outline-info" onclick="viewDiff('${oldValSafe}', '${newValSafe}')">
                                    <i class="fas fa-eye"></i> ดูส่วนที่แก้
                                </button>`;
                        }
                        return '-';
                    }
                }
            ]
        });
    }

function viewDiff(oldValEnc, newValEnc) {
    let oldRaw = {}, newRaw = {};
    

    // 1. Decode & Parse JSON
    try { oldRaw = JSON.parse(decodeURIComponent(oldValEnc)); } catch(e) { oldRaw = decodeURIComponent(oldValEnc); }
    try { newRaw = JSON.parse(decodeURIComponent(newValEnc)); } catch(e) { newRaw = decodeURIComponent(newValEnc); }

    // 2. Normalize Data (แปลง Key ให้เป็นมาตรฐานเดียวกัน เพื่อเปรียบเทียบง่าย)
    const oldObj = normalizeData(oldRaw);
    const newObj = normalizeData(newRaw);

    // 3. Render แต่ละฝั่ง
    $('#diff-container-old').html(renderDiffPanel(oldObj, newObj));
    $('#diff-container-new').html(renderDiffPanel(newObj, oldObj));

    $('#diffModal').modal('show');
}

/**
 * แปลง Key ต่างๆ (Problem, problem, QuestionID, id) ให้เป็นมาตรฐานเดียวกัน
 */
function normalizeData(obj) {
    if (!obj || typeof obj !== 'object') return {};
    
    // Helper แปลง Category String เป็น Array
    let cats = obj.category || obj.Category || [];
    if (typeof cats === 'string') {
        try { cats = JSON.parse(cats); } catch(e) { cats = [cats]; }
    }

    return {
        id: obj.id || obj.QuestionID || obj.questionId || '-',
        problem: obj.problem || obj.Problem || '',
        img: obj.img || obj.Image || '',
        choices: obj.choices || obj.Choices || '',
        answer: obj.answer || obj.Answer || '',
        explain: obj.explain || obj.Explanation || '',
        category: cats
    };
}
    function renderDiffPanel(data, compare) {
        // 1. Header (ID & Category)
        // เทียบ Category (แปลงเป็น string ก่อนเทียบ)
        const catStr = Array.isArray(data.category) ? data.category.join(', ') : String(data.category);
        const compareCatStr = Array.isArray(compare.category) ? compare.category.join(', ') : String(compare.category);
        const isCatChanged = catStr !== compareCatStr;
        const catClass = isCatChanged ? 'diff-changed' : '';

        let html = `
        <h5 class="mb-3">
            <span class="badge bg-secondary me-1">${data.id}</span>
            <span class="badge bg-primary ${catClass}">${catStr || 'No Category'}</span>
        </h5>
    `;

        // 2. Problem Text
        const isProbChanged = data.problem !== compare.problem;
        const probClass = isProbChanged ? 'diff-changed' : '';
        html += `<p class="lead mt-3 ${probClass}" style="font-weight: 500;">${escapeHtml(data.problem) || '-'}</p>`;

        // 3. Images
        const isImgChanged = data.img !== compare.img;
        const imgClass = isImgChanged ? 'diff-changed' : '';
        html += `<div class="text-center mb-3 p-2 ${imgClass}">`;
        if (data.img) {
            const imgs = data.img.split('///').filter(Boolean);
            imgs.forEach(url => {
                html += `<img src="${transformUrl(url)}" class="img-fluid mb-2 border rounded" style="max-height:200px;">`;
            });
        } else {
            html += `<span class="text-muted small font-italic">- ไม่มีรูปภาพ -</span>`;
        }
        html += `</div>`;

        // 4. Choices
        html += `<div class="list-group mb-3">`;

        const choices = (data.choices || "").split('///').map(s => s.trim());
        const compareChoices = (compare.choices || "").split('///').map(s => s.trim());
        const correctAns = (data.answer || "").trim();

        // วนลูปสร้าง Choice (อย่างน้อย 4 ข้อ ถ้าไม่มีข้อมูล)
        const count = Math.max(choices.length, 4);
        for (let i = 0; i < count; i++) {
            const txt = choices[i] || "";
            const compareTxt = compareChoices[i] || "";

            let classes = "list-group-item diff-choice-item";

            // เช็คว่าเฉลยถูกหรือไม่
            if (txt !== "" && txt === correctAns) {
                classes += " diff-correct"; // สีเขียว
            }

            // เช็คว่าข้อความเปลี่ยนหรือไม่
            if (txt !== compareTxt) {
                classes += " diff-changed"; // สีเหลือง (Changed)
            }

            const prefix = String.fromCharCode(65 + i) + ". ";
            html += `<div class="${classes}">${prefix}${escapeHtml(txt) || '<span class="text-muted font-italic">(ว่าง)</span>'}</div>`;
        }
        html += `</div>`;

        // 5. Explanation
        const isExplainChanged = data.explain !== compare.explain;
        const explainClass = isExplainChanged ? 'diff-changed' : '';

        html += `<div class="alert alert-secondary ${explainClass}">
                <strong>Explanation:</strong> 
                <span class="d-block mt-1">${escapeHtml(data.explain) || '-'}</span>
             </div>`;

        return html;
    }        

    // Helper ป้องกัน XSS
    function escapeHtml(text) {
        if (!text) return text;
        return text
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    // ====================================================================
    // 5. QUESTION VIEW & EDIT MODALS
    // ====================================================================

    function showQuestionDetail(id) {
        // ... (โค้ด showQuestionDetail เดิม) ...
        const q = globalData.questions.find(x => x.questionId == id);
        if (!q) return;

        current_question = q;

        let cat = Array.isArray(q.category) ? q.category.join(', ') : q.category;
        let subj = getSubjectFromCategory(q.category);
        $('#modal-q-subject').text(subj);
        $('#modal-q-category').text(cat);

        $('#modal-q-text').text(q.problem);

        let imgHtml = '';
        if (q.img) {
            q.img.split('///').forEach(url => {
                imgHtml += `<img src="${transformUrl(url)}" class="img-fluid mb-2" style="max-height:300px;">`;
            });
        }
        $('#modal-q-img-container').html(imgHtml);

        let choiceHtml = '';
        if (q.choices) {
            q.choices.split('///').forEach(c => {
                let isCorrect = (c.trim().replace(/^[A-Z]\./, '').trim() === q.answer.trim().replace(/^[A-Z]\./, '').trim()) ? 'list-group-item-success' : '';
                choiceHtml += `<div class="list-group-item ${isCorrect}">${c}</div>`;
            });
        }
        $('#modal-q-choices').html(choiceHtml);
        $('#modal-q-explain').text(q.explain || '-');

        $('#btn-modal-report').off('click').on('click', function () {
            $('#questionDetailModal').modal('hide');
            openReportModal(q);
        });

        $('#questionDetailModal').modal('show');
        // ... (จบโค้ด showQuestionDetail เดิม) ...
    }

    function openEditModal(id, suggestedAnswer = null) {
        // ... (โค้ด openEditModal เดิม) ...
        const q = globalData.questions.find(x => x.questionId == id);
        if (!q) return;

        $('#edit-q-id').val(q.questionId);

        let currentCategories = Array.isArray(q.category) ? q.category : [q.category];
        renderCategoriesUI(currentCategories);

        $('#edit-problem').val(q.problem);
        $('#edit-explanation').val(q.explain);

        renderImagesUI(q.img);
        renderChoicesUI(q.choices, q.answer, suggestedAnswer);

        $('#editQuestionModal').modal('show');
        // ... (จบโค้ด openEditModal เดิม) ...
    }

    async function saveQuestionChanges() {
        // ... (โค้ด saveQuestionChanges เดิม) ...
        if (!confirmAdmin()) return;

        const qId = $('#edit-q-id').val();
        const originalQuestionData = globalData.questions.find(q => q.questionId == qId);
        const originalProblemText = originalQuestionData ? originalQuestionData.problem.trim() : "";

        const categoryString = $('#edit-category-hidden').val();
        let categoryArray = [];
        try {
            categoryArray = JSON.parse(categoryString);
        } catch (e) {
            console.error("Error parsing categories:", e);
            categoryArray = [];
        }

        const payload = {
            id: qId,
            problem: $('#edit-problem').val(),
            img: $('#edit-img').val(),
            choices: $('#edit-choices').val(),
            answer: $('#edit-answer').val(),
            explain: $('#edit-explanation').val(),
            category: categoryArray
        };

        await sendAdminAction('editQuestion', payload);

        try {
            const reportData = $('#editQuestionModal').data('reportData');

            if (reportData) {
                const reportPayload = {
                    action: 'updateReportStatus',
                    username: currentUser.username,
                    adminPass: adminPass,
                    data: {
                        timestamp: reportData.timestamp,
                        adminNote: reportData.adminNote,
                        status: 'Resolved',
                        done: 'TRUE'
                    }
                };

                await fetch(APPSCRIPT_URL, {
                    method: 'POST',
                    redirect: "follow",
                    headers: { "Content-Type": "text/plain" },
                    body: JSON.stringify(reportPayload)
                });

                console.log('Report auto-resolved successfully.');
                $('#editQuestionModal').removeData('reportData');
            } else {
                const pendingReports = (globalData.report || []).filter(r =>
                    r['Question'] && r['Question'].trim() === originalProblemText &&
                    (!r['Done'] || String(r['Done']).toUpperCase() === 'FALSE')
                );

                if (pendingReports.length > 0) {
                    for (const rep of pendingReports) {
                        const fallbackPayload = {
                            action: 'updateReportStatus',
                            adminPass: adminPass,
                            data: {
                                timestamp: rep['Time'],
                                adminNote: 'Auto-resolved via question edit',
                                status: 'Resolved',
                                done: 'TRUE'
                            }
                        };

                        fetch(APPSCRIPT_URL, {
                            method: 'POST',
                            redirect: "follow",
                            headers: { "Content-Type": "text/plain" },
                            body: JSON.stringify(fallbackPayload)
                        }).catch(e => console.error("Auto-resolve failed:", e));
                    }
                    console.log(`Auto-resolved ${pendingReports.length} reports.`);
                }
            }
        } catch (e) {
            console.error('Error in auto-resolve logic:', e);
        }

        $('#editQuestionModal').modal('hide');
        fetchData();
        // ... (จบโค้ด saveQuestionChanges เดิม) ...
    }

    async function deleteQuestion() {
        // ... (โค้ด deleteQuestion เดิม) ...
        if (!confirmAdmin()) return;
        if (!confirm('Are you sure you want to DELETE this question?')) return;

        const payload = { id: $('#edit-q-id').val() };
        await sendAdminAction('deleteQuestion', payload);
        $('#editQuestionModal').modal('hide');
        // ... (จบโค้ด deleteQuestion เดิม) ...
    }

    // Image Preview & Gallery Logic
    function previewEditImage() {
        // ... (โค้ด previewEditImage เดิม) ...
        const url = $('#edit-img').val();
        if (url) {
            $('#edit-img-preview').attr('src', transformUrl(url.split('///')[0]));
            $('#edit-img-preview-box').removeClass('d-none');
        } else {
            $('#edit-img-preview-box').addClass('d-none');
        }
        // ... (จบโค้ด previewEditImage เดิม) ...
    }

    const handleImageInput = () => {
        // ... (โค้ด handleImageInput เดิม) ...
        const rawUrl = $('#edit-img').val();
        if (!rawUrl) {
            editImageArray = [];
            $('#edit-image-gallery-container').hide();
            return;
        }
        editImageArray = rawUrl.split('///').map(u => u.trim()).filter(u => u !== "");
        editImageIndex = 0;
        updateEditImageGallery();
        // ... (จบโค้ด handleImageInput เดิม) ...
    };

    const updateEditImageGallery = () => {
        // ... (โค้ด updateEditImageGallery เดิม) ...
        const $container = $('#edit-image-gallery-container');
        const $img = $('#edit-gallery-img');
        const $prevBtn = $('#prev-img-btn');
        const $nextBtn = $('#next-img-btn');
        const $counter = $('#image-counter');

        if (editImageArray.length === 0) {
            $container.hide();
            return;
        }

        $container.show();
        $img.attr('src', transformUrl(editImageArray[editImageIndex]));

        if (editImageArray.length > 1) {
            $prevBtn.show();
            $nextBtn.show();
            $counter.show().text(`${editImageIndex + 1} / ${editImageArray.length}`);
        } else {
            $prevBtn.hide();
            $nextBtn.hide();
            $counter.hide();
        }
        // ... (จบโค้ด updateEditImageGallery เดิม) ...
    };


    // ====================================================================
    // 6. QUESTION CONTENT (Choices & Images) LOGIC
    // ====================================================================

    // --- Category Logic ---
    function renderCategoriesUI(categoryArray) {
        const $container = $('#dynamic-categories-container');
        $container.empty();

        const categories = Array.isArray(categoryArray) ? categoryArray : [categoryArray];

        if (categories.length === 0 || categories[0] === '-' || categories[0] === '') {
            _renderNewCategoryRow(); // <--- เรียกฟังก์ชัน Internal
        } else {
            categories.forEach(categoryId => {
                if (categoryId && categoryId !== '-') {
                    _renderNewCategoryRow(categoryId); // <--- เรียกฟังก์ชัน Internal
                }
            });
        }
        syncCategoriesToHiddenInput();
    }

    function _renderNewCategoryRow(selectedCategoryID = null) {
        const $container = $('#dynamic-categories-container');
        const subjects = [...new Set(globalData.category.map(c => c.SubjectRef))].filter(s => s);

        // 1. สร้าง Option สำหรับ Subject
        let subjectOptions = `<option value="">-- เลือกวิชา --</option>`;
        subjects.sort().forEach(s => {
            subjectOptions += `<option value="${s}">${s}</option>`;
        });

        // 2. หา Subject/Group ของ Category ที่เลือกไว้ (ถ้ามี)
        let selectedSubject = '';
        let selectedGroup = '';
        let categoryName = '';
        if (selectedCategoryID) {
            const cat = globalData.category.find(c => c.CategoryID === selectedCategoryID);
            if (cat) {
                selectedSubject = cat.SubjectRef;
                selectedGroup = cat.AccordionGroup;
                categoryName = cat.CategoryName;
            }
        }

        const rowHtml = `
            <div class="category-row d-flex gap-2 align-items-center bg-light p-2 rounded">
                <select class="form-select form-select-sm category-subject-select" onchange="updateGroupSelect(this)" style="flex: 1;">
                    ${subjectOptions}
                </select>
                <select class="form-select form-select-sm category-group-select" onchange="updateCategorySelect(this)" style="flex: 1;">
                    <option value="">-- กลุ่ม --</option>
                </select>
                <select class="form-select form-select-sm category-id-select" onchange="syncCategoriesToHiddenInput()" style="flex: 2;">
                    <option value="">-- หัวข้อ/Category --</option>
                </select>
                <button class="btn btn-sm btn-outline-danger" type="button" onclick="removeCategoryRow(this)">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;
        const $row = $(rowHtml);

        // 3. ตั้งค่า Selected Subject และเรียกฟังก์ชัน Update Group/Category
        if (selectedSubject) {
            $row.find('.category-subject-select').val(selectedSubject).trigger('change');

            // ตั้งค่า Selected Group
            if (selectedGroup) {
                // ต้องรอให้ Group Select ถูก Populate ก่อน
                setTimeout(() => {
                    $row.find('.category-group-select').val(selectedGroup).trigger('change');

                    // ตั้งค่า Selected CategoryID
                    if (selectedCategoryID) {
                        setTimeout(() => {
                            $row.find('.category-id-select').val(selectedCategoryID);
                            syncCategoriesToHiddenInput();
                        }, 50);
                    }
                }, 50);
            }
        }

        $container.append($row);
    }

    function removeCategoryRow(btn) {
        $(btn).closest('.category-row').remove();
        syncCategoriesToHiddenInput();
    }

    function updateGroupSelect(selectElement) {
        const $subjectSelect = $(selectElement);
        const subjId = $subjectSelect.val();
        const $groupSelect = $subjectSelect.closest('.category-row').find('.category-group-select');
        const $catSelect = $subjectSelect.closest('.category-row').find('.category-id-select');

        $groupSelect.empty().append('<option value="">-- กลุ่ม --</option>');
        $catSelect.empty().append('<option value="">-- หัวข้อ/Category --</option>');

        if (subjId) {
            const relatedCategory = globalData.category.filter(t => t.SubjectRef === subjId);
            const groups = [...new Set(relatedCategory.map(t => t.AccordionGroup))].filter(g => g);

            groups.sort().forEach(g => {
                $groupSelect.append(`<option value="${g}">${g}</option>`);
            });
        }
        syncCategoriesToHiddenInput();
    }

    function updateCategorySelect(selectElement) {
        const $groupSelect = $(selectElement);
        const groupName = $groupSelect.val();
        const $row = $groupSelect.closest('.category-row');
        const subjId = $row.find('.category-subject-select').val();
        const $categorySelect = $row.find('.category-id-select');

        $categorySelect.empty().append('<option value="">-- หัวข้อ/Category --</option>');

        if (groupName && subjId) {
            const categories = globalData.category.filter(t => t.SubjectRef === subjId && t.AccordionGroup === groupName);
            categories.sort((a, b) => a.CategoryName.localeCompare(b.CategoryName));
            categories.forEach(t => {
                $categorySelect.append(`<option value="${t.CategoryID}">${t.CategoryName} (${t.CategoryID})</option>`);
            });
        }
        syncCategoriesToHiddenInput();
    }

    function addNewCategoryRow() {
        _renderNewCategoryRow(null);
    }

    function syncCategoriesToHiddenInput() {
        const categories = [];
        $('#dynamic-categories-container .category-id-select').each(function () {
            const val = $(this).val();
            if (val && val !== "") {
                categories.push(val);
            }
        });
        // เก็บเป็น Stringified Array เพื่อส่งไป Backend
        $('#edit-category-hidden').val(JSON.stringify(categories));
    }

    // --- Choice Logic ---
    function renderChoicesUI(choicesStr, correctAnsStr, suggestedAnsStr = null) {
        // ... (โค้ด renderChoicesUI เดิม) ...
        const $container = $('#dynamic-choices-container');
        $container.empty();

        let choices = (choicesStr || "").split('///').map(c => c.trim()).filter(c => c !== "");
        if (choices.length === 0) choices = ["A. ", "B. ", "C. ", "D. "];

        const cleanCorrect = (correctAnsStr || "").trim();
        const cleanSuggested = (suggestedAnsStr || "").trim();

        choices.forEach((choiceText) => {
            const isOriginalCorrect = (choiceText === cleanCorrect);
            const isSuggested = (cleanSuggested !== "" && choiceText === cleanSuggested);
            addChoiceRow(choiceText, isOriginalCorrect, isSuggested);
        });

        if (suggestedAnsStr && !choices.includes(cleanSuggested)) {
            $container.prepend(`
                <div class="alert alert-warning small py-2 mb-2">
                    <i class="fas fa-exclamation-triangle"></i>
                    คำตอบที่เสนอมาคือ: <strong>"${cleanSuggested}"</strong> (ไม่มีในตัวเลือกเดิม)
                </div>
             `);
        }

        syncChoicesToHiddenInput();
        // ... (จบโค้ด renderChoicesUI เดิม) ...
    }

    function addChoiceRow(value = "", isOriginalCorrect = false, isSuggested = false) {
        // ... (โค้ด addChoiceRow เดิม) ...
        const $container = $('#dynamic-choices-container');

        let rowClass = "";
        let badges = "";

        if (isSuggested) {
            rowClass += " suggested-choice";
            badges += `<span class="badge bg-success ms-2"><i class="fas fa-star"></i> Suggested</span>`;
        }

        if (isOriginalCorrect) {
            if (!isSuggested) rowClass += " original-choice";
            badges += `<span class="badge bg-secondary ms-1">Current ans</span>`;
        }

        const isChecked = isOriginalCorrect; // ติ๊ก Original ไว้ก่อน

        const rowHtml = `
            <div class="choice-item ${rowClass}">
                <div class="choice-input-group">
                    <div class="form-check d-flex align-items-center">
                        <input class="form-check-input choice-radio" type="radio" name="correct_answer_group" ${isChecked ? 'checked' : ''}>
                    </div>
                    <input type="text" class="form-control choice-text-input" value="${value}" placeholder="ตัวเลือก..." oninput="syncChoicesToHiddenInput()">
    
                    <div style="white-space: nowrap;">${badges}</div>
    
                    <i class="fas fa-minus-circle btn-remove-choice ms-2" title="ลบตัวเลือก" onclick="removeChoiceRow(this)"></i>
                </div>
            </div>
        `;
        $container.append(rowHtml);

        $('.choice-radio').off('change').on('change', syncChoicesToHiddenInput);
        // ... (จบโค้ด addChoiceRow เดิม) ...
    }

    function removeChoiceRow(btn) {
        // ... (โค้ด removeChoiceRow เดิม) ...
        $(btn).closest('.choice-item').remove();
        syncChoicesToHiddenInput();
        // ... (จบโค้ด removeChoiceRow เดิม) ...
    }

    function addNewChoiceRow() {
        // ... (โค้ด addNewChoiceRow เดิม) ...
        addChoiceRow("");
        // ... (จบโค้ด addNewChoiceRow เดิม) ...
    }

    function syncChoicesToHiddenInput() {
        // ... (โค้ด syncChoicesToHiddenInput เดิม) ...
        const choices = [];
        let correctAnswer = "";

        $('#dynamic-choices-container .choice-item').each(function () {
            const textVal = $(this).find('.choice-text-input').val();
            const isChecked = $(this).find('.choice-radio').is(':checked');

            if (textVal.trim() !== "") {
                choices.push(textVal);
                if (isChecked) {
                    correctAnswer = textVal;
                }
            }
        });
        $('#edit-choices').val(choices.join('///'));
        $('#edit-answer').val(correctAnswer);
        // ... (จบโค้ด syncChoicesToHiddenInput เดิม) ...
    }

    // --- Image Logic ---
    function renderImagesUI(imgStr) {
        // ... (โค้ด renderImagesUI เดิม) ...
        const $container = $('#dynamic-images-container');
        $container.empty();

        let images = (imgStr || "").split('///').map(u => u.trim()).filter(u => u !== "");

        if (images.length === 0) {
            addImageRow("");
        } else {
            images.forEach(url => {
                addImageRow(url);
            });
        }

        syncImagesToHiddenInput();
        // ... (จบโค้ด renderImagesUI เดิม) ...
    }

    function addImageRow(value = "") {
        // ... (โค้ด addImageRow เดิม) ...
        const $container = $('#dynamic-images-container');

        const rowHtml = `
            <div class="image-input-item">
                <div class="input-group">
                    <span class="input-group-text bg-light"><i class="fas fa-image text-secondary"></i></span>
                    <input type="text" class="form-control image-url-input" value="${value}" placeholder="วาง URL รูปภาพ..." oninput="syncImagesToHiddenInput()">
                    <button class="btn btn-outline-danger" type="button" onclick="removeImageRow(this)" title="ลบรูปนี้">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </div>
            </div>
        `;
        $container.append(rowHtml);
        // ... (จบโค้ด addImageRow เดิม) ...
    }

    function addNewImageRow() {
        // ... (โค้ด addNewImageRow เดิม) ...
        addImageRow("");
        // ... (จบโค้ด addNewImageRow เดิม) ...
    }

    function removeImageRow(btn) {
        // ... (โค้ด removeImageRow เดิม) ...
        const rowCount = $('#dynamic-images-container .image-input-item').length;
        if (rowCount <= 1) {
            $(btn).closest('.image-input-item').find('input').val('');
        } else {
            $(btn).closest('.image-input-item').remove();
        }
        syncImagesToHiddenInput();
        // ... (จบโค้ด removeImageRow เดิม) ...
    }

    function syncImagesToHiddenInput() {
        // ... (โค้ด syncImagesToHiddenInput เดิม) ...
        const imgUrls = [];

        $('#dynamic-images-container .image-url-input').each(function () {
            const val = $(this).val().trim();
            if (val !== "") {
                imgUrls.push(val);
            }
        });

        $('#edit-img').val(imgUrls.join('///'));

        editImageArray = imgUrls;
        editImageIndex = 0;
        updateEditImageGallery();
        // ... (จบโค้ด syncImagesToHiddenInput เดิม) ...
    }


    // ====================================================================
    // 7. REPORT INBOX SYSTEM
    // ====================================================================

    function renderReportList() {
        // ... (โค้ด renderReportList เดิม) ...
        const container = $('#report-list-container');
        container.empty();

        const filterSubj = $('#report-subject-filter').val();
        const pending = globalData.report.filter(r => !r.Done || r.Done.toString().toUpperCase() === 'FALSE');

        let filteredReports = pending;
        if (filterSubj) {
            const cleanFilterSubj = filterSubj.toUpperCase(); // แปลง Subject ID ที่เลือกให้เป็นตัวพิมพ์ใหญ่

            filteredReports = pending.filter(r => {
                const reportFrom = String(r['From'] || "").trim().toUpperCase(); // ดึงค่าจาก 'From' และแปลงเป็นตัวพิมพ์ใหญ่

                return reportFrom === cleanFilterSubj;
            });

        }

        console.log(`Rendering ${filteredReports.length} reports (Filtered by subject: ${filterSubj || 'None'})`);

        if (filteredReports.length === 0) {
            container.html('<div class="text-center text-muted py-5"><i class="fas fa-check-circle fa-3x text-success mb-3"></i><br>ไม่มีรายการแจ้งปัญหาใหม่</div>');
            return;
        }

        filteredReports.forEach((r, index) => {
            let reportDetail = r['ReportDetail'] || '-';
            let suggested = r['SuggestedAnswer'] || '-';

            let dbQuestion = globalData.questions.find(q => q.problem.trim() === (r['Question'] || '').trim()) || {};

            let currentAns = dbQuestion.answer || 'ไม่พบข้อมูลใน DB';
            let explanation = dbQuestion.explain || '(ไม่มีคำอธิบาย)';
            let choicesStr = r['Choices'] ? r['Choices'].replace(/\n/g, '<br>') : '-';

            let imgHtml = '';
            let rawImg = String(r['Image'] || "").trim();
            if (rawImg && (rawImg.startsWith('http') || rawImg.startsWith('https'))) {
                let url = (rawImg.match(/"([^"]+)"/) && rawImg.match(/"([^"]+)"/)[1]) ? rawImg.match(/"([^"]+)"/)[1] : rawImg;
                url = transformUrl(url);

                imgHtml = `<div class="my-2 text-center">
                            <a href="${url}" target="_blank">
                                <img src="${url}" class="img-thumbnail" style="max-height: 150px;" alt="Q Img">
                            </a>
                        </div>`;
            } else if (rawImg.length > 0) {
                imgHtml = `<div class="alert alert-warning py-1 small"><i class="fas fa-exclamation-triangle"></i> ข้อมูลรูปภาพ: ${rawImg}</div>`;
            }

            let card = `
            <div class="card mb-4 shadow-sm border-0 bg-white" style="border-left: 4px solid #e74a3b !important;">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8 border-end">
                            <h5 class="text-primary fw-bold">
                                <i class="fas fa-hashtag me-1"></i> ${r['Category'] || 'Unknown Category'}
                                <small class="text-muted fs-6 float-end"><i class="far fa-clock"></i> ${formatDate(r['Time'])}</small>
                            </h5>
    
                            <div class="p-3 bg-light rounded mb-2">
                                <p class="mb-2"><strong>Question:</strong> ${r['Question']}</p>
                                ${imgHtml}
                                <p class="mb-2 small text-secondary"><strong>Choices:</strong><br><pre style="white-space: pre-wrap; margin:0; font-family:inherit;">${choicesStr}</pre></p>
                            </div>
            
                            <div class="d-flex gap-3">
                                <div class="text-success">
                                    <strong><i class="fas fa-check-circle"></i> Current Answer:</strong> ${currentAns}
                                </div>
                            </div>
                            <p class="mt-2 small text-muted"><strong>Explanation:</strong> ${explanation}</p>
                            <p class="small text-muted mb-0">Reported by: ${r['From']}</p>
                        </div>
    
                        <div class="col-md-4">
                             <div class="diff-box diff-suggest h-100 d-flex flex-column">
                                <div class="diff-label text-danger fw-bold border-bottom pb-2 mb-2">
                                    <i class="fas fa-exclamation-circle"></i> ReportDetail
                                </div>

                                <p class="mb-1"><strong>Suggested Answer:</strong> <span class="text-primary fw-bold">${suggested}</span></p>
                                <p class="mb-3"><strong>Reason:</strong> ${reportDetail}</p>
    
                                <div class="mt-auto">
                                    <label class="small fw-bold mb-1">Admin Note (บันทึกการแก้ไข):</label>
                                    <textarea id="admin-note-${index}" class="form-control form-control-sm mb-2" rows="2"
                                        placeholder="เช่น แก้ไขแล้ว, หรือ ปฏิเสธเนื่องจาก...">${r['AdminNote'] || ''}</textarea>
    
                                    <div class="d-flex gap-2">
                                        <button class="btn btn-outline-secondary btn-sm flex-fill" onclick="processReport(${index}, 'REJECT')">
                                            <i class="fas fa-times"></i> Reject
                                        </button>
                                        <button class="btn btn-success btn-sm flex-fill" onclick="openEditReportModal(${index})">
                                            <i class="fas fa-edit"></i> Edit & Approve
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>`;
            container.append(card);
        });
        // ... (จบโค้ด renderReportList เดิม) ...
    }

    function openReportModal(q) {
        // ... (โค้ด openReportModal เดิม) ...
        const $reportCard = $('#report-card');

        $('#report_text').val('');
        $('#report-new-choice-input').val('');
        $('#report-question-images').empty();
        $('#report-choices-list').empty();
        const $select = $('#report-correct-choice-select').empty();

        $('#report-question-text').html(q.problem.replace(/\n/g, '<br>'));

        if (q.img) {
            q.img.split('///').forEach(url => {
                if (url.trim()) {
                    $('#report-question-images').append(`<img src="${transformUrl(url)}" class="report-img-preview">`);
                }
            });
        }

        const choicesArray = (q.choices || "").split("///").map(s => s.trim()).filter(Boolean);

        let selectOptions = '<option value="newanswer">-- ใช้คำตอบใหม่ (พิมพ์ด้านล่าง) --</option>';

        choicesArray.forEach((choice, index) => {
            const letter = String.fromCharCode(65 + index);
            const isCurrentAns = (choice === q.answer);

            let displayContent = choice;
            if (choice.startsWith('http')) {
                displayContent = `<img src="${transformUrl(choice)}" class="report-choice-img">`;
            }
            $('#report-choices-list').append(`<p class="mb-1 border-bottom pb-1"><b>${letter}.</b> ${displayContent}</p>`);

            let dropText = choice.startsWith('http') ? `[รูปภาพ] ${choice.substring(0, 20)}...` : choice;
            selectOptions += `<option value="${choice}" ${isCurrentAns ? 'selected' : ''}>
                ${letter}. ${dropText} ${isCurrentAns ? '(เฉลยปัจจุบัน)' : ''}
            </option>`;
        });

        $select.html(selectOptions);
        $reportCard.css('display', 'flex').hide().fadeIn();
        // ... (จบโค้ด openReportModal เดิม) ...
    }

    async function processReport(index, action) {
        // ... (โค้ด processReport เดิม) ...
        const pending = globalData.report.filter(r => !r.Done || r.Done.toString().toUpperCase() === 'FALSE');
        const r = pending[index];
        const note = $(`#admin-note-${index}`).val();
        if (!confirmAdmin()) return;

        const result = await Swal.fire({ title: 'ยืนยัน?', icon: 'question', showCancelButton: true });
        if (result.isConfirmed) {
            await sendAdminAction('updateReportStatus', {
                timestamp: r['Time'],
                adminNote: note,
                status: action === 'REJECT' ? 'Rejected' : 'Resolved',
                done: 'TRUE'
            });
            $(`#admin-note-${index}`).closest('.card').fadeOut();
        }
        // ... (จบโค้ด processReport เดิม) ...
    }

    function openEditReportModal(index) {
        // ... (โค้ด openEditReportModal เดิม) ...
        const pending = globalData.report.filter(r => !r.Done || r.Done.toString().toUpperCase() === 'FALSE');
        const r = pending[index];

        let dbQuestion = globalData.questions.find(q => q.problem.trim() === r['Question'].trim());

        if (!dbQuestion) {
            Swal.fire('Error', 'ไม่พบต้นฉบับข้อสอบนี้ใน Database (อาจถูกลบไปแล้ว)', 'error');
            return;
        }

        const suggestedAnswer = r['SuggestedAnswer'];
        const note = $(`#admin-note-${index}`).val();

        $('#editQuestionModal').data('reportData', {
            index: index,
            timestamp: r['Time'],
            adminNote: note
        });

        openEditModal(dbQuestion.questionId, suggestedAnswer);
        // ... (จบโค้ด openEditReportModal เดิม) ...
    }


    // ====================================================================
    // 8. VOTE SYSTEM (Category Suggestion)
    // ====================================================================

    function getCategoryNameById(categoryId) {
        // ... (โค้ด getCategoryNameById เดิม) ...
        const category = globalData.category.find(t => t.CategoryID === categoryId);
        return category ? category.CategoryName : categoryId;
        // ... (จบโค้ด getCategoryNameById เดิม) ...
    }

    function renderCurrentCategory(question) {
        // ... (โค้ด renderCurrentCategory เดิม) ...
        const $container = $('#current-category-container');
        $container.empty();
        const category = Array.isArray(question.category) ? question.category : [question.category];

        if (category.length === 0 || category[0] === '-') {
            $container.html('<span class="empty-state-text">- ยังไม่มีหัวข้อ -</span>');
            return;
        }

        category.forEach(categoryId => {
            const categoryName = getCategoryNameById(categoryId);
            const $badge = $(`
                        <div class="category-badge approved">
                            <i class="fas fa-check"></i> ${categoryName}
                        </div>
                    `);
            $container.append($badge);
        });
        // ... (จบโค้ด renderCurrentCategory เดิม) ...
    }

    function addVoteRow() {
        // ... (โค้ด addVoteRow เดิม) ...
        const subjects = [];
        globalData.structure.forEach(s => {
            subjects.push({ id: s.SubjectID, name: s.SubjectName });
        });

        let subjectOptions = `<option value="">-- เลือกวิชา --</option>`;
        const uniqueSubjects = {};
        subjects.forEach(s => {
            if (!uniqueSubjects[s.id]) {
                uniqueSubjects[s.id] = s;
                subjectOptions += `<option value="${s.id}">${s.id} - ${s.name}</option>`;
            }
        });

        const rowHtml = `
                    <div class="vote-row">
                        <button class="btn-remove-row"><i class="fas fa-minus"></i></button>
                        <select class="vote-select subject-select">${subjectOptions}</select>
                        <select class="vote-select group-select" disabled><option value="">-- เลือกกลุ่ม --</option></select>
                        <select class="vote-select category-select" disabled><option value="">-- เลือกหัวข้อ --</option></select>
                    </div>
                `;

        const $row = $(rowHtml);
        $('#vote-rows-container').append($row);

        $row.find('.subject-select').on('change', function () {
            const subjId = $(this).val();
            const $groupSelect = $row.find('.group-select');
            const $categorySelect = $row.find('.category-select');

            $groupSelect.empty().append('<option value="">-- เลือกกลุ่ม --</option>').prop('disabled', true);
            $categorySelect.empty().append('<option value="">-- เลือกหัวข้อ --</option>').prop('disabled', true);

            if (subjId) {
                const relatedCategory = globalData.category.filter(t => t.SubjectRef === subjId);
                const groups = [...new Set(relatedCategory.map(t => t.AccordionGroup))];

                groups.forEach(g => {
                    if (g) $groupSelect.append(`<option value="${g}">${g}</option>`);
                });
                $groupSelect.prop('disabled', false);
            }
        });

        $row.find('.group-select').on('change', function () {
            const groupName = $(this).val();
            const subjId = $row.find('.subject-select').val();
            const $categorySelect = $row.find('.category-select');

            $categorySelect.empty().append('<option value="">-- เลือกหัวข้อ --</option>').prop('disabled', true);

            if (groupName && subjId) {
                const category = globalData.category.filter(t => t.SubjectRef === subjId && t.AccordionGroup === groupName);
                category.forEach(t => {
                    $categorySelect.append(`<option value="${t.CategoryID}">${t.CategoryName}</option>`);
                });
                $categorySelect.prop('disabled', false);
            }
        });

        $row.find('.btn-remove-row').on('click', function () {
            $(this).parent().remove();
        });
        // ... (จบโค้ด addVoteRow เดิม) ...
    }

    function submitSingleVote(categoryId) {
        // ... (โค้ด submitSingleVote เดิม) ...
        submitVoteData([categoryId], true);
        // ... (จบโค้ด submitSingleVote เดิม) ...
    }

    function submitVoteData(categoryArray, single = false) {
        // ... (โค้ด submitVoteData เดิม) ...
        $('#btn-submit-vote').prop('disabled', true).text('กำลังส่ง...');
        const successMsg = single ? "บันทึกโหวตเห็นด้วยเรียบร้อย! 🙏" : "บันทึกข้อมูลเรียบร้อย ขอบคุณครับ! 🙏";

        const payload = {
            action: 'submitVote',
            questionId: current_question.questionId,
            questionText: current_question.problem,
            suggestedCategory: categoryArray
        };

        fetch(APPSCRIPT_URL, {
            method: 'POST',
            headers: { "Content-Type": "text/plain;charset=utf-8" },
            body: JSON.stringify(payload)
        }).then(() => {
            Swal.fire('Success', successMsg, 'success');
            $('#vote-category-modal').css('display', 'none');
            $('#btn-submit-vote').prop('disabled', false).text('ยืนยัน');
            fetchPendingVotes(current_question.questionId); // อัปเดตผลโหวตทันที
        }).catch(err => {
            Swal.fire('Error', 'เกิดข้อผิดพลาดในการส่งข้อมูล: ' + err, 'error');
            $('#btn-submit-vote').prop('disabled', false).text('ยืนยัน');
        });
        // ... (จบโค้ด submitVoteData เดิม) ...
    }

    function fetchPendingVotes(questionId) {
        // ... (โค้ด fetchPendingVotes เดิม) ...
        const $container = $('#suggested-category-container');

        $container.html('<span class="empty-state-text"><i class="fas fa-spinner fa-spin"></i> กำลังดึงข้อมูลผลโหวต...</span>');

        fetch(`${APPSCRIPT_URL}?action=getPendingVotes&qid=${questionId}`)
            .then(response => response.json())
            .then(data => {
                $container.empty();

                const currentCats = Array.isArray(current_question.category) ? current_question.category : [current_question.category];
                const filteredData = data.filter(item => !currentCats.includes(item.categoryId));

                if (!filteredData || filteredData.length === 0) {
                    $container.html('<span class="empty-state-text">- ยังไม่มีข้อเสนอใหม่ -</span>');
                    return;
                }

                filteredData.forEach(item => {
                    const categoryName = getCategoryNameById(item.categoryId);
                    const $badge = $(`
                        <div class="category-badge suggested" title="คลิกเพื่อโหวตเห็นด้วย (+1)">
                            ${categoryName}
                            <span class="vote-count-badge">${item.count} <i class="fas fa-user"></i></span>
                        </div>
                    `);

                    $badge.on('click', function () {
                        Swal.fire({
                            title: 'ยืนยันการโหวต',
                            text: `คุณเห็นด้วยว่าข้อสอบนี้ควรอยู่ในหัวข้อ "${categoryName}" ใช่หรือไม่?`,
                            icon: 'question',
                            showCancelButton: true,
                            confirmButtonText: 'ใช่, เห็นด้วย',
                            cancelButtonText: 'ยกเลิก'
                        }).then((result) => {
                            if (result.isConfirmed) {
                                submitSingleVote(item.categoryId);
                            }
                        });
                    });

                    $container.append($badge);
                });
            })
            .catch(err => {
                console.error('Fetch Pending Votes Error:', err);
                $container.html('<span class="text-danger small"><i class="fas fa-exclamation-triangle"></i> โหลดข้อมูลล้มเหลว</span>');
            });
        // ... (จบโค้ด fetchPendingVotes เดิม) ...
    }


    // ====================================================================
    // 9. STRUCTURE (Subject/Group/Category) CRUD SYSTEM
    // ====================================================================

    // --- Tree Rendering ---
    function renderStructureTree(filterSubjectID = "") {
        const container = $('#structure-tree-view');
        container.empty();

        let subjects = globalData.structure;
        if (filterSubjectID) subjects = subjects.filter(s => s.SubjectID === filterSubjectID);

        // Remove duplicate subjects based on SubjectID
        const uniqueSubjects = [];
        const seenSubjectIDs = new Set();

        subjects.forEach(subj => {
            if (!seenSubjectIDs.has(subj.SubjectID)) {
                uniqueSubjects.push(subj);
                seenSubjectIDs.add(subj.SubjectID);
            }
        });

        let treeHtml = '<ul class="tree-view">';

        uniqueSubjects.forEach(subj => {
            // LEVEL 1: SUBJECT
            treeHtml += `
            <li id="node-subj-${subj.SubjectID}">
                <div class="tree-node node-subject">
                    <i class="fas fa-chevron-down toggle-icon" onclick="toggleTreeNode(this)"></i>
                    <i class="fas fa-university me-2 text-primary"></i>
                    <span class="fw-bold">${subj.SubjectID} - ${subj.SubjectName}</span>
                    <div class="node-actions">
                        <button class="btn-node btn-add" onclick="crudAction('addGroup', '${subj.SubjectID}')" title="เพิ่ม Group"><i class="fas fa-plus"></i></button>
                        <button class="btn-node btn-edit" onclick="crudAction('editSubj', '${subj.SubjectID}')"><i class="fas fa-pen"></i></button>
                        <button class="btn-node btn-delete" onclick="crudAction('deleteSubj', '${subj.SubjectID}')"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
                <ul>`;

            // ดึง Group ทั้งหมดในวิชานี้ (ลบซ้ำ)
            const groups = [...new Set(globalData.category.filter(c => c.SubjectRef === subj.SubjectID).map(c => c.AccordionGroup))].sort();

            groups.forEach(groupName => {
                // LEVEL 2: ACCORDION GROUP
                treeHtml += `
                <li>
                    <div class="tree-node node-group">
                        <i class="fas fa-chevron-down toggle-icon" onclick="toggleTreeNode(this)"></i>
                        <i class="fas fa-layer-group me-2 text-success"></i>
                        <span>${groupName || 'GENERAL'}</span>
                        <div class="node-actions">
                            <button class="btn-node btn-add" onclick="crudAction('addCat', '${subj.SubjectID}', '${groupName}')" title="เพิ่มหัวข้อ"><i class="fas fa-plus"></i></button>
                            <!-- NEW: ปุ่มแก้ไข Group -->
                            <button class="btn-node btn-edit" onclick="crudAction('editGroup', '${subj.SubjectID}', '${groupName}')" title="แก้ไขชื่อ Group"><i class="fas fa-pen"></i></button>
                            <!-- END NEW -->
                            <button class="btn-node btn-delete" onclick="crudAction('deleteGroup', '${subj.SubjectID}', '${groupName}')"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                    <ul>`;

                // LEVEL 3: CATEGORY (ลบซ้ำ)
                const seenCategoryIDs = new Set();
                const categories = globalData.category.filter(c => {
                    if (c.SubjectRef === subj.SubjectID && c.AccordionGroup === groupName) {
                        if (!seenCategoryIDs.has(c.CategoryID)) {
                            seenCategoryIDs.add(c.CategoryID);
                            return true;
                        }
                    }
                    return false;
                });

                categories.forEach(cat => {
                    treeHtml += `
                    <li>
                        <div class="tree-node node-category">
                            <i class="fas fa-tag me-2 text-secondary"></i>
                            <span class="small"><b>${cat.CategoryID}:</b> ${cat.CategoryName}</span>
                            <div class="node-actions">
                                <button class="btn-node btn-edit" onclick="crudAction('editCat', '${cat.CategoryID}')"><i class="fas fa-pen"></i></button>
                                <button class="btn-node btn-delete" onclick="crudAction('deleteCat', '${cat.CategoryID}')"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>
                    </li>`;
                });

                treeHtml += '</ul></li>';
            });

            treeHtml += '</ul></li>';
        });

        treeHtml += '</ul>';
        container.html(treeHtml);
    }

    // --- Tree Collapse ---
    function toggleTreeNode(el) {
        // ... (โค้ด toggleTreeNode เดิม) ...
        $(el).closest('.tree-node').toggleClass('collapsed');
        // ... (จบโค้ด toggleTreeNode เดิม) ...
    }

    // --- Admin CRUD Action ---
    async function confirmStrictDelete(itemName, confirmKey) {
        // ... (โค้ด confirmStrictDelete เดิม) ...
        const { value: input } = await Swal.fire({
            title: 'ยืนยันการลบแบบถาวร',
            html: `คุณกำลังจะลบ <b>${itemName}</b> ข้อมูลที่เกี่ยวข้องทั้งหมดจะหายไปรวมถึงโจทย์ที่ผูกอยู่<br><br>กรุณาพิมพ์: <span class="text-danger fw-bold">${confirmKey}</span> เพื่อยืนยัน`,
            input: 'text',
            inputPlaceholder: confirmKey,
            showCancelButton: true,
            confirmButtonColor: '#d33',
            confirmButtonText: 'ยืนยันการลบ',
            inputValidator: (value) => {
                if (!value || value !== confirmKey) {
                    return 'ข้อความยืนยันไม่ถูกต้อง!'
                }
            }
        });
        return !!input;
        // ... (จบโค้ด confirmStrictDelete เดิม) ...
    }

    async function crudAction(type, id1, id2) {
        if (!confirmAdmin()) return;

        let payload = { action: '', data: {} };

        switch (type) {
            // ... (Subject CRUD Logic - unchanged) ...
            case 'addSubj':
                // ตรรกะสำหรับการเพิ่มวิชาใหม่
                const { value: subjForm } = await Swal.fire({
                    title: 'เพิ่มวิชาใหม่ (Add Subject)',
                    html: `
                        <div class="text-start">
                            <div class="mb-3">
                                <label class="form-label fw-bold small text-primary">
                                    <i class="fas fa-code me-1"></i>รหัสวิชา (Subject ID)
                                </label>
                                <input id="swal-subj-id" class="form-control form-control-sm" placeholder="เช่น GI, NS, CV" maxlength="5" style="border: 1px solid #ced4da; border-radius: 6px; padding: 0.5rem;">
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label fw-bold small text-primary">
                                    <i class="fas fa-calendar-alt me-1"></i>ชั้นปี (Year)
                                </label>
                                <input id="swal-subj-year" type="number" class="form-control form-control-sm" placeholder="เช่น 1, 2, 3" style="border: 1px solid #ced4da; border-radius: 6px; padding: 0.5rem;">
                            </div>
                            
                            <div class="mb-2">
                                <label class="form-label fw-bold small text-primary">
                                    <i class="fas fa-book me-1"></i>ชื่อวิชา (Subject Name)
                                </label>
                                <input id="swal-subj-name" class="form-control form-control-sm" placeholder="ชื่อวิชาเต็ม" style="border: 1px solid #ced4da; border-radius: 6px; padding: 0.5rem;">
                            </div>
                        </div>
                    `,
                    focusConfirm: false,
                    showCancelButton: true,
                    confirmButtonText: 'บันทึกวิชาใหม่',
                    preConfirm: () => {
                        const id = document.getElementById('swal-subj-id').value.trim().toUpperCase();
                        const year = document.getElementById('swal-subj-year').value.trim();
                        const name = document.getElementById('swal-subj-name').value.trim();

                        if (!id || !name) {
                            Swal.showValidationMessage('กรุณากรอกรหัสวิชาและชื่อวิชาให้ครบ');
                            return false;
                        }

                        // ตรวจสอบว่า SubjectID ซ้ำหรือไม่
                        const exists = globalData.structure.some(s => s.SubjectID.toUpperCase() === id);
                        if (exists) {
                            Swal.showValidationMessage(`รหัสวิชา ${id} มีอยู่แล้วในระบบ`);
                            return false;
                        }

                        return {
                            SubjectID: id,
                            Year: year || '0', // ให้ค่าเริ่มต้นเป็น '0' ถ้าไม่มีการระบุ
                            SubjectName: name
                        };
                    }
                });

                if (subjForm) {
                    payload.action = 'addSubject';
                    payload.data = subjForm;
                }
                break;

            case 'editSubj':
                // id1 คือ SubjectID
                const subj = globalData.structure.find(s => s.SubjectID === id1);
                if (!subj) {
                    Swal.fire('Error', `ไม่พบวิชา ${id1} ในโครงสร้าง`, 'error');
                    return;
                }

                const { value: editSubjForm } = await Swal.fire({
                    title: `แก้ไขวิชา ${id1}`,
                    html: `
                        <div class="text-start">
                            <div class="mb-3">
                                <label class="form-label fw-bold small text-primary">
                                    <i class="fas fa-code me-1"></i>รหัสวิชา (Subject ID)
                                </label>
                                <input id="swal-subj-id" class="form-control form-control-sm bg-light" readonly value="${subj.SubjectID}" style="border: 1px solid #dee2e6; border-radius: 6px;">
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label fw-bold small text-primary">
                                    <i class="fas fa-calendar-alt me-1"></i>ชั้นปี (Year)
                                </label>
                                <input id="swal-subj-year" type="number" class="form-control form-control-sm" placeholder="เช่น 1, 2, 3" value="${subj.Year || ''}" style="border: 1px solid #ced4da; border-radius: 6px; padding: 0.5rem;">
                            </div>
                            
                            <div class="mb-2">
                                <label class="form-label fw-bold small text-primary">
                                    <i class="fas fa-book me-1"></i>ชื่อวิชา (Subject Name)
                                </label>
                                <input id="swal-subj-name" class="form-control form-control-sm" placeholder="ชื่อวิชาเต็ม" value="${subj.SubjectName || ''}" style="border: 1px solid #ced4da; border-radius: 6px; padding: 0.5rem;">
                            </div>
                        </div>
                    `,
                    focusConfirm: false,
                    showCancelButton: true,
                    confirmButtonText: 'บันทึกการแก้ไข',
                    preConfirm: () => {
                        const year = document.getElementById('swal-subj-year').value;
                        const name = document.getElementById('swal-subj-name').value.trim();

                        if (!name) {
                            Swal.showValidationMessage('กรุณากรอกชื่อวิชา');
                            return false;
                        }

                        return {
                            SubjectID: id1,
                            Year: year,
                            SubjectName: name
                        };
                    }
                });

                if (editSubjForm) {
                    payload.action = 'updateSubject';
                    payload.data = editSubjForm;
                }
                break;

            case 'deleteSubj':
                // ... (Delete Subject Logic) ...
                if (await confirmStrictDelete(`วิชา ${id1}`, id1)) {
                    payload.action = 'deleteSubject';
                    payload.data = { SubjectID: id1 };
                }
                break;

            // --- GROUP CRUD ---
            case 'addGroup':
                // ... (Add Group Logic - unchanged) ...
                const { value: newGroup } = await Swal.fire({
                    title: 'เพิ่มกลุ่มในวิชา ' + id1,
                    input: 'text',
                    inputPlaceholder: 'เช่น MCQ1,MCQ2,MCQ3,MCQ4,FMT1,FMT2,by AI',
                    showCancelButton: true
                });
                if (newGroup) {
                    // การเพิ่ม Group คือการเพิ่ม Category แรกเข้าไปใน Group นั้น
                    payload.action = 'addCategory';
                    payload.data = {
                        CategoryID: `${id1}_${newGroup.replace(/\s+/g, '')}_Init`,
                        SubjectRef: id1,
                        AccordionGroup: newGroup,
                        CategoryName: 'Default Title'
                    };
                }
                break;

            case 'editGroup':
                const { value: newGroupName } = await Swal.fire({
                    title: `เปลี่ยนชื่อกลุ่ม "${id2}" ในวิชา ${id1}`,
                    input: 'text',
                    inputValue: id2,
                    inputPlaceholder: 'ชื่อกลุ่มใหม่',
                    showCancelButton: true
                });

                if (newGroupName && newGroupName !== id2) {
                    payload.action = 'updateAccordionGroup';
                    payload.data = {
                        SubjectRef: id1,
                        OldAccordionGroup: id2,
                        NewAccordionGroup: newGroupName.trim()
                    };
                }
                break;

            case 'deleteGroup':
                // ... (Delete Group Logic - unchanged) ...
                if (await confirmStrictDelete(`กลุ่ม ${id2} ในวิชา ${id1}`, 'ลบกลุ่ม')) {
                    payload.action = 'deleteGroup';
                    payload.data = { SubjectRef: id1, AccordionGroup: id2 };
                }
                break;

            // ... (Category CRUD Logic - unchanged) ...
            case 'addCat':
                openAddCategoryModal(id1, id2);
                break;

            case 'deleteCat':
                // ... (Delete Category Logic) ...
                if (await confirmStrictDelete(`หัวข้อ ${id1}`, 'DELETE')) {
                    payload.action = 'deleteCategory';
                    payload.data = { CategoryID: id1 };
                }
                break;

            case 'editCat':
                // ... (Edit Category Logic) ...
                const cat = globalData.category.find(c => c.CategoryID === id1);
                const { value: catEdit } = await Swal.fire({
                    title: 'แก้ไขหัวข้อ ' + id1,
                    input: 'text',
                    inputValue: cat ? cat.CategoryName : '',
                    inputPlaceholder: 'Display Name',
                    showCancelButton: true
                });
                if (catEdit) {
                    payload.action = 'updateCategory';
                    payload.data = { CategoryID: id1, CategoryName: catEdit };
                }
                break;
        }

        if (payload.action) {
            await sendAdminAction(payload.action, payload.data);
        }
    }

    // --- Other Structure Utilities ---
    function confirmDelete(text) {
        // ... (โค้ด confirmDelete เดิม) ...
        return Swal.fire({
            title: 'ยืนยันการลบ?',
            text: text,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33'
        }).then(res => res.isConfirmed);
        // ... (จบโค้ด confirmDelete เดิม) ...
    }

    function editCategoryInline(catID) {
        // ... (โค้ด editCategoryInline เดิม) ...
        const cat = globalData.category.find(c => c.CategoryID === catID);
        if (!cat) return;

        Swal.fire({
            title: 'แก้ไขหัวข้อ',
            html: `
                <input id="swal-cat-name" class="swal2-input" placeholder="Display Name" value="${cat.CategoryName}">
                <input id="swal-cat-group" class="swal2-input" placeholder="Accordion Group" value="${cat.AccordionGroup}">
            `,
            showCancelButton: true,
            confirmButtonText: 'บันทึก',
            preConfirm: () => {
                return {
                    CategoryName: document.getElementById('swal-cat-name').value,
                    AccordionGroup: document.getElementById('swal-cat-group').value
                }
            }
        }).then((result) => {
            if (result.isConfirmed) {
                Swal.fire('กำลังพัฒนา', 'ระบบบันทึกการแก้ไขหัวข้อกำลังอยู่ในการดำเนินการ', 'info');
            }
        });
        // ... (จบโค้ด editCategoryInline เดิม) ...
    }

    async function saveNewCategory() {
        // ... (โค้ด saveNewCategory เดิม) ...
        if (!confirmAdmin()) return;
        const payload = {
            CategoryID: $('#new-category-id').val(),
            SubjectRef: $('#new-category-subject').val(),
            AccordionGroup: $('#new-category-group').val(),
            CategoryName: $('#new-category-name').val()
        };
        await sendAdminAction('addCategory', payload);
        $('#addCategoryModal').modal('hide');
        // ... (จบโค้ด saveNewCategory เดิม) ...
    }

    function generateCategoryIDPreview() {
        // ... (โค้ด generateCategoryIDPreview เดิม) ...
        const subj = $('#new-category-subject').val();
        const name = $('#new-category-name').val();
        if (subj && name) {
            const cleanName = name.replace(/\s+/g, '').replace(/[^a-zA-Z0-9]/g, '');
            $('#new-category-id').val(`${subj}_${cleanName}`);
        }
        // ... (จบโค้ด generateCategoryIDPreview เดิม) ...
    }

    function openAddCategoryModal(subjectId = null, groupName = null) {
        const subjects = [...new Set(globalData.structure.map(s => s.SubjectID))];
        let opts = '<option value="">-- Select Subject --</option>';
        // ใช้ template literal เพื่อตรวจสอบและตั้งค่า 'selected'
        subjects.forEach(s => opts += `<option value="${s}" ${subjectId === s ? 'selected' : ''}>${s}</option>`);

        $('#new-category-subject').html(opts);

        // ตั้งค่า Group และ Name (Name จะถูกเคลียร์เสมอ)
        $('#new-category-group').val(groupName || '');
        $('#new-category-name').val('');
        $('#new-category-id').val('');
        $('#category-id-error').text('');

        // ถ้ามีการ Pre-fill Subject ให้ลอง Generate ID ทันที
        if (subjectId) {
            generateCategoryIDPreview();
        }

        $('#addCategoryModal').modal('show');
    }


    // ====================================================================
    // 10. ADMIN & GENERAL UTILITIES
    // ====================================================================

        const transformUrl = (url) => {
                // ... (โค้ด transformUrl เดิม) ...
                if (!url) return "";
                const match = url.match(/\/d\/(.*?)\//) || url.match(/id=([^&]+)/);
                return (match && match[1]) ? `https://lh3.googleusercontent.com/d/${match[1]}?authuser=1=w1000-h1000` : url;
                // ... (จบโค้ด transformUrl เดิม) ...
            };

            function openResetFromProfile() {
                    $('#editProfileModal').modal('hide'); // ปิดหน้าโปรไฟล์

                    // ตั้งค่าข้อมูลเบื้องต้นในหน้า Reset ให้ (ถ้ามี)
                    $('#reset-username').val(currentUser.username);
                    $('#reset-kkumail').val(currentUser.kkumail || '');

                    $('#resetModal').modal('show'); // เปิดหน้าเปลี่ยนรหัส
                }
    // 1. ฟังก์ชันเปิด Modal แก้ไขโปรไฟล์ และดึงข้อมูลเดิมมาใส่
    function openEditProfile() {
        if (!currentUser.username) return;

        $('#ep-prefix').val(currentUser.prefix || '');
        $('#ep-fullname').val(currentUser.fullName || '');
        $('#ep-displayname').val(currentUser.displayName || '');
        $('#ep-year').val(currentUser.year || '');
        $('#ep-contact').val(currentUser.contact || '');
        $('#edit-avatar-preview').attr('src', currentUser.avatar);
        $('#editProfileModal').modal('show');
    }

    async function compressImage(base64Str, maxWidth = 400, maxHeight = 400) {
            return new Promise((resolve) => {
                const img = new Image();
                img.src = base64Str;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;

                    if (width > height) {
                        if (width > maxWidth) {
                            height *= maxWidth / width;
                            width = maxWidth;
                        }
                    } else {
                        if (height > maxHeight) {
                            width *= maxHeight / height;
                            height = maxHeight;
                        }
                    }
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    resolve(canvas.toDataURL('image/jpeg', 0.7)); // บีบอัดคุณภาพเหลือ 70%
                };
            });
        }

        // 2. ฟังก์ชันอัปเดตโปรไฟล์
        async function updateUserProfile() {
            // ตรวจสอบรูปภาพ: ถ้า currentUser.avatar เป็น Base64 (จากการเลือกไฟล์ใหม่) ให้ส่งไป
            let avatarBase64 = null;
            if (currentUser.avatar && currentUser.avatar.startsWith('data:image')) {
            avatarBase64 = currentUser.avatar;
            }

            const updateData = {
            prefix: $('#ep-prefix').val(),
            fullName: $('#ep-fullname').val(),
            displayName: $('#ep-displayname').val(),
            year: $('#ep-year').val(),
            contact: $('#ep-contact').val(),
            AvatarBase64: avatarBase64 // ส่งค่า Base64 เพื่อให้ Backend อัปโหลดลง Drive
            };

            $('#loading-overlay').css('display', 'flex');
            try {
            const res = await sendWithRetry({
                action: 'updateAdminProfile',
                targetUsername: currentUser.username,
                updateData: updateData
            });
            
            if (res.result === 'success') {
                // อัปเดต Display Name ฝั่ง Client ทันทีเพื่อ UX ที่ดี
                currentUser.displayName = updateData.displayName;

                Swal.fire('สำเร็จ', 'อัปเดตข้อมูลโปรไฟล์เรียบร้อยแล้ว', 'success');
                $('#editProfileModal').modal('hide');
                await fetchData(); // โหลดข้อมูลใหม่ (เพื่อให้ได้ URL รูปจริงจาก Drive)
            } else {
                Swal.fire('Error', res.message || 'ไม่สามารถอัปเดตข้อมูลได้', 'error');
            }
            } catch (error) {
            console.error(error);
            Swal.fire('Error', 'Server Connection Error: ' + error.message, 'error');
            } finally {
            $('#loading-overlay').hide();
            }
        }

        // 3. ปรับปรุง UI เมื่อล็อกอิน (เพิ่มคลิกที่ชื่อ/รูปเพื่อแก้โปรไฟล์)
        /* แก้ไขใน function updateAuthUI(isLoggedIn) */
        if (isLoggedIn) {
            // ... โค้ดเดิม ...
            $('#topbar-user, #topbar-avatar').on('click', openEditProfile);
            $('#topbar-user').css('cursor', 'pointer').attr('title', 'คลิกเพื่อแก้ไขโปรไฟล์');

            // ถ้าเป็น Dev ให้โชว์เมนูจัดการ User
            if (currentUser.role === 'DEVELOPER') {
                $('.developer-only').show();
                $('[onclick="showSection(\'admin-manager\')"]').show(); // เพิ่มปุ่มใน sidebar ด้วย
            }
        }

        // 4. ฟังก์ชันจัดการ Admin สำหรับ Developer
    function loadAdminManager() {
        const listContainer = $('#admin-user-list');
        listContainer.empty();

        if (!globalData.admins || globalData.admins.length === 0) {
            listContainer.html('<tr><td colspan="6" class="text-center">ไม่พบข้อมูล Admin (หรือยังไม่ได้โหลด)</td></tr>');
            return;
        }

        let html = '';
        globalData.admins.forEach(u => {
            // ป้องกัน Error กรณี field ไม่มีค่า
            const avatar = u.AvatarURL || 'https://cdn-icons-png.flaticon.com/512/149/149071.png';
            const roleBadge = u.Role === 'DEVELOPER' ? 'bg-danger' : 'bg-primary';

            html += `
        <tr>
            <td class="text-center"><img src="${avatar}" width="40" height="40" class="rounded-circle border"></td>
            <td class="align-middle fw-bold">${u.Username}</td>
            <td class="align-middle">${u.FullName || '-'}</td>
            <td class="align-middle"><span class="badge ${roleBadge}">${u.Role}</span></td>
            <td class="align-middle small">${u.KKUMail || '-'}</td>
            <td class="align-middle">
                 <!-- ปุ่ม Action (ถ้ามีฟังก์ชัน Edit User ในอนาคต) -->
                <button class="btn btn-sm btn-outline-secondary" disabled title="Coming Soon"><i class="fas fa-cog"></i></button>
            </td>
        </tr>`;
        });
        listContainer.html(html);
    }
        if (sectionId === 'admin-manager') {
            if (currentUser.role !== 'DEVELOPER') {
                Swal.fire('Access Denied', 'คุณไม่มีสิทธิ์เข้าถึงหน้านี้', 'error');
                showSection('dashboard');
            }
            loadAdminManager();
        }

        function openRegisterModal() {
            Swal.close(); // ปิด Modal Login
            $('#registerModal').modal('show');
            $('#registerForm').removeClass('was-validated');
        }

    function validateRegistrationForm() {
        const kkumail = $('#reg-kkumail').val() ? $('#reg-kkumail').val().trim() : "";
        const studentId = $('#reg-studentid').val() ? $('#reg-studentid').val().trim() : ""; // แก้จาก reg-student-id เป็น reg-studentid
        const $form = $('#registerForm');
        let isValid = true;

        $form.find('input, select').removeClass('is-invalid');

        // 1. KKUMail validation
        const kkuMailRegex = /@kkumail\.com$|@kku\.ac\.th$/i;
        if (!kkuMailRegex.test(kkumail)) {
            $('#reg-kkumail').addClass('is-invalid');
            isValid = false;
        }

        // 2. StudentID validation (Format: 123456789-0)
        const studentIdRegex = /^\d{9}-\d$/;
        if (!studentIdRegex.test(studentId)) {
            $('#reg-studentid').addClass('is-invalid');
            isValid = false;
        }

        // 3. HTML5 required check
        $form.find('[required]').each(function () {
            if (!$(this).val()) {
                $(this).addClass('is-invalid');
                isValid = false;
            }
        });

        if (isValid) {
            $form.addClass('was-validated');
        } else {
            $form.removeClass('was-validated');
        }

        return isValid;
    }

        // ====================================================================
        // PASSWORD CHANGE LOGIC
        // ====================================================================

        // --- Auth Modal Control ---
            function openLoginModal() {
                $('#loginModal').modal('show');
            }
            function openRegisterModal() {
                $('#registerModal').modal('show');
            }
            function openResetModal() {
                $('#loginModal').modal('hide');
                $('#resetModal').modal('show');
            }

    // --- Image Preview & Base64 Conversion ---

    function previewEditAvatar(input) {
        if (input.files && input.files[0]) {
            var file = input.files[0];
            if (file.size > 500 * 1024) { // 500KB limit
                Swal.fire('Error', 'ขนาดรูปภาพต้องไม่เกิน 500KB', 'error');
                input.value = ""; // Clear selection
                return;
            }

            var reader = new FileReader();
            reader.onload = function (e) {
                $('#edit-avatar-preview').attr('src', e.target.result).removeClass('hidden');
                $('#edit-avatar-icon').addClass('hidden');
                currentUser.avatar = e.target.result; // Update currentUser avatar
            }
            reader.readAsDataURL(file);
        }
    }
    
    function previewAvatar(input) {
        if (input.files && input.files[0]) {
            var file = input.files[0];
            if (file.size > 500 * 1024) { // 500KB limit (ควรตรวจสอบใน submitRegister ด้วย)
                Swal.fire('Error', 'ขนาดรูปภาพต้องไม่เกิน 500KB', 'error');
                input.value = ""; // Clear selection
                return;
            }

            var reader = new FileReader();
            reader.onload = function (e) {
                $('#reg-avatar-preview').attr('src', e.target.result).removeClass('hidden');
                $('#reg-avatar-icon').addClass('hidden');
                regAvatarBase64 = e.target.result; // Store base64 string
                regAvatarMimeType = file.type; // Store MIME type
            }
            reader.readAsDataURL(file);
        } else {
            regAvatarBase64 = null;
            regAvatarMimeType = null;
        }
    }
        // --- Register Logic ---
            async function submitRegister() {
                // 1. Validate Input
                const kkumail = $('#reg-kkumail').val().trim();
                const studentId = $('#reg-studentid').val().trim();
                const password = $('#reg-password').val();
                const username = $('#reg-username').val().trim();

                // Regex Check
                const emailRegex = /@(kkumail\.com|kku\.ac\.th)$/;
                const studentIdRegex = /^\d{9}-\d{1}$/;

                if (!emailRegex.test(kkumail)) {
                    Swal.fire('Error', 'อีเมลต้องลงท้ายด้วย @kkumail.com หรือ @kku.ac.th', 'error');
                    return;
                }
                if (!studentIdRegex.test(studentId)) {
                    Swal.fire('Error', 'รหัสนักศึกษาไม่ถูกต้อง (Format: 123456789-0)', 'error');
                    return;
                }
                if (username.length < 4 || password.length < 4) {
                    Swal.fire('Error', 'Username และ Password ต้องมีความยาวอย่างน้อย 4 ตัวอักษร', 'error');
                    return;
                }

                if (!validateRegistrationForm()) {
                    Swal.fire('Error', 'กรุณากรอกข้อมูลให้ถูกต้องและครบถ้วน', 'error');
                    return;
                }

                const fileInput = document.getElementById('reg-avatar-input'); // แก้ไขจาก reg-avatar-file เป็น reg-avatar-input
                if (fileInput && fileInput.files.length > 0) {
                    if (fileInput.files[0].size > 500 * 1024) {
                        Swal.fire('Error', 'ขนาดรูปภาพต้องไม่เกิน 500KB', 'error');
                        return;
                    }
                }

                const avatarBase64 = regAvatarBase64;
                const avatarMimeType = regAvatarMimeType;
                let finalAvatar = regAvatarBase64;
                if (finalAvatar) {
                    finalAvatar = await compressImage(finalAvatar); // ย่อรูปก่อนส่ง
                }

                // 2. Prepare Data
                const userData = {
                    Username: username,
                    Password: password,
                    DisplayName: $('#reg-displayname').val().trim(),
                    Prefix: $('#reg-prefix').val(),
                    FullName: $('#reg-fullname').val().trim(),
                    StudentID: studentId,
                    Year: $('#reg-year').val(),
                    KKUMail: kkumail,
                    Contact: $('#reg-contact').val().trim(),
                    Role: $('#reg-role').val(),
                    AvatarBase64: finalAvatar // Send image data
                };

                // 3. Send to Server
                $('#registerModal').modal('hide');
                $('#loading-overlay').css('display', 'flex');
                try {
                    const data = await sendWithRetry({
                        action: 'registerAdmin',
                        userData: userData
                    });

                    if (data.result === 'success') {
                        Swal.fire('ลงทะเบียนสำเร็จ!', 'ยินดีต้อนรับ Admin ใหม่', 'success');
                        fetchData();
                    } else {
                        Swal.fire('Error', data.message || 'เกิดข้อผิดพลาดในการลงทะเบียน', 'error');
                    }
                } catch (e) {
                    Swal.fire('Error', 'Server Error: ' + e.message, 'error');
                } finally {
                    $('#loading-overlay').hide().find('h5').text('กำลังเชื่อมต่อฐานข้อมูล...');
                }
            }

            // --- Reset Password Logic ---
            async function submitResetPassword() {
                const data = {
                    verifyData: {
                        Username: $('#reset-username').val().trim(),
                        KKUMail: $('#reset-kkumail').val().trim(),
                        StudentID: $('#reset-studentid').val().trim(),
                        FullName: $('#reset-fullname').val().trim()
                    },
                    newPassword: $('#reset-newpass').val()
                };

                if (!data.newPassword || data.newPassword.length < 4) {
                    Swal.fire('Warning', 'กรุณาตั้งรหัสผ่านใหม่อย่างน้อย 4 ตัวอักษร', 'warning');
                    return;
                }

                $('#loading-overlay').css('display', 'flex');
                try {
                    const response = await fetch(APPSCRIPT_URL, {
                        method: 'POST',
                        redirect: "follow",
                        headers: { "Content-Type": "text/plain" },
                        body: JSON.stringify({
                            action: 'resetPassword',
                            ...data
                        })
                    });
                    const res = await response.json();

                    if (res.result === 'success') {
                        Swal.fire('สำเร็จ', 'เปลี่ยนรหัสผ่านเรียบร้อยแล้ว กรุณาล็อกอินด้วยรหัสผ่านใหม่', 'success');
                        $('#resetModal').modal('hide');
                    } else {
                        Swal.fire('Error', res.message, 'error');
                    }
                } catch (e) {
                    Swal.fire('Error', e.message, 'error');
                } finally {
                    $('#loading-overlay').hide();
                }
            }

            // --- Login Logic (Updated) ---
            async function performLogin() {
                const username = $('#login-username').val();
                const password = $('#login-password').val();

                if (!username || !password) return;

                $('#loading-overlay').css('display', 'flex');
                try {
                    const data = await sendWithRetry({
                        action: 'checkAuth',
                        username: username,
                        password: password
                    });

                    if (data.result === 'success') {
                        currentUser = data.user;
                        isAdmin = true;
                        adminPass = password; // Store for session actions

                        updateAuthUI(true);
                        $('#loginModal').modal('hide');
                        Swal.fire({
                            icon: 'success',
                            title: 'Welcome, ' + currentUser.displayName,
                            text: 'Role: ' + currentUser.role,
                            timer: 1500,
                            showConfirmButton: false
                        });
                        fetchData();
                    } else {
                        Swal.fire('Login Failed', data.message, 'error');
                    }
                } catch (e) {
                    Swal.fire('Error', e.message, 'error');
                } finally {
                    $('#loading-overlay').hide();
                }
            }

            function logoutAdmin() {
                isAdmin = false;
                adminPass = '';
                currentUser = { displayName: 'Guest', avatar: '', username: '', role: '' };
                updateAuthUI(false);
                showSection('dashboard');
            }

    function updateAuthUI(isLoggedIn) {
            if (isLoggedIn) {
                // 1. จัดการการแสดงผลของปุ่มที่ Topbar
                $('#auth-guest-view').addClass('hidden'); // ซ่อน Login/Register
                $('#auth-user-view').removeClass('hidden').addClass('d-flex'); // แสดงชื่อและรูป

                // 2. แสดงชื่อและรูปภาพ
                $('#topbar-user').text(currentUser.displayName || currentUser.username);

                // จัดการรูปโปรไฟล์ (ถ้าไม่มีรูปให้ใช้รูป Default)
                let avatarSrc = currentUser.avatar ? transformUrl(currentUser.avatar) : 'https://cdn-icons-png.flaticon.com/512/149/149071.png';
                $('#topbar-avatar').attr('src', avatarSrc);

                // 3. จัดการ Sidebar
                $('.admin-only').fadeIn();
                $('#btn-sidebar-login').hide();
                $('#user-status-display').html(`Logged in as:<br><b>${currentUser.displayName}</b>`).css('color', '#fff');

                // 4. สิทธิ์ Developer
                if (currentUser.role === 'DEVELOPER') {
                    $('.developer-only').show();
                }

                // คลิกที่รูปหรือชื่อเพื่อเปิดโปรไฟล์
                $('#topbar-user, #topbar-avatar').off('click').on('click', openEditProfile);

            } else {
                // กรณี Logout หรือยังไม่ล็อกอิน
                $('#auth-guest-view').removeClass('hidden');
                $('#auth-user-view').addClass('hidden').removeClass('d-flex');
                $('.admin-only').hide();
                $('.developer-only').hide();
                $('#btn-sidebar-login').show();
                $('#user-status-display').text('Guest User').css('color', 'rgba(255,255,255,0.6)');
            }
        }
    async function sendAdminAction(actionName, dataObj) {
            $('#loading-overlay').show();
            try {
                // สร้าง Payload และเพิ่ม Metadata (User Agent)
                const payload = {
                    action: actionName,
                    username: currentUser.username,
                    adminPass: adminPass,
                    user: currentUser.displayName,
                    data: dataObj,
                    metadata: navigator.userAgent // [NEW] เพิ่มข้อมูล Browser/Device เพื่อบันทึก Log
                };

                // ส่งข้อมูลด้วยฟังก์ชัน sendWithRetry
                const resJson = await sendWithRetry(payload);

                if (resJson.result === 'success') {
                    // ล้าง Cache ในเครื่องเมื่อมีการเปลี่ยนแปลงข้อมูลบน Server
                    await clearAdminCache();

                    setTimeout(async () => {
                        await fetchData(); // โหลดข้อมูลใหม่จาก Server
                        Swal.fire('Success', 'บันทึกข้อมูลเรียบร้อยแล้ว', 'success');
                    }, 1000);
                } else {
                    throw new Error(resJson.message || resJson.error || 'Unknown Error');
                }
            } catch (e) {
                console.error("Action Error:", e);
                Swal.fire('Error', 'เกิดข้อผิดพลาด: ' + e.message, 'error');
            } finally {
                $('#loading-overlay').hide();
            }
        }
    function formatDate(dateString) {
        // ... (โค้ด formatDate เดิม) ...
        if (!dateString) return '';
        const d = new Date(dateString);
        return d instanceof Date && !isNaN(d) ? d.toLocaleString('th-TH') : dateString;
        // ... (จบโค้ด formatDate เดิม) ...
    }

    async function hashPassword(password) {
        // ... (โค้ด hashPassword เดิม) ...
        const encoder = new TextEncoder();
        const data = encoder.encode(password);
        const hash = await crypto.subtle.digest('SHA-256', data);
        return Array.from(new Uint8Array(hash)).map(b => b.toString(16).padStart(2, '0')).join('');
        // ... (จบโค้ด hashPassword เดิม) ...
    }

    async function toggleLogin() {
        // ... (โค้ด toggleLogin เดิม) ...
        if (!isAdmin) {
                    openLoginModal();
        } else {
            logoutAdmin();
        }
        // ... (จบโค้ด toggleLogin เดิม) ...
    }

    function confirmAdmin() {
        // ... (โค้ด confirmAdmin เดิม) ...
        if (!isAdmin || !currentUser.username) {
            Swal.fire('Access Denied', 'เซสชันหมดอายุหรือคุณไม่มีสิทธิ์เข้าถึง กรุณาล็อกอินใหม่', 'warning');
            return false;
        }
        return true;
        // ... (จบโค้ด confirmAdmin เดิม) ...
    }

    function showSection(sectionId) {
        $('.content-section').addClass('hidden');
        $('.list-group-item').removeClass('active');
        $(`[onclick="showSection('${sectionId}')"]`).addClass('active');
        $(`#sec-${sectionId}`).removeClass('hidden');

        // ตรวจสอบสิทธิ์สำหรับ Logs และ Admin Manager
        if (sectionId === 'logs' || sectionId === 'admin-manager') {
            if (!isAdmin || currentUser.role !== 'DEVELOPER') {
                $(`#sec-${sectionId}`).addClass('hidden'); // ซ่อนส่วนที่ไม่ได้รับอนุญาต
                Swal.fire('Access Denied', 'สิทธิ์เข้าถึงถูกจำกัด: เฉพาะ DEVELOPER เท่านั้น', 'error');
                showSection('dashboard'); // Redirect
                return;
            } else if (sectionId === 'logs') {
                initLogsTable();
            } else if (sectionId === 'admin-manager') {
                loadAdminManager();
            }
        }

        $('#page-title').text(sectionId.charAt(0).toUpperCase() + sectionId.slice(1).replace('-', ' '));

        if (sectionId === 'structure') {
            renderStructureTree();
        }

        if ($(window).width() < 768) {
            $("#wrapper").removeClass("toggled");
        }
    }
    // ====================================================================
        // 11. CONVERTER TOOL LOGIC
        // ====================================================================

        let converterStorage = {
            struct: [],
            category: [],
            ques: [],
            current: "struct"
        };

        const converterHeaders = {
            struct: ["#", "Year", "SubjectID", "SubjectName", "AccordionGroup"],
            category: ["#", "CategoryID", "SubjectRef", "AccordionGroup", "CategoryName"],
            ques: ["#", "QuestionID", "Problem", "Image", "Choices", "Answer", "Explanation", "Category"]
        };

        function switchTab(sheet) {
            // ... (โค้ด switchTab เดิม) ...
            converterStorage.current = sheet;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById('tab-' + sheet).classList.add('active');
            renderPreview();
            // ... (จบโค้ด switchTab เดิม) ...
        }

            function processAll() {
                    let rawInput = document.getElementById('jsonInput').value.trim();
                    const year = document.getElementById('yearVal').value;
                    const subjectID = document.getElementById('subjID').value.trim().toUpperCase() || "SUBJ";
                    const subjectName = document.getElementById('subjName').value || "Untitled Subject";
                    const groupKeywords = document.getElementById('groupKeys').value.split(',').map(k => k.trim()).filter(k => k !==
                        "");
                    const arrayCategoryID = document.getElementById('arrayCategoryID').value.trim() || null;

                    if (!rawInput) {
                        Swal.fire('Error', 'กรุณาวางข้อมูลก่อน', 'error');
                        return;
                    }

                    let structMap = new Map();
                    let categoryRows = [];
                    let quesRows = [];

                    // ล้างข้อมูลเก่า
                    converterStorage.struct = [];
                    converterStorage.category = [];
                    converterStorage.ques = [];

                    // กำหนด Active Tab ที่เหมาะสม
                    let initialTab = 'category'; // Default for Category List
                    let inputType = 'structure_only'; // Default for Category List

                    try {
                        if (rawInput.startsWith('[') && rawInput.endsWith(']')) {
                            // ********************************************************************
                            // CASE 3: QUESTION ARRAY
                            // ********************************************************************
                            initialTab = 'ques';
                            inputType = 'full';
                            if (!arrayCategoryID) {
                                Swal.fire('Error', 'กรุณาระบุ Category ID สำหรับชุดคำถามนี้ในช่องสีแดง "ใส่ชื่อหัวข้อ"', 'error');
                                return;
                            }

                            // ... (Logic การประมวลผล Question Array - เหมือนเดิม) ...
                            let questionsArray;
                            try {
                                questionsArray = JSON.parse(rawInput);
                            } catch (e) {
                                questionsArray = new Function("return " + rawInput)();
                            }

                            const categoryKey = arrayCategoryID;
                            let group = "GENERAL";
                            for (let key of groupKeywords) {
                                if (categoryKey.toUpperCase().includes(key.toUpperCase())) {
                                    group = key;
                                    break;
                                }
                            }
                            const structKey = `${subjectID}-${group}`;
                            if (!structMap.has(structKey)) {
                                structMap.set(structKey, [year, subjectID, subjectName, group]);
                            }

                            let extractedName = categoryKey;
                            //const subjPrefix = `${subjectID}_`;
                            //if (categoryKey.toUpperCase().startsWith(subjPrefix.toUpperCase())) {
                            //    extractedName = categoryKey.substring(subjPrefix.length);
                            //}
                            //if (group !== 'GENERAL' && extractedName.toUpperCase().startsWith(`${group.toUpperCase()}`)) {
                              //  const parts = extractedName.split('_');
                                //if (parts.length > 1) {
                                  //  extractedName = extractedName.substring(parts[0].length + 1);
                               // }
                            //}
                            //const lastUnderscore = extractedName.lastIndexOf('_');
                            //if (lastUnderscore > -1) {
                              //  extractedName = extractedName.substring(lastUnderscore + 1);
                            //}

                            categoryRows.push([categoryKey, subjectID, group, extractedName]);

                            questionsArray.forEach((q, index) => {
                                const qId = `${categoryKey}_${index + 1}`;
                                quesRows.push([qId, q.problem || "", q.img || "", q.choices || "", q.answer || "", q.explain || "",
                                    JSON.stringify([categoryKey])
                                ]);
                            });


                        } else if (rawInput.includes('{') && rawInput.includes('}')) {
                            // ********************************************************************
                            // CASE 2: QUIZ DATA (JSON Object)
                            // ********************************************************************
                            initialTab = 'ques';
                            inputType = 'full';

                            // ... (Logic การประมวลผล Quiz JSON Object - เหมือนเดิม) ...
                            const firstBrace = rawInput.indexOf('{');
                            const lastBrace = rawInput.lastIndexOf('}');
                            const jsonString = rawInput.substring(firstBrace, lastBrace + 1);
                            let quizObj;
                            try {
                                quizObj = new Function("return " + jsonString)();
                            } catch (e) {
                                quizObj = JSON.parse(jsonString);
                            }

                            for (const [categoryKey, questions] of Object.entries(quizObj)) {
                                let group = "GENERAL";
                                for (let key of groupKeywords) {
                                    if (categoryKey.toUpperCase().includes(key.toUpperCase())) {
                                        group = key;
                                        break;
                                    }
                                }

                                const structKey = `${subjectID}-${group}`;
                                if (!structMap.has(structKey)) {
                                    structMap.set(structKey, [year, subjectID, subjectName, group]);
                                }

                                categoryRows.push([categoryKey, subjectID, group, categoryKey]);

                                if (Array.isArray(questions)) {
                                    questions.forEach((q, index) => {
                                        const qId = `${categoryKey}_${index + 1}`;
                                        quesRows.push([qId, q.problem || "", q.img || "", q.choices || "", q.answer || "", q.explain || "",
                                            JSON.stringify([categoryKey])
                                        ]);
                                    });
                                }
                            }
                        } else {
                            // ********************************************************************
                            // CASE 1: CATEGORY LIST (Text List)
                            // ********************************************************************
                            initialTab = 'category';
                            inputType = 'structure_only';

                            // ... (Logic การประมวลผล Category List - เหมือนเดิม) ...
                            const lines = rawInput.split('\n').map(l => l.trim()).filter(l => l.length > 0);
                            lines.forEach(categoryKey => {
                                let group = "GENERAL";
                                for (let key of groupKeywords) {
                                    if (categoryKey.toUpperCase().includes(key.toUpperCase())) {
                                        group = key;
                                        break;
                                    }
                                }
                                const structKey = `${subjectID}-${group}`;
                                if (!structMap.has(structKey)) structMap.set(structKey, [year, subjectID, subjectName, group]);

                                let extractedName = categoryKey;
                                const firstUnderscore = categoryKey.indexOf('_');
                                const secondUnderscore = categoryKey.indexOf('_', firstUnderscore + 1);

                                if (firstUnderscore > -1 && secondUnderscore > -1) {
                                    extractedName = categoryKey.substring(secondUnderscore +
                                        1).trim();
                                } else if (firstUnderscore > -1) {
                                    extractedName = categoryKey.substring(firstUnderscore + 1).trim();
                                }

                                categoryRows.push([categoryKey, subjectID, group, extractedName]);
                            });
                        }

                        // เก็บเข้า Storage
                        converterStorage.struct = Array.from(structMap.values());
                        converterStorage.category = categoryRows;
                        converterStorage.ques = quesRows;

                        Swal.fire('Success', 'ประมวลผลสำเร็จ! กรุณาตรวจสอบในตารางด้านล่าง', 'success');

                        // NEW: เปลี่ยนไป Tab ที่เหมาะสมและเรนเดอร์
                        switchTab(initialTab);

                    } catch (e) {
                        console.error(e);
                        Swal.fire('Error', 'Format ข้อมูลผิดพลาด: ' + e.message, 'error');
                    }
                }

        function renderPreview() {
            // ... (โค้ด renderPreview เดิม) ...
            const head = document.getElementById('tableHead');
            const body = document.getElementById('tableBody');
            const currentSheet = converterStorage.current;
            const data = converterStorage[currentSheet];

            head.innerHTML = converterHeaders[currentSheet].map(h => `<th>${h}</th>`).join("");

            body.innerHTML = data.map((row, i) => {
                const indexCell = `<td>${i + 1}</td>`;
                const contentCells = row.map(cell => {
                    return `<td class="editable-cell" contenteditable="true" style="white-space: pre-wrap;">${cell}</td>`;
                }).join("");
                return `<tr>${indexCell}${contentCells}</tr>`;
            }).join("");

            document.getElementById('previewText').innerText = `มีข้อมูลทั้งหมด ${data.length} แถว`;
            // ... (จบโค้ด renderPreview เดิม) ...
        }

        function copyCurrentSheet() {
            // ... (โค้ด copyCurrentSheet เดิม) ...
            const rows = document.querySelectorAll('#tableBody tr');
            let text = "";
            rows.forEach(tr => {
                let rowData = [];
                const cells = tr.querySelectorAll('td');
                for (let j = 1; j < cells.length; j++) {
                    rowData.push(cells[j].innerText);
                }
                text += rowData.join("\t") + "\n";
            });
            navigator.clipboard.writeText(text);
            Swal.fire('Copied', 'คัดลอกข้อมูล (TSV) เรียบร้อยแล้ว', 'success');
            // ... (จบโค้ด copyCurrentSheet เดิม) ...
        }

    async function importConvertedData() {
        if (!confirmAdmin()) return;

        const sheetsToProcess = [
            { name: 'Structure', key: 'struct' },
            { name: 'Category', key: 'category' },
            { name: 'Questions', key: 'ques' }
        ];

        let totalRowsImported = 0;
        let importLog = "";

        const isConfirmed = await Swal.fire({
            title: 'ยืนยันการนำเข้าข้อมูลทั้งหมด?',
            text: `คุณกำลังจะนำเข้าข้อมูล 3 ส่วน (Structure, Category, Questions) ที่อยู่ใน Converter Tool เข้าสู่ระบบ`,
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: 'ใช่, Import ทั้งหมด'
        });

        if (!isConfirmed.isConfirmed) return;

        $('#loading-overlay').show();

        try {
            for (const sheet of sheetsToProcess) {
                const dataToImport = converterStorage[sheet.key];

                if (dataToImport.length > 0) {
                    const BATCH_SIZE = 200;
                    const totalBatches = Math.ceil(dataToImport.length / BATCH_SIZE);

                    for (let i = 0; i < totalBatches; i++) {
                        const chunk = dataToImport.slice(i * BATCH_SIZE, (i + 1) * BATCH_SIZE);

                        await sendAdminAction('adminImport', {
                            sheetName: sheet.key,
                            data: chunk
                        });
                        totalRowsImported += chunk.length;
                    }
                    importLog += `นำเข้า ${sheet.name}: ${dataToImport.length} แถว\n`;
                }
            }

            Swal.fire('Completed', `นำเข้าข้อมูลสำเร็จทั้งหมด ${totalRowsImported} แถว\n\n${importLog}`, 'success');
            fetchData();
        } catch (err) {
            Swal.fire('Error', 'การ Import ขัดข้อง: ' + err.message, 'error');
        } finally {
            $('#loading-overlay').hide();
        }
    }

        </script>
</body>

</html>