// ====================================================================
// 10. ADMIN & GENERAL UTILITIES
// ====================================================================

// ** NEW CRITICAL FIX: Move transformUrl here to ensure it's defined before DataTables usage **
const transformUrl = (url) => {
if (!url) return "";
const match = url.match(/\/d\/(.*?)\//) || url.match(/id=([^&]+)/);
// ‡πÄ‡∏û‡∏¥‡πà‡∏° w1000-h1000 ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏Ç‡∏ô‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà‡πÅ‡∏•‡∏∞‡πÄ‡∏£‡πá‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô‡∏à‡∏≤‡∏Å Google Photos/Drive
return (match && match[1]) ? `https://lh3.googleusercontent.com/d/${match[1]}?authuser=1=w1000-h1000` : url;
};
// ** END CRITICAL FIX **


// 1. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î Modal ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå ‡πÅ‡∏•‡∏∞‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡∏°‡∏≤‡πÉ‡∏™‡πà
function openEditProfile() {
$('#ep-prefix').val(currentUser.prefix || '');
$('#ep-fullname').val(currentUser.fullName || '');
$('#ep-displayname').val(currentUser.displayName || '');
$('#ep-year').val(currentUser.year || '');
$('#ep-contact').val(currentUser.contact || '');
$('#edit-avatar-preview').attr('src', currentUser.avatar);
$('#editProfileModal').modal('show');
}

// 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå
async function updateUserProfile() {
if (!confirmAdmin()) return;
const updateData = {
prefix: $('#ep-prefix').val(),
fullName: $('#ep-fullname').val(),
displayName: $('#ep-displayname').val(),
year: $('#ep-year').val(),
contact: $('#ep-contact').val(),
avatarUrl: currentUser.avatar // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏´‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ (Simplify for now)
};

$('#loading-overlay').show();
try {
const response = await fetch(APPSCRIPT_URL, {
method: 'POST',
redirect: "follow",
headers: { "Content-Type": "text/plain" },
body: JSON.stringify({
action: 'updateAdminProfile',
targetUsername: currentUser.username,
username: currentUser.username, // for logging
adminPass: adminPass,
updateData: updateData
})
});
const res = await response.json();
if (res.result === 'success') {
Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ú‡∏•‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô', 'success');
$('#editProfileModal').modal('hide');
// ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏ô Frontend ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
Object.assign(currentUser, updateData);
updateAuthUI(true);
} else {
throw new Error(res.message || 'Server reported error');
}
} catch (e) {
Swal.fire('Error', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÑ‡∏î‡πâ: ' + e.message, 'error');
} finally {
$('#loading-overlay').hide();
}
}

// 3. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Admin ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Developer (‡∏¢‡∏±‡∏á‡∏Ñ‡∏á logic ‡πÄ‡∏î‡∏¥‡∏°)
async function loadAdminManager() {
if (currentUser.role !== 'DEVELOPER') return;
$('#admin-user-list').html('<tr>
    <td colspan="6" class="text-center py-4 text-muted"><i class="fas fa-spinner fa-spin"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</td>
</tr>');
try {
const response = await fetch(`${APPSCRIPT_URL}?action=getAdmins`); // ‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á action getAdmins ‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏ô GS
const admins = await response.json();

let html = '';
if (admins && admins.length > 0) {
admins.forEach(u => {
html += `
<tr>
    <td><img src="${u.AvatarURL || 'https://api.dicebear.com/7.x/avataaars/svg?seed=' + u.Username}" width="30"
            class="rounded-circle"></td>
    <td>${u.Username}</td>
    <td>${u.FullName || '-'}</td>
    <td><span class="badge ${u.Role === 'DEVELOPER' ? 'bg-danger' : 'bg-primary'}">${u.Role}</span></td>
    <td>${u.KKUMail || '-'}</td>
    <td>
        <button class="btn btn-sm btn-outline-danger" onclick="devDeleteUser('${u.Username}')"><i
                class="fas fa-trash"></i></button>
    </td>
</tr>`;
});
} else {
html = '<tr>
    <td colspan="6" class="text-center text-muted">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Admin</td>
</tr>';
}
$('#admin-user-list').html(html);
} catch (e) {
$('#admin-user-list').html('<tr>
    <td colspan="6" class="text-center text-danger">‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Admin ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß</td>
</tr>');
}
}

function openRegisterModal() {
// ‡πÉ‡∏ä‡πâ Bootstrap Modal
$('#loginModal').modal('hide');
$('#registerModal').modal('show');
// Clear form
$('#registerForm')[0].reset();
$('#reg-avatar-preview').addClass('hidden').attr('src', '');
$('#reg-avatar-icon').removeClass('hidden');
avatarBase64 = "";
}

// ** NOTE: The logic for validateRegistrationForm, submitRegistration,
// ** previewAvatar, submitRegister, submitResetPassword, performLogin,
// ** logoutAdmin remains the same as previously defined, just ensure
// ** they are correctly placed inside this section! **


// --- Login Logic (Updated) ---
async function performLogin() {
const username = $('#login-username').val();
const password = $('#login-password').val();

if (!username || !password) return;

$('#loading-overlay').css('display', 'flex');
try {
const response = await fetch(APPSCRIPT_URL, {
method: 'POST',
redirect: "follow",
headers: { "Content-Type": "text/plain" },
body: JSON.stringify({
action: 'checkAuth',
username: username,
password: password
})
});
const data = await response.json();

if (data.result === 'success') {
currentUser = data.user;
isAdmin = true;
adminPass = password; // Store for session actions

updateAuthUI(true);
$('#loginModal').modal('hide');
Swal.fire({
icon: 'success',
title: 'Welcome, ' + currentUser.displayName,
text: 'Role: ' + currentUser.role,
timer: 1500,
showConfirmButton: false
});
fetchData();
} else {
Swal.fire('Login Failed', data.message, 'error');
}
} catch (e) {
Swal.fire('Error', e.message, 'error');
} finally {
$('#loading-overlay').hide();
}
}

function logoutAdmin() {
isAdmin = false;
adminPass = '';
currentUser = { displayName: 'Guest', avatar: '', username: '', role: '' };
updateAuthUI(false);
showSection('dashboard');
}

// üõë FIX: The logic using isLoggedIn is now correctly placed inside this function üõë
function updateAuthUI(isLoggedIn) {
if (isLoggedIn) {
$('#auth-guest-view').addClass('hidden');
$('#auth-user-view').removeClass('hidden').addClass('d-flex');

$('#topbar-user').text(currentUser.displayName);
$('#topbar-avatar').attr('src', currentUser.avatar);

// Sidebar Handling
$('.admin-only').fadeIn();

// üõë NEW/FIXED LOGIC START üõë
// 1. Enable profile editing on topbar
$('#topbar-user, #topbar-avatar').off('click').on('click', openEditProfile); // off() to prevent multiple bindings
$('#topbar-user').css('cursor', 'pointer').attr('title', '‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå');

// 2. Developer Role Check (Show/Hide Developer-only menu items)
if (currentUser.role === 'DEVELOPER') {
$('.developer-only').show();
// Note: The Sidebar menu item is controlled by the CSS class `.developer-only`
} else {
$('.developer-only').hide();
}
// üõë NEW/FIXED LOGIC END üõë

// Hide sidebar login button
$('#btn-sidebar-login').hide();
$('#user-status-display').html(`Logged in as:<br><b>${currentUser.displayName}</b>`).css('color', '#fff');


} else {
$('#auth-guest-view').removeClass('hidden');
$('#auth-user-view').addClass('hidden').removeClass('d-flex');

$('.admin-only').hide();
$('#btn-sidebar-login').show();
$('#user-status-display').text('Guest User').css('color', 'rgba(255,255,255,0.6)');
}
}

// ... (rest of the code for sendAdminAction, formatDate, hashPassword, toggleLogin, confirmAdmin) ...